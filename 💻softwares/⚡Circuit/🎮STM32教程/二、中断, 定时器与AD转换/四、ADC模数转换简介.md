# ADC数模转换概念
### (1) 相关外设
首先介绍电位器:12 一端连接VCC , 一段连接GND即可, 没有方向， 相当于滑动变阻器
![[Excalidraw/四、ADC模数转换简介 2024-02-12 16.05.57]]

STM32有12位的ADC, 结果最大为4095, 可以读取

对于反射式红外传感器, 也可以由ADC获取对应的颜色变化等等。 
ADC可以将引脚上连续变化的模拟电压转换成内存中存储的数字变量, 来实现从模拟电路到数字的转换。(DAC也可以使用PWM进行考虑实现)

音频解码和信号发生器一般都需要使用DAC且不好使用PWM代替

对于STM32F103C8T6, 没有DAC的外设。

对于阻值不确定的电阻(例如测量传感器的阻值情况)， 可以**串联一个电阻**
![[attachments/Pasted image 20240212193642.png]]
### (2) ADC 型号简介 
STM32的ADC是12位的逐次逼近的ADC, 主要参数参考[[💻softwares/⚡Circuit/💻51单片机教程/5. 红外遥控,DS1302时钟, AD转换/ADC模数转换与信号处理|ADC模数转换与信号处理]] 
转换时间1us
分辨率 $2^{12}$
转换误差: 
输入电压0-3.3V, 转换0-4095

共有18个输入通道, 包括测量2个内部信号源和16个外部信号源 (内部参考电压是1.2V左右的基准电压), 则当供电不为 3.3V时, 使用此校准。 

有规则组和注入组(突发事件)两个转换单元 >  可以在一个组中进行一次性转换多个值

有模拟看门狗自动监测输入电压范围, 当电压超过阈值时进行申请中断来执行命令。 

其中ADC资源包括ADC1、ADC2，10个外部输入通道


### (3) ADC基本结构 
STM32单片机需要使用外设进行ADC转换，常常使用ADC0809芯片(仅有8个输入通道)(往往会内部集成ADC外设)
![[attachments/Pasted image 20240212164955.png|500]]
上图中 IN0- IN7是通道选择开关, ADDA是选择某个通道的控制，其中我们可以**仅使用一个AD转换器加上多路开关即可实现对上述多行的AD转换**。
选中某一路通道时, 只需要将通道号放在ADDA-ADDC三个引脚上， 然后从ALE输入一个锁存信号，即可实现对应通路的AD转换。
STM32有18路开关。

首先， 在ADC0809中是带有一个DAC的, 通过一个**外部输入的未知编码的输入模拟量电压**和**内部DAC输出的已知编码的电压**。经过**逐次比较使得DAC输出和编码输入基本相等**即可。(DAC由VREF+和VREF-供电),  转换完成之后, 从D0-D7输出数字量

其中START开启转换, EOC是End of  coonversion `->` 即转换完成的输出。 
# 二、STM32 的 ADC 内部原理 
### (1) STM32 的ADC结构
对于下图的STM32 , 使用MUX 输入多路的模拟信号(其中一次可以输入多条路),  **根据图中, Regular Channels可以一次性选择16通道(转换完毕一次性输出), 而Injected Channels可以一次选择4个通道**。

对于规则组转换， 如果配合Regular data register, 一次只能存一个AD转换结果(如果不想之前结果被覆盖, **则使用时最好配合DMA转运数据实现**)；但是Injected data register 可以一次寄存4个结果。 
![[Excalidraw/四、ADC模数转换简介 2024-02-12 17.09.14|800]]
ADC的触发包括软件触发和硬件触发， 其中硬件触发可以采用转换触发部分作为触发源。(分开有规则和注入组的触发源)

可以使用功能 TRGO 定时器主模式输出用于触发转换操作`->` 可以利用定时器来间隔申请中断来间隔实现ADC转换。 
如果使用定时器1ms申请一次中断， 则**频繁中断会直接影响程序的进行**

> [!caution] 频繁进行中断但是中断中仅完成简单工作的情况处理
> 往往可以使用TRGO进行输出， 并使用功能具有相应支持的硬件， 
> 方法例如将TIM3**定时为1ms并选择TRGO输出**; 
> 最后在ADC系统**中选择开始触发信号为TIM3的TRGO即可完成TIM3进行定时中断**。

另外也可以选择外部中断引脚触发转换。 
$VDDA, VSSA$ 和$V_{REF} +$与$V_{REF}-$ 其中VDDA和VSSA为ADC的供电引脚， 而上面的是参考电压(决定输出范围)。 
同时, VDDA, VSSA也是内部模拟部分的电源; 例如ADC, 锁相环和RC振荡器等等。 

另外**DMA请求部分对应触发DMA和进行数据转运**, 在**多路复用AD转换时往往使用**。 

**ADCCCLK**对应原理图中的CLOCK, **ADC预分频器来源于RCC部分**, 参考**时钟树右侧的ADC预分频器部分**, 可以选2,4,6,8分频, <b><mark style="background: transparent; color: blue">由于标准时钟是72MHz的, 而ADDCLK最大14Mhz, 因此只能选择6分频(12M)和8分频(9MHz)</mark></b> 
![[Excalidraw/二、STM32定时器中断的使用 2024-02-04 17.31.39|1000]]
另外， 在**定时器的Flags标志位**(即状态寄存器标志位)中,  **只需读取标志位即可获取转换是否结束**。<mark style="background: transparent; color: red">EOC 表示转换结束， JEOC为注入转换结束标志位, AWD为模拟看门狗事件标志位</mark>。 
interrupt enable bits 用于进行使能中断。  


因此我们整理过程: 
![[attachments/Pasted image 20240212184317.png|800]]
1. 首先使能相应的时钟， 
2. 配置TIM3使用TRGO输出信号控制ADC转换的启动和停止 
3. 配置标志位， 使能位, NVIC 和中断
4. 启动ADC 
5. 启动TIM3, 打开触发控制

### (2) ADC外部通道对应的GPIO口 
ADC以及对应的转换通道如下（没有ADC3）: 

| 通道 | ADC1 | ADC2 | ADC3 |
| ---- | ---- | ---- | ---- |
| 通道0 | PA0 | PA0 | PA0 |
| 通道1 | PA1 | PA1 | PA1 |
| 通道2 | PA2 | PA2 | PA2 |
| 通道3 | PA3 | PA3 | PA3 |
| 通道4 | PA4 | PA4 | PF6 |
| 通道5 | PA5 | PA5 | PF7 |
| 通道6 | PA6 | PA6 | PF8 |
| 通道7 | PA7 | PA7 | PF9 |
| 通道8 | PB0 | PB0 | PF10 |
| 通道9 | PB1 | PB1 |  |
| 通道10 | PC0 | PC0 | PC0 |
| 通道11 | PC1 | PC1 | PC1 |
| 通道12 | PC2 | PC2 | PC2 |
| 通道13 | PC3 | PC3 | PC3 |
| 通道14 | PC4 | PC4 |  |
| 通道15 | PC5 | PC5 |  |
| 通道16 | 温度传感器 |  |  |
| 通道17 | 内部参考电压 |  |  |

注意: 对STM32F103C8T6, 芯片只有10个外部输入通道, 即PA0-PA7,  PB0-PB1
![[attachments/Pasted image 20240212185223.png]]

两个ADC的端口是完全相同的。 而**使用两个ADC的原因是使用双ADC模式的ADC高级功能**
即ADC1和ADC2一起工作, 组成同步模式和交叉模式等等; **例如交叉模式下, ADC1和ADC2交叉对一个通道进行交叉采样, 可以进一步提高采样率**; 

ADC1和ADC2的引脚是完全相同的, 而ADC3中会有变化。

### (3) 规则组的4种AD转换模式 
4种转换模式包括**单次转换连续转换**； **非扫描和扫描模式**； 
都可以在ADC的初始化结构体中进行选择进行。 

非扫描模式下. **仅有序列1有效**, 但是**可以在这个序列下选择任意的转换通道**(10个)。 

对于连续转换非扫描模式，当一次转换之后， 会立刻开始下一轮的转换; 并进行持续。 **因此只需要触发一次， 就可以进行一直转换**。 不用开始和判断结束, 且变更通道时； 

对于**单次转换扫描模式**下: 
1.  **每触发一次转换就会停下, 下一次只有再次触发才能开始**。
2.  需要在初始化结构体中设置**转换的通道数目**(指定前x个位置) 
3.  为了防止数据被覆盖， 需要使用DMA即时挪走数据
4. **全部的通道转换完成之后， 才产生EOC信号**， 转换结束。

连续转换扫表一次转换完成之后立刻完成下一次转换。 


在扫描模式下， 还有间断模式。  在转换过程中每几个转换完成就暂停， 需要触发才能继续。 

### (4) 触发控制和数据对齐
![[attachments/Pasted image 20240212192310.png]]
数据右对齐(从右开始)和左对齐方式见下表: 
![[attachments/Pasted image 20240212192441.png]]
**一般使用右对齐方式进行读取**; 
而左对齐读的值比实际大16倍`->` 如果不需要太高分辨率然后舍弃后4位

•STM32 ADC的总转换时间为: 
  TCONV = **采样时间** + 12.5个ADC周期;
例如: 当ADCCLK=14MHz，采样时间为1.5个ADC周期时
  TCONV = 1.5 + 12.5 = 14个ADC周期 = 1μs
其中采样时间可以在程序中配置, 较大可以**避免毛刺信号干扰**。 

### (5) ADC自校准模式的使用 
对于ADC的自校准模式, 校准可大幅减小因内部电容器组的变化而造成的准精度误差。校准期间，在每个电容器上都会计算出一个误差修正码(数字值)，这个码用于消除在随后的转换中每个电容器上产生的误差。

• 比较好的方法是**在每次上电后执行一次校准**

另外, 启动校准前， ADC必须处于关电状态超过至少两个ADC时钟周期


