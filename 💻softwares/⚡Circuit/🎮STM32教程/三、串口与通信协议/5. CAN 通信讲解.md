# 一、CAN 基本介绍
参考 [CAN通信讲解](https://blog.csdn.net/XiaoXiaoPengBo/article/details/116206252)
### (1) CAN 通信基本内容  
CAN 协议是控制器局域网络(Controller Area Network) 的简称,  是一个由BOSCH公司开发的一种现场总线协议; 且在ISO 11519和 ISO 11898中成为国际标准; 也成为最广泛使用的现场总线; 
**具有高可靠性和良好的错误检测能力**，从而应用于高温,  强电磁辐射，大振动, 车载通信等等的工业环境; 
![[attachments/Pasted image 20240227110049.png|600]]
CAN是使用一组差分信号线进行传输的, 通过CAN_High, CAN_Low 构成的差分信号线; 并且使用异步传输协议; 同时要求在信号线上有120$\Omega$ 的差分电阻; 

ISO11898标准高速短距离闭环网络如下: 要求总线两端有120$\Omega$ 电阻; 
![[attachments/Pasted image 20240227110415.png|700]]

ISO11519-2标准的开环总线网络传输距离为1km, 要求总线上串联2.2k$\Omega$ 的电阻; 
![[attachments/Pasted image 20240227110932.png|600]]
在CAN总线上，可以**挂载多个通讯节点**, 此时节点之间的信号经过总线传输,  实现节点间的通讯;  同时，**网络中的节点个数理论上不受限制, 只需要总线上的负载足够即可; 同时, 可以通过中继器增强负载**; 
可以使用TJA1050作为CAN收发器, 从而使STM32自带的CAN控制器的TTL信号转换为差分信号; 常见的CAN转换芯片如下如所示:
![[attachments/Pasted image 20240227111531.png|600]]
### (2) 差分信号通信原理 
通过相位相反，幅值相等的两根信号线进行CAN传输, 并使用电压差值($V^+ - V^-$)表示电平;
![[attachments/Pasted image 20240227111753.png|550]]
其中外界的噪声干扰会同时作用于两条信号线, 而其对外辐射的电磁场也可以相互抵消; 
CAN通信可以将线相互耦合编织来抵消干扰特性

电平逻辑图如下: 其中$V^{+} - V^{-}$在-0.5- 0.05V之间为逻辑1, 而1.5-3.0V之间为逻辑0;
![[attachments/Pasted image 20240227112240.png|700]]
同样地， CAN总线是**类似弱上拉，强下拉结构， 即强输出显性电平(逻辑0)**; 
另外， 由于**同一时刻只能表示一个信号**, CAN是**异步半双工协议**; 

我们以高速ISO11898为例;  通常情况下, **逻辑1时, CAN_High 和CAN_LOW 均为2.5V; 而逻辑0时, CAN_High和CAN_Low分别为3.5V和1.5V**

# 二、CAN协议层原理
### (1) CAN 协议的位同步以及位时序
1. CAN使用节点之间**约定好波特率进行通信**， 同样地， 也会**使用位同步方法抗干扰**, 吸收误差, 从而保证总线通讯正常; 在CAN的通信网络中， 由于总线是共用的， 因此同一时刻只能有一个通讯节点发送信号， 而其余的节点接受信号; 
2.  **位时序分解**
由于CAN是连续的差分信号表示的电平,  对于CAN的位同步(即在波特率固定时进行相关采样); 在**每一个数据位中，每一个数据位的时序为SS段,  PTS段, PBS1段和PBS2段部分**; 其中**不同的段区分是占比的时长不同**(具体占比如下图, 一个完整的位由8-25个Tq构成); 
![[attachments/Pasted image 20240229213206.png|800]]
信号的采样点在PBS1段和PBS2段之间, 而使用不同的段长度来准确采样;
1. SS 段(Sync Segment): 若**通讯节点检测到总线上信号的跳变沿被包含在 SS 段的范围之内**，则表示**节点与总线的时序是同步**的，当**节点与总线同步时，采样点采集到的总线电平即可被确定为该位的电平**。SS 段的大小固定为 1Tq
2. PTS段(Propagate Segment) 用于**补偿网络的物理延时时间**。是**总线上输入比较器延时和输出驱动器延时总和的两倍**。PTS 段的大小可以为 1~8Tq。
3. PBS1段(Phase Segment) 主要用来**补偿边沿阶段的误差**(相位缓冲)，它的时间长度在重新同步的时候可以加长。PBS1 段的初始大小可以为 1~8Tq。
4. PBS2 是另一个相位缓冲段，也是用来**补偿边沿阶段误差的**，它的时间长度在重新同步时可以缩短。PBS2 段的初始大小可以为 2~8Tq。

### (2) CAN 通信的波特率
对于CAN 总线通信的波特率, 需要**约定一个Tq的长度， 以及一个数据位占据的Tq的个数**
例如: 1us/Tq,  19Tq/bit `->` 通信速率为 1e6/19 = 52631bPs

此时, 为了同步每个位 ， 根据对应段的应用方式差异， 我们可以将CAN的数据同步分为**硬同步和重新同步**, 其中硬同步**仅在帧起始信号时有效**; 而重新同步是可以保证**帧内信号位时序同步的措施**; 

1. **硬同步过程**: 首先, 在通讯的起始时， CAN总线上的**主机会发送一个通讯的起始信号**,  而挂载在CAN总线的节点在不发送数据时**检测总线信号**;  如果**起始信号的时序部分不在节点内部时序的SS范围则将自身位时序中的SS段进行平移并与总线保持一致**; 
2. **重新同步过程**:  对于帧内的重新同步， 也是使用SS段来检测同步特性的，**利用普通数据的高位到低位的电平的跳变沿**来进行同步; 
	- 第一种相位超前的情况:  节点从总线的边沿跳变中，检测到它内部的时序比总线的时序相对超前 2Tq，这时控制器在下一个位时序中的 PBS1 段增加 2Tq 的时间长度，使得节点与总线时序重新同步。
	- 第二种相位滞后的情况 ，节点从总线的边沿跳变中，检测到它的时序比总线的时序相对滞后 2Tq，这时控制器在前一个位时序中的 PBS2 段减少 2Tq 的时间长度，获得同步。
实际上就是**在上升沿和下降沿进行调整上升时和下降时的SS位置**,  在重新同过程中, 每一次PBS1增加或者PBS2减小的时间段为 SJW, 一般而言， CAN总线会限制SJW的最大值; 当控制器设置的 SJW 极限值较大时，可以吸收的误差加大，但通讯的速度会下降

### (3) CAN 的报文种类及结构
CAN 协议**通过对数据 ，操作命令以及同步信号进行打包来实现数据的传输与方向的辨别**; 我们**将打包之后的数据称为报文**; 

#### 1. 报文的种类
我们在传输数据过程中， 需要加上**传输的起始标签， 片选 (识别) 标签和控制标签**,  而**数据的尾端加上CRC校验标签, 应答标签和传输结束标签**; 一整个报文的流构成了一个数据帧。 

CAN 一共规定了 5 种类型的帧，它们的类型及用途说明如表
![[attachments/Pasted image 20240229225105.png|700]]

CAN 通信中， **数据帧是最主要的报文，以逻辑0开始， 并以7个连续的逻辑1结束**; 
![[attachments/Pasted image 20240229225709.png]]
```terminal
帧起始(0) -> 仲裁段 -> 控制段 -> 数据段 -> CRC段 -> ACK段 ->帧结束段(1111111)
```
主要段的内容如下: 
1. 起始段(SOF): 其他节点进行**硬同步**; 
2. 仲裁段: 内容为**本数据帧的 ID 信息**,  其中, 标准的ID为11位,  扩展格式为29位; 其中,  **ID规定了数据帧发送的优先级， 也决定了接受这个数据帧的节点**; 需要注意, CAN 协议**不对挂载的节点分配优先级和地址**； 而**对于总线的占有权**是<b><mark style="background: transparent; color: blue">由信息的重要性决定的</mark></b>; 对于<b><mark style="background: transparent; color: blue">优先级高的信息， 则可以通过打包优先级高的ID来争取对总线的占有权</mark></b> ; 而**报文的优先级是通过ID的仲裁来决定的**; 

我们<b><mark style="background: transparent; color: blue">利用总线上的强下拉弱上拉特性</mark></b>，对于不同的优先级ID, 当<mark style="background: transparent; color: red">一个主机发送ID的先出现显性电平(强下拉)时, 如果另外一个主机发送的优先级序列不一致且下拉在这个ID之后， 则这个主机将占有总线的控制权</mark>; 而另一个认为是ID优先级低，自动失去控制权;
![[attachments/Pasted image 20240229232546.png|600]]
仲裁段首先是报文ID, 然后是RTR, IDE, SRR位; 
(1) RTR 位 (Remote Transmission Request Bit)，译作远程传输请求位，它是用于**区分数据帧和遥控帧**的，当它为**显性电平时表示数据帧，隐性电平时表示遥控帧**。
(2) IDE 位 (Identifier ExtensionBit)，译作标识符扩展位，它是用于**区分标准格式与扩展格式**，当它为显性电平时表示标准格式，**隐性电平时表示扩展格式**。
(3) SRR 位 (Substitute Remote Request Bit)，只存在于扩展格式，它用于替代标准格式中的 RTR位。由于扩展帧中的 SRR 位为隐性位，RTR 在数据帧为显性位，所以在两个 ID 相同的标准格式报文与扩展格式报文中，标准格式的优先级较高。
3. 控制段
在控制段中的 r1 和 r0 为保留位，默认设置为显性位。它最主要的是 DLC 段 (Data Length Code)，译为数据长度码，它由**4个数据位组成**，用于表示本报文中的数据段含有多少个字节， DLC 段表示的数字为 0~8
4. 数据段
数据帧的核心内容，它是节点要发送的原始信息，由 0~8 个字节组成，<b><mark style="background: transparent; color: red">MSB 先行</mark></b>; 这与I2C和SPI保持一致;
5. CRC 段
包含了15位的CRC校验码, 当接收节点计算出的CRC校验码和收到CRC不同时，会利用错误帧请求重新发送; (往往使用CAN控制器硬件完成); 在 CRC 校验码之后，有一个 CRC 界定符，它为隐性位，主要作用是把 CRC 校验码与后面的 ACK段间隔起来。
6. ACK 段
包括ACK槽位和ACK界定符位; **节点最先发的是隐性位，而接收节点则在这一位中发送显性位以示应答**。在 ACK 槽和帧结束之间由 ACK 界定符间隔开。
7. EOF段
End of Frame 表示帧结束,  由7个隐形位构成;

![[attachments/Pasted image 20240229233850.png|700]]
![[attachments/Pasted image 20240229234034.png|700]]

# 三、STM32 中的CAN Controller 
Stm32中配备了bxCAN (Basic Extended CAN) 外设, 并且支持CAN通信协议 2.0A和 2.0B 版本

stm32f103有14个可扩展的滤波器组， 而互联型设备有28个滤波器组(用于接收信息); 同时具有先入先出寄存器，可以实现连续接收和不丢失任何信息; 具有三个发件箱(transmit mail box), 并使用transmission Scheduler (仲裁机制) 来判定先传输哪一个数据; FIFO均由硬件进行控制; 

另外，硬件会自动进行筛选和验收过滤器检查; 而CAN1和CAN2是共用过滤器的(用于过滤地址);

具有 HLP (High Layer Protocol) , 

![[attachments/Pasted image 20240306194935.png|900]]


### (2) 相关寄存器控制
作为CAN 主控的寄存器是CAN_MCR(p674, Master control reg) 
![[attachments/Pasted image 20240306195226.png]]

1. CAN_MCR 中有 DBF(Debug freeze) 调试冻结功能,  使用它可设置 CAN 处于工作状态或禁止收发的状态，禁止收发时仍可访问接收 FIFO 中的数据。这两种状态是当 STM32 芯片处于程序调试模式时才使用的，平时使用并不影响。
2. TTCM(Time triggered communication mode) 时间触发模式，它用于配置 CAN 的时间触发通信模式，在此模式下，<mark style="background: transparent; color: red">CAN 使用它内部定时器产生时间戳</mark>，并把它保存在CAN_RDTxR、CAN_TDTxR 寄存器中。内部定时器在每个 CAN 位时间累加，在接收和发送的帧起始位被采样，并生成时间戳。利用它可以实现 ISO 11898-4 CAN 标准的分时同步通信功能。
3. ABOM 自动离线管理 : ABOM (Automatic bus-off management) 自动离线管理，它用于设置是否使用自动离线管理功能。当节点检测到它发送错误或接收错误超过一定值时，会自动进入离线状态，在离线状态中， CAN 不能接收或发送报文。处于离线状态的时候，可以软件控制恢复或者直接使用这个自动离线管理功能，它会在适当的时候自动恢复。
4. AWUM 自动唤醒
AWUM (Automatic bus-off management)，自动唤醒功能，CAN 外设可以使用软件进入低功耗的睡眠模式，如果使能了这个自动唤醒功能，当 CAN 检测到总线活动的时候，会自动唤醒。
5. NART 自动重传
NART(No automatic retransmission) 报文自动重传功能，设置这个功能后，当报文发送失败时会自动重传至成功为止。若不使用这个功能，无论发送结果如何，消息只发送一次。
6. RFLM 锁定模式
RFLM(Receive FIFO locked mode)FIFO 锁定模式，该功能用于锁定接收 FIFO 。锁定后，当接收 FIFO 溢出时，会丢弃下一个接收的报文。若不锁定，则下一个接收到的报文会覆盖原报文。
7. TXFP 报文发送优先级的判定方法
TXFP(Transmit FIFO priority) 报文发送优先级的判定方法，当 CAN 外设的发送邮箱中有多个待发送报文时，本功能可以控制它是根据报文的 ID 优先级还是报文存进邮箱的顺序来发送。


> [!NOTE] 说明
> 每一次CAN 传输(发送或者接收)完之后， 都会自动进入睡眠模式; 
> 而发送时， 使用软件清除标志位， 接收时， 硬件配置AWUM为1且检测到 Rx 的 SOF 位为1时， 则自动清除; 


波特率是使用位时序寄存器(CAN_BTR)进行编写的; 此寄存器还可以配置测试模式; 
另外可以通过 SILM 位和 LBKM 位 来配置<b><mark style="background: transparent; color: blue">静默模式和环回模式</mark></b>, 具体如下: 
![[attachments/Pasted image 20240306201814.png|700]]

### (3) STM32 CAN 外设的位时序与波特率
对于StM32, 其位时序如图，具体可参考[[#(1) CAN 协议的位同步以及位时序]] 
可以理解为,  BS1是CAN 通信中的PTS段和PBS1段的结合; 
![[attachments/Pasted image 20240306202057.png|800]]


配置波特率方法: 通过配置位时序寄存器 CAN_BTR 的 TS1[3:0] 及 TS2[2:0] 寄存器位设定 BS1 及 BS2 段的长度后，我们就可以确定每个 CAN 数据位的时间：
BS1 段时间：TS1=Tq x (TS1[3:0] + 1)，

BS2 段时间：TS2= Tq x (TS2[2:0] + 1)，

一个数据位的时间：T1bit =1Tq+TS1+TS2=1+ (TS1[3:0] + 1)+ (TS2[2:0] + 1)= N Tq
其中单个时间片的长度 Tq 与 CAN 外设的所挂载的时钟总线及分频器配置有关，CAN1 和 CAN2外设都是挂载在 APB1 总线上的，而位时序寄存器 CAN_BTR 中的 BRP[9:0] 寄存器位可以设置
$$CAN波特率=Fpclk1/((CAN_BS1+CAN_BS2+1)*CAN_Prescaler)$$
其中clk为36MHz (挂载在APB1总线上); 


具体发送邮箱和接收FIFO 的过程均可以参考 https://blog.csdn.net/XiaoXiaoPengBo/article/details/116206252
