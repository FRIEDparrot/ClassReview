## 1. F4 ç³»åˆ— DMA åŸºæœ¬ä»‹ç»
å‚è€ƒ[[ğŸ’»softwares/âš¡Circuit/ğŸ®STM32æ•™ç¨‹/äºŒã€ä¸­æ–­, å®šæ—¶å™¨ä¸ADè½¬æ¢/å››ã€ADCä¸DMAå­˜å‚¨å™¨è½¬è¿|å››ã€ADCä¸DMAå­˜å‚¨å™¨è½¬è¿]], DMA å¯ä»¥ç›´æ¥é€šè¿‡AHBæ€»çº¿çŸ©é˜µ, ç»è¿‡æ¡¥è®¿é—® APB1, APB2éƒ¨åˆ†;  F4ç³»åˆ—æœ‰ 16 ä¸ª DMA Stream (DMA1 0-7, DMA2 0 - 7å„æœ‰8ä¸ª), å¹¶ä¸”æ”¯æŒ FIFO éƒ¨åˆ†é…ç½®ã€‚

å¯¹äº F4 ç³»ç»Ÿ, æ ¹æ®å¦‚ä¸‹çš„ç³»ç»Ÿæ¶æ„å›¾,(**å…¶ä¸­DMA_P1, P2æ˜¯å¤–è®¾æ€»çº¿, MEM1, MEM2 æ˜¯å­˜å‚¨å™¨æ€»çº¿**)DMA1 å’Œ DMA2 å¯ä»¥å¯¹å¦‚ä¸‹çš„éƒ¨åˆ†è¿›è¡Œè®¿é—®(å¯¹äºH7ç­‰ç³»ç»Ÿ, åˆ™æœ‰ MDMA, DMA1, DMA2, DDMA; å…¶ä¸­MDMA,  DMA1, DMA2 å¯ä»¥è·¨åŸŸè®¿é—®, å¹¶é€šè¿‡ DMA MUXç®¡ç†): 
1. å¯¹äº P1, P2 æ€»çº¿, å¯ä»¥ç›´æ¥è®¿é—® APB1, APB2 æ€»çº¿(å…¶ä¸­)
2. é¦–å…ˆæ˜¯ DCODE æ€»çº¿, è®¿é—®Flash Memory;  M1, M2ï¼ŒP2 å‡å¯è¿›è¡Œã€‚**SRAM ä»¥åŠFSMC** å‡å¯ä»¥ä½¿ç”¨ DMA; 

å…¶ä¸­ DMA1_P1 ä¸“ç”¨äºè®¿é—® APB1æ€»çº¿; è€ŒDMA_P2 åˆ™æ—¢å¯ä»¥ç›´æ¥è®¿é—® APB2 æ€»çº¿, ä¹Ÿå¯ä»¥ç»è¿‡ AHB æ€»çº¿è®¿é—® APB1 æˆ–è€… APB2; DMAå¤–è®¾å¯ä»¥è®¿é—® AHB, APBå¤–è®¾ã€‚

å…¶ä¸­,**å­˜å‚¨å™¨æ€»çº¿ç”¨äºæ‰§è¡Œå­˜å‚¨å™¨(Flashç­‰)æ•°æ®çš„ä¼ å…¥å’Œä¼ å‡º; è€Œå¤–è®¾æ€»çº¿ç”¨äºæ‰§è¡Œå­˜å‚¨å™¨é—´(å¤–è®¾å­˜å‚¨å™¨)çš„æ•°æ®ä¼ è¾“**ã€‚ 
![[attachments/Pasted image 20240712151751.png]]

> [!caution] è¯´æ˜
> DMA1 è®¿é—®çš„å¯¹è±¡æ¯”è¾ƒå°‘; è€Œ DMA2 çš„è¾ƒå¤š; å› æ­¤æ”¯æŒåŠŸèƒ½å¹¶ä¸ç›¸åŒã€‚**DMA2 ä¹Ÿæ”¯æŒå†…å­˜åˆ°å†…å­˜çš„è½¬è¿è¿‡ç¨‹**ã€‚(**å› æ­¤ä»å†…å­˜åˆ°å†…å­˜è½¬è¿åªèƒ½ä½¿ç”¨DMA2**)

![[attachments/Pasted image 20240715160642.png|900]]
![[attachments/Pasted image 20240715160921.png|900]]
**ä¸€èˆ¬é¦–å…ˆ CPU å‘ DMA å‘é€è¯·æ±‚, ç„¶å DMA ç»™å¤–è®¾ä¸€ä¸ª ack ,  å¤–è®¾æ”¶åˆ°åé‡Šæ”¾è¯·æ±‚, å¹¶å¯åŠ¨DMA ä¼ è¾“**ã€‚
DMA è¯·æ±‚åœ¨åŒæ—¶åªæœ‰ä¸€ä¸ªè¯·æ±‚æ˜¯æœ‰æ•ˆçš„ã€‚å¹¶å¯ä»¥é€šè¿‡åˆå§‹åŒ–é…ç½®æ—¶çš„ DMA ä¼˜å…ˆçº§è¿›è¡Œè®¾ç½®ã€‚

DMA å¯ä»¥ä½¿ç”¨å¦‚ä¸‹**ç¡¬ä»¶è¯·æ±‚è¿›è¡Œè§¦å‘, ä¹Ÿå¯ä»¥ä½¿ç”¨è½¯ä»¶è¿›è¡Œè§¦å‘**ã€‚
![[attachments/Pasted image 20240715144847.png|800]]
![[attachments/Pasted image 20240715144923.png|800]]
DMA2 çš„è§¦å‘é…ç½®éƒ¨åˆ†å¦‚ä¸‹:
![[attachments/Pasted image 20240715145004.png|800]]
å¯¹äºä¸Šè¿°æ–¹æ³•æ‰€ä½¿ç”¨çš„ DMA, å¦‚æœæ˜¯å¸Œæœ›å’ŒLVGLåº“è¿›è¡Œèåˆä½¿ç”¨, åˆ™è€ƒè™‘é‡‡ç”¨è½¯ä»¶è§¦å‘, å› æ­¤è§¦å‘æºæ˜¯ä»»æ„çš„ã€‚ å¦å¤–, **ç›¸åŒçš„å¤–è®¾è¯·æ±‚è§¦å‘æºå¯ä»¥ä½¿ç”¨ä¸åŒçš„æ•°æ®æµé€šé“**ã€‚

å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å¯„å­˜å™¨æ˜¯**DMA_SxNDTR, å¯ä»¥ç›´æ¥å†™å…¥è¦ä¼ è¾“çš„æ•°æ®ä¸ªæ•°(æ˜¯é€’å‡çš„è®¡æ•°å™¨)**, ç„¶åè°ƒç”¨ ENABLE å³å¯è¿›è¡Œä¼ è¾“ã€‚(æ³¨æ„æ˜¯ æ•°æ®é¡¹, ä¸æ˜¯å­—èŠ‚æ•°, å¯ä»¥æ˜¯åŠå­—, å­—)

## 2. DMA æ¡†å›¾ä¸åŒç¼“å†²æ¨¡å¼æ”¯æŒ
ç›¸å¯¹äºF1 çš„ DMA ,F4 çš„ DMA1 å’Œ DMA2 å‡å¯ä»¥ä½¿ç”¨**åŒç¼“å†²æ¨¡å¼; å¹¶æ”¯æŒçªå‘ä¼ è¾“(Burst)æ¨¡å¼**ã€‚

F4 ç³»åˆ— DMA çš„åŸºæœ¬æ¡†æ¶å›¾å¦‚ä¸‹å›¾:
![[attachments/Pasted image 20240715162237.png]]
é™¤äº†ä¸¤ä¸ª Stream0 - Stream7 ä¹‹å¤–, 
1. å…·æœ‰ AHB Slave Programming interface, å¯ä»¥é€šè¿‡è¯¥éƒ¨åˆ†è¿›è¡Œé…ç½®DMAå¯„å­˜å™¨å’Œè¿›è¡Œæ§åˆ¶ã€‚
2. å­˜å‚¨å™¨ç«¯å£å’Œå¤–è®¾ç«¯å£ã€‚ åˆ†åˆ«ç”¨äº 
3. åœ¨æ‰€æœ‰ä¸­æ¢éƒ¨åˆ†,æ”¯æŒ**ä¸€ä¸ª FIFO å…ˆå…¥å…ˆå‡º4çº§32ä½å­˜å‚¨å™¨ç¼“å†²åŒºï¼Œå…±æœ‰7ä¸ªFIFOè®¾å®š**, å³æºæ•°æ®ä¼ è¾“åˆ°ç›®æ ‡åœ°å€å‰çš„å­˜å‚¨åŒºã€‚å¯ä»¥å¾ˆå¥½åœ°è§£å†³ä¼ è¾“é•¿åº¦ä¸ä¸€è‡´çš„é—®é¢˜ã€‚(<mark style="background: transparent; color: red">FIFO æ¨¡å¼: è½¯ä»¶è®¾ç½®é˜ˆå€¼å¹¶è¿›è¡Œä¼ è¾“, è¾¾åˆ°é˜ˆå€¼å³è‡ªåŠ¨ä¼ è¾“;  ä¸€èˆ¬æ¨¡å¼: ç›´æ¥å¯åŠ¨å­˜å‚¨å™¨ä¼ è¾“, ä½†éœ€è¦è½¯ä»¶å¤„ç†ã€‚</mark>)
4. DMA ä¼˜å…ˆçº§ä»²è£å™¨(arbiter): é¦–å…ˆæ˜¯è½¯ä»¶ä¼˜å…ˆçº§é…ç½®; ç„¶åæ˜¯ç¡¬ä»¶ä¼˜å…ˆçº§(DMAS0 > S1 > .... > S7);
5. æ¯ä¸€ä¸ªæ•°æ®æµStreaméƒ½ä¸ **DMA è¯·æ±‚å…³è”**, å…¶ä¸­è¯·æ±‚å¯ä»¥æ¥è‡ªè½¯ç¡¬ä»¶,å¯ä»¥ä»8é€šé“ä¸­é€‰å‡º(é€šè¿‡DMA_SxCR æ§åˆ¶ä½¿ç”¨é€šé“)
å¸¸ç”¨å¯„å­˜å™¨å¦‚ä¸‹:
![[attachments/Pasted image 20240715170228.png]]

éœ€è¦è¯´æ˜çš„æ˜¯, å½“ä¸ä½¿èƒ½ FIFO æ—¶, åˆ™FIFOMode, FIFOThreshould, MemBurst(çªå‘ä¼ è¾“)å’Œå¤–è®¾çªå‘ä¼ è¾“éƒ½æ˜¯æ— æ•ˆçš„ã€‚ä¸€èˆ¬åªéœ€ç»™é»˜è®¤å€¼å³å¯ã€‚
![[attachments/Pasted image 20240715161416.png]]

åœ¨ HAL åº“ä¸­, æˆ‘ä»¬ä½¿ç”¨çš„å°† SPI ç­‰å…³è”åˆ° DMA çš„å‡½æ•°å¦‚ä¸‹:
> [!caution] æ³¨æ„ 
> ä¸‰ä¸ªå‚æ•°ï¼Œ ç¬¬ä¸€ä¸ªå–åœ°å€, ç¬¬ä¸‰ä¸ªä¸ç”¨å–åœ°å€

```c
/* Associate the initialized DMA handle to the the SPI handle */
__HAL_LINKDMA(&W25Qxx_spi_handler, hdmatx, W25Qxx_dma_handler); // å‰åä¸¤ä¸ªæ˜¯ä¼ å…¥çš„å¥æŸ„, ä¸­é—´æ˜¯æŒ‡å®šçš„spi_handler çš„ç»“æ„ä½“ä¸­çš„å¯¹è±¡ï¼Œ è¯¦è§å®šä¹‰éƒ¨åˆ†ã€‚

// å¦å¤–å¸¸ç”¨å‡½æ•°å¦‚ä¸‹
HAL_SPI_TransmitReceive_DMA();

// å¯¹äº SPI ä¸²å£ç­‰ä¼ è¾“, ä»ç„¶æœ‰ä¸“é—¨çš„  DMA æ”¯æŒå‡½æ•°
HAL_StatusTypeDef HAL_SPI_Transmit_DMA(SPI_HandleTypeDef *hspi, uint8_t *pData, uint16_t Size); // å®é™…ä¸Šè°ƒç”¨äº† HAL_DMA_Start_IT() 
HAL_SPI_DMAPause();
HAL_SPI_DMAStop();
HAL_SPI_DMAResume();

// å¯¹äº DMA ä¼ è¾“å®Œæˆæ ‡å¿—çš„åˆ¤æ–­, å¯ä»¥ä½¿ç”¨å…¥ä¸‹å‡½æ•°
__HAL_DMA_GET_FLAG(&dma_handler, DMA_FLAG_TC1); // è·å–é€šé“1çš„ä¼ è¾“å¥æŸ„, æŸ¥è¯¢ä¼ è¾“æƒ…å†µã€‚
__HAL_DMA_CLEAR_FLAG(&dma_handler, DMA_FLAG_TC1);

// ä½¿èƒ½è®¾ç½®
__HAL_DMA_ENABLE();   // è¿™ä¸ªå®é™…ä¸Šæ˜¯åœ¨ HAL_DMA_Start å‡½æ•°ä¸­è¢«è°ƒç”¨çš„, å› æ­¤ä¸€èˆ¬åªè¦è°ƒç”¨STARTå³å¯ã€‚
__HAL_DMA_DISABLE();

HAL_DMA_Start();

ä¸€èˆ¬, Start å‡½æ•°å¯¹åº” Abort å‡½æ•°(ç±»ä¼¼ Stop); 
HAL_DMA_Start(&dma_handler);
HAL_DMA_Start_IT();  //  è½¯ä»¶å¼€å§‹DMAä¼ è¾“ï¼Œ åŒæ—¶ä½¿èƒ½ä¸­æ–­(è‡ªåŠ¨è°ƒç”¨ä¸­æ–­çš„ENABLE)
```

å¦å¤–è¿˜æœ‰éå¸¸é‡è¦çš„ä¸¤ä¸ªå‡½æ•°, 
```c
__HAL_DMA_GET_COUNTER(&dma_handler);
__HAL_DMA_SET_COUNTER(&dma_handler, cnt);
```
å®é™…ä¸Šä¹Ÿæ˜¯æ“ä½œå¯„å­˜å™¨çš„ NDTR ä½éƒ¨åˆ†,  


å¦å¤–éœ€è¦æ³¨æ„: Stream å’Œ Channel çš„åŒºåˆ« æ¯ä¸ªDMAæœ‰8ä¸ªStreamæ•°æ®æµ;è€Œæ•°æ®æµéƒ½å¯ä»¥é€šè¿‡å„ä¸ª Channel çš„è®¾å®šæ¥è¿›è¡Œè·å–:
```c
#define DMA1                ((DMA_TypeDef *) DMA1_BASE)
#define DMA1_Stream0        ((DMA_Stream_TypeDef *) DMA1_Stream0_BASE)
#define DMA1_Stream1        ((DMA_Stream_TypeDef *) DMA1_Stream1_BASE)
#define DMA1_Stream2        ((DMA_Stream_TypeDef *) DMA1_Stream2_BASE)
#define DMA1_Stream3        ((DMA_Stream_TypeDef *) DMA1_Stream3_BASE)
#define DMA1_Stream4        ((DMA_Stream_TypeDef *) DMA1_Stream4_BASE)
#define DMA1_Stream5        ((DMA_Stream_TypeDef *) DMA1_Stream5_BASE)
#define DMA1_Stream6        ((DMA_Stream_TypeDef *) DMA1_Stream6_BASE)
#define DMA1_Stream7        ((DMA_Stream_TypeDef *) DMA1_Stream7_BASE)
#define DMA2                ((DMA_TypeDef *) DMA2_BASE)
#define DMA2_Stream0        ((DMA_Stream_TypeDef *) DMA2_Stream0_BASE)
#define DMA2_Stream1        ((DMA_Stream_TypeDef *) DMA2_Stream1_BASE)
#define DMA2_Stream2        ((DMA_Stream_TypeDef *) DMA2_Stream2_BASE)
#define DMA2_Stream3        ((DMA_Stream_TypeDef *) DMA2_Stream3_BASE)
#define DMA2_Stream4        ((DMA_Stream_TypeDef *) DMA2_Stream4_BASE)
#define DMA2_Stream5        ((DMA_Stream_TypeDef *) DMA2_Stream5_BASE)
#define DMA2_Stream6        ((DMA_Stream_TypeDef *) DMA2_Stream6_BASE)
#define DMA2_Stream7        ((DMA_Stream_TypeDef *) DMA2_Stream7_BASE)
```
é¦–å…ˆç”±äºå…¶ç›´æ¥å°±æ˜¯ DMA_Stream_TypeDef * ç±»å‹, å¯ä»¥ç›´æ¥ä½œä¸ºæŒ‡é’ˆè¿›è¡Œä¼ å…¥ã€‚

å› æ­¤æˆ‘ä»¬å¯ä»¥ä» DMA1_Stream1 æ¥è·å–
![[attachments/Pasted image 20240715192213.png]]

#### é‡ç‚¹: é€šé“è®¾ç½®å’Œæµæ§è®¾ç½®
F4 çš„é€šé“å’Œæµæ§è®¾ç½®å’Œ F1 å¹¶ä¸ç›¸åŒã€‚è€Œä¸€èˆ¬ DMA éƒ½æ˜¯å¤–è®¾è¿›è¡Œç¡¬ä»¶è§¦å‘çš„ã€‚
> [!danger] å¤–è®¾è¯·æ±‚é€šé“å’Œæµæ§è®¾ç½®
> ç‰¹åˆ«æ³¨æ„:**ä¸åŒçš„ Stream,å’Œä¸åŒçš„ Channel, å…¶å¯¹åº”çš„è¯·æ±‚æ˜¯ä¸åŒçš„; é€šé“é€‰æ‹©(Stream0-Stream7ç”¨äºå…·ä½“é€‰æ‹© DMA è¯·æ±‚çš„é€šé“)**, ä¾‹å¦‚ä¸²å£USART1è¯·æ±‚é€šé“, å¿…é¡»æ˜¯ DMA2_Stream7, ä¸”å¯¹åº”çš„Channel å¿…é¡»æ˜¯ Channel4; **ä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨ SPI1 ä½œä¸ºé€šä¿¡ SPI æ—¶, åˆ™è¯·æ±‚æ˜¯ç¡¬ä»¶è§¦å‘çš„, è€Œä¸æ˜¯è½¯ä»¶è§¦å‘çš„**, å› 

è¿™ä¸ªçš„æ•°æ®æµè§¦å‘æ˜¯å›ºå®šçš„, å½“ç”¨åˆ°SPI1è§¦å‘è¯·æ±‚æ—¶, åˆ™éœ€è¦ä½¿ç”¨ DMA2 Stream3 å’Œ DMA2 Stream0; åŒæ—¶,  Channel é€šé“å¿…é¡»è®¾ç½®ä¸º Channel3;
![[attachments/Pasted image 20240715144847.png|800]]
![[attachments/Pasted image 20240715144923.png|800]]
![[attachments/Pasted image 20240715145004.png|800]]

å¦å¤–, æ ¹æ®ä¸Šè¿°çš„ DMA å’Œ DMA_Stream çš„åœ°å€è®¾å®šå…³ç³», æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸‹é¢å‡½æ•°æ ¹æ®ä¼ è¾“å‚æ•°å¼€å¯DMA1æˆ–è€…DMA2 çš„æ—¶é’Ÿ:
```c
if ((uint32_t)dma_stream_handle > (uint32_t)DMA2) Â  Â  Â  /* å¾—åˆ°å½“å‰streamæ˜¯å±äºDMA2è¿˜æ˜¯DMA1 */{
	__HAL_RCC_DMA2_CLK_ENABLE(); Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â /* DMA2æ—¶é’Ÿä½¿èƒ½ */
}
else
{
	__HAL_RCC_DMA1_CLK_ENABLE(); Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â /* DMA1æ—¶é’Ÿä½¿èƒ½ */
}
```

> [!caution] ä¼ è¾“åœ°å€çš„ç¡®å®š
> **åœ¨ F1 ç³»åˆ—è®¾ç½®ä¸­, å¿…é¡»åœ¨DMAåˆå§‹åŒ–ä¸­æŒ‡å®šå¤–è®¾å’Œå­˜å‚¨å™¨çš„åœ°å€**; è€Œ F4ç³»åˆ—**åŸºåœ°å€ä¸åœ¨Initä¸­æŒ‡å®š, è€Œæ˜¯ç›´æ¥åœ¨ DMA_HandleTypedef ä¸­è¿›è¡ŒæŒ‡å®šçš„**ã€‚æ–¹æ³•å¦‚ä¸‹:
> `W25Qxx_dma_handler.StreamBaseAddress = (uint32_t *)(&buf1);`
Â  `W25Qxx_dma_handler.StreamIndex = x;`
> ä½†æ˜¯, ä½¿ç”¨ **HAL_SPI_TransmitReceive_DMA** å‡½æ•°æ—¶, ç›´æ¥åœ¨å‡½æ•°ä¸­æŒ‡å®šåŸºåœ°å€å’Œç›®æ ‡åœ°å€å³å¯ã€‚å®é™…ä¸Šä¸éœ€è¦å¯¹æ­¤è¿›è¡Œèµ‹å€¼, å¯ä»¥è‡ªåŠ¨è®¡ç®—ã€‚
> åˆå§‹åŒ–ä¹‹åä¸éœ€è¦è°ƒç”¨Startå‡½æ•°, HALåº“ä¼šåœ¨è°ƒç”¨ SPI è¿›è¡Œä¼ è¾“æ—¶, ç›´æ¥è‡ªåŠ¨è°ƒç”¨ã€‚

åŒBuffer æ¨¡å¼å’Œç›´æ¥æ¨¡å¼å…·ä½“å¯èƒ½çš„è®¾ç½®å¦‚ä¸‹è¡¨æ‰€ç¤º:
![[attachments/Pasted image 20240715191416.png]]

## 3. F4 ä½¿ç”¨ DMA è®¿é—® W25Q128 èŠ¯ç‰‡
æ³¨æ„åœ¨ Write Enable å‰åå¿…é¡»å„æœ‰ä¸€æ¬¡åˆ‡æ¢ CS ç”µå¹³, å› æ­¤å•ç‹¬å°è£…ä¸€ä¸ªWriteEnableå‡½æ•°
getFlag  ç”¨æ³•:   å¯¹äº `TCIF3_7` æ˜¯æ•°æ®æµ3æˆ–è€…7çš„æ ‡å¿— ;

å¯¹äº SPI å‘é€å’Œæ¥æ”¶å‡éœ€è¦ä½¿ç”¨ DMA çš„æƒ…å†µ, æˆ‘ä»¬ä¸€èˆ¬éœ€è¦ä¸¤ä¸ª DMA Stream æ¥è¿›è¡Œå¯¹åº”çš„æ¥æ”¶ã€‚
å¦å¤–, åœ¨æ¯ä¸€æ¬¡è°ƒç”¨å®Œæ¯• Transmit_Recceive_DMA ç­‰ä¹‹å, éƒ½éœ€è¦ç­‰å¾… SPI çŠ¶æ€æ¢å¤, ä»£ç å¦‚ä¸‹:
```c
while (HAL_SPI_GetState(&W25Qxx_spi_handler) != HAL_SPI_STATE_READY);
```

å…¶ä¸­ä¸­æ–­æ ‡å¿—ä½ç­‰ç­‰ä¼šåœ¨ä¸­æ–­å‡½æ•°ä¸­, è‡ªåŠ¨æ¸…é™¤, ä¸éœ€è¦è€ƒè™‘ä¸»å¾ªç¯æ¸…é™¤æ ‡å¿—ä½é—®é¢˜(å®é™…ä¸Šæ˜¯åˆ¤æ–­Flag0_4, Flag3_7 ç­‰ç­‰æ ‡å¿—ä½å¹¶è‡ªåŠ¨æ¸…é™¤)
èƒ½å¤Ÿæ­£ç¡®è¿è¡Œçš„ä»£ç å¦‚ä¸‹:
> [!caution] ä¸­æ–­çš„ä½¿ç”¨
> åœ¨å¦‚ä¸‹çš„ç¨‹åºä¸­, **ä¸¤ä¸ªDMAä»¥åŠSPIçš„ä¸­æ–­æ˜¯ä¸€å®šè¦å¼€å¯çš„**, è¿™æ ·æ‰èƒ½å®ç°è§¦å‘ã€‚

```c
/* Private define ------------------------------------------------------------*/
#define W25Qxx_TYPE         128
#define W25Qxx_TIMEOUT      1000

/* Private macro -------------------------------------------------------------*/
#define W25Qxx_SPI_CLK_ENABLE       __HAL_RCC_SPI1_CLK_ENABLE
#define W25Qxx_SPI                  SPI1
#define W25Qxx_SPI_IRQn             SPI1_IRQn
#define W25Qxx_SPI_IRQHandler       SPI1_IRQHandler

#define W25Qxx_DMA_Tx_CLK_ENABLE    __HAL_RCC_DMA2_CLK_ENABLE
#define W25Qxx_DMA_Tx_Stream        DMA2_Stream3
#define W25Qxx_DMA_Tx_Channel       DMA_CHANNEL_3
#define W25Qxx_DMA_Tx_IRQn          DMA2_Stream3_IRQn
#define W25Qxx_DMA_Tx_IRQHandler    DMA2_Stream3_IRQHandler

#define W25Qxx_DMA_Rx_CLK_ENABLE    __HAL_RCC_DMA2_CLK_ENABLE
#define W25Qxx_DMA_Rx_Stream        DMA2_Stream0
#define W25Qxx_DMA_Rx_Channel       DMA_CHANNEL_3
#define W25Qxx_DMA_Rx_IRQn          DMA2_Stream0_IRQn
#define W25Qxx_DMA_Rx_IRQHandler    DMA2_Stream0_IRQHandler

#define W25Qxx_SCK_GPIO_CLK_ENABLE  __HAL_RCC_GPIOB_CLK_ENABLE
#define W25Qxx_SCK_GPIO             GPIOB
#define W25Qxx_SCK_PIN              GPIO_PIN_3
#define W25Qxx_SCK_AF               GPIO_AF5_SPI1

#define W25Qxx_MOSI_GPIO_CLK_ENABLE __HAL_RCC_GPIOB_CLK_ENABLE
#define W25Qxx_MOSI_GPIO            GPIOB
#define W25Qxx_MOSI_PIN             GPIO_PIN_5
#define W25Qxx_MOSI_AF              GPIO_AF5_SPI1

#define W25Qxx_MISO_GPIO_CLK_ENABLE __HAL_RCC_GPIOB_CLK_ENABLE
#define W25Qxx_MISO_GPIO            GPIOB
#define W25Qxx_MISO_PIN             GPIO_PIN_4
#define W25Qxx_MISO_AF              GPIO_AF5_SPI1

#define W25Qxx_CS_GPIO_CLK_ENABLE   __HAL_RCC_GPIOB_CLK_ENABLE
#define W25Qxx_CS_GPIO              GPIOB
#define W25Qxx_CS_PIN               GPIO_PIN_14

#define W25Qxx_CS_HIGH()            HAL_GPIO_WritePin(W25Qxx_CS_GPIO, W25Qxx_CS_PIN, GPIO_PIN_SET)
#define W25Qxx_CS_LOW()             HAL_GPIO_WritePin(W25Qxx_CS_GPIO, W25Qxx_CS_PIN, GPIO_PIN_RESET)


/** @defgroup W25QxxCmd  
 *  @brief W25Q64 Command List 
 *  @{
*/
#define W25QxxCmd_WriteEnable		    0x06 
#define W25QxxCmd_WriteDisable		    0x04 
#define W25QxxCmd_WriteStatusEnable     0x50
#define W25QxxCmd_ReadStatusReg		    0x05 
#define W25QxxCmd_ReadStatus2Reg        0x35
#define W25QxxCmd_WriteStatusReg		0x01 
#define W25QxxCmd_ReadData			    0x03 
#define W25QxxCmd_FastReadData		    0x0B 
#define W25QxxCmd_FastReadDual		    0x3B 
#define W25QxxCmd_PageProgram		    0x02 
#define W25QxxCmd_BlockErase			0xD8 
#define W25QxxCmd_SectorErase		    0x20 
#define W25QxxCmd_ChipErase			    0xC7 
#define W25QxxCmd_PowerDown			    0xB9 
#define W25QxxCmd_ReleasePowerDown	    0xAB 
#define W25QxxCmd_DeviceID			    0xAB 
#define W25QxxCmd_ManufactDeviceID   	0x90 
#define W25QxxCmd_JedecDeviceID		    0x9F
#define W25QxxCmd_EnableReset           0x66
#define W25QxxCmd_Reset                 0x99
/**
 * @}
 */

/* Private variables ---------------------------------------------------------*/
static DMA_HandleTypeDef W25Qxx_dma_tx_handler;
static DMA_HandleTypeDef W25Qxx_dma_rx_handler;
static GPIO_InitTypeDef  W25Qxx_gpio_initstruct;
static SPI_HandleTypeDef W25Qxx_spi_handler;

/* Private function prototypes -----------------------------------------------*/
static void SystemClock_Config(void);
static void Error_Handler(void); 

/* Private functions ---------------------------------------------------------*/
void W25Qxx_DMA_Tx_IRQHandler(){
    HAL_DMA_IRQHandler(&W25Qxx_dma_tx_handler);
}

void W25Qxx_DMA_Rx_IRQHandler(){
    HAL_DMA_IRQHandler(&W25Qxx_dma_rx_handler);
}

void W25Qxx_SPI_IRQHandler(){
    HAL_SPI_IRQHandler(&W25Qxx_spi_handler);
}

void __W25Qxx_SPI_Init(){
    W25Qxx_SPI_CLK_ENABLE();

    W25Qxx_spi_handler.Instance = W25Qxx_SPI;
    W25Qxx_spi_handler.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_128;
    W25Qxx_spi_handler.Init.Direction = SPI_DIRECTION_2LINES;
    W25Qxx_spi_handler.Init.DataSize  = SPI_DATASIZE_8BIT;
    W25Qxx_spi_handler.Init.Mode     = SPI_MODE_MASTER;
    W25Qxx_spi_handler.Init.CLKPhase = SPI_PHASE_1EDGE;
    W25Qxx_spi_handler.Init.CLKPolarity = SPI_POLARITY_LOW;
    W25Qxx_spi_handler.Init.FirstBit = SPI_FIRSTBIT_MSB;
    W25Qxx_spi_handler.Init.NSS = SPI_NSS_SOFT;
    W25Qxx_spi_handler.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
    W25Qxx_spi_handler.Init.CRCPolynomial = 7;
    W25Qxx_spi_handler.Init.TIMode = SPI_TIMODE_DISABLE;
    
    HAL_SPI_DeInit(&W25Qxx_spi_handler);
    
    if (HAL_SPI_Init(&W25Qxx_spi_handler) != HAL_OK){
        Error_Handler();
    }
}


void __W25Qxx_GPIO_Init(){
    W25Qxx_MOSI_GPIO_CLK_ENABLE();
    W25Qxx_MISO_GPIO_CLK_ENABLE();
    W25Qxx_CS_GPIO_CLK_ENABLE();
    W25Qxx_SCK_GPIO_CLK_ENABLE();
    
    W25Qxx_gpio_initstruct.Pin  = W25Qxx_SCK_PIN;
    W25Qxx_gpio_initstruct.Mode = GPIO_MODE_AF_PP;
    W25Qxx_gpio_initstruct.Pull = GPIO_PULLUP;
    W25Qxx_gpio_initstruct.Speed = GPIO_SPEED_FAST;
    W25Qxx_gpio_initstruct.Alternate = W25Qxx_SCK_AF;
    HAL_GPIO_Init(W25Qxx_SCK_GPIO, &W25Qxx_gpio_initstruct);

    W25Qxx_gpio_initstruct.Pin = W25Qxx_MOSI_PIN;
    W25Qxx_gpio_initstruct.Alternate = W25Qxx_MOSI_AF;
    HAL_GPIO_Init(W25Qxx_MOSI_GPIO, &W25Qxx_gpio_initstruct);

    W25Qxx_gpio_initstruct.Pin = W25Qxx_MISO_PIN;
    W25Qxx_gpio_initstruct.Alternate = W25Qxx_MISO_AF;
    HAL_GPIO_Init(W25Qxx_MISO_GPIO, &W25Qxx_gpio_initstruct);

    W25Qxx_gpio_initstruct.Pin = W25Qxx_CS_PIN;
    W25Qxx_gpio_initstruct.Mode = GPIO_MODE_OUTPUT_PP;
    W25Qxx_gpio_initstruct.Alternate = 0x00;
    
    HAL_GPIO_Init(W25Qxx_CS_GPIO, &W25Qxx_gpio_initstruct);

    W25Qxx_CS_HIGH();      // not selected as default 
}

/* ---------- Init DMA1  Channel6 -------- */
void __W25Qxx_DMA_Init(void){
    
    W25Qxx_DMA_Tx_CLK_ENABLE();
    W25Qxx_DMA_Rx_CLK_ENABLE();
    
    __HAL_LINKDMA(&W25Qxx_spi_handler, hdmatx, W25Qxx_dma_tx_handler);
    __HAL_LINKDMA(&W25Qxx_spi_handler, hdmarx, W25Qxx_dma_rx_handler);

    W25Qxx_dma_tx_handler.Instance = W25Qxx_DMA_Tx_Stream; // for example, DMA1_Stream0
    W25Qxx_dma_tx_handler.Init.Channel = W25Qxx_DMA_Tx_Channel;
    W25Qxx_dma_tx_handler.Init.Direction = DMA_MEMORY_TO_PERIPH;
    W25Qxx_dma_tx_handler.Init.Mode = DMA_NORMAL;
    W25Qxx_dma_tx_handler.Init.MemDataAlignment = DMA_MDATAALIGN_BYTE;
    W25Qxx_dma_tx_handler.Init.PeriphDataAlignment = DMA_PDATAALIGN_BYTE;
    W25Qxx_dma_tx_handler.Init.MemInc = DMA_MINC_ENABLE;
    W25Qxx_dma_tx_handler.Init.PeriphInc = DMA_PINC_DISABLE;
    W25Qxx_dma_tx_handler.Init.Priority = DMA_PRIORITY_LOW;
    W25Qxx_dma_tx_handler.Init.FIFOMode = DMA_FIFOMODE_DISABLE;
    W25Qxx_dma_tx_handler.Init.FIFOThreshold = DMA_FIFO_THRESHOLD_FULL;
    W25Qxx_dma_tx_handler.Init.MemBurst = DMA_MBURST_SINGLE;
    W25Qxx_dma_tx_handler.Init.PeriphBurst = DMA_PBURST_SINGLE;
    
    W25Qxx_dma_rx_handler.Instance       = W25Qxx_DMA_Rx_Stream; // for example, DMA1_Stream0
    W25Qxx_dma_rx_handler.Init.Channel   = W25Qxx_DMA_Rx_Channel;
    W25Qxx_dma_rx_handler.Init.Direction = DMA_PERIPH_TO_MEMORY;
    W25Qxx_dma_rx_handler.Init.Mode      = DMA_NORMAL;
    W25Qxx_dma_rx_handler.Init.MemDataAlignment = DMA_MDATAALIGN_BYTE;
    W25Qxx_dma_rx_handler.Init.MemInc = DMA_MINC_ENABLE;
    W25Qxx_dma_rx_handler.Init.PeriphDataAlignment = DMA_PDATAALIGN_BYTE;
    W25Qxx_dma_rx_handler.Init.PeriphInc = DMA_PINC_DISABLE;
    W25Qxx_dma_rx_handler.Init.Priority = DMA_PRIORITY_HIGH;
    W25Qxx_dma_rx_handler.Init.FIFOMode = DMA_FIFOMODE_DISABLE;
    W25Qxx_dma_rx_handler.Init.FIFOThreshold = DMA_FIFO_THRESHOLD_FULL;
    W25Qxx_dma_rx_handler.Init.MemBurst = DMA_MBURST_SINGLE;
    W25Qxx_dma_rx_handler.Init.PeriphBurst = DMA_PBURST_SINGLE; 
    
    HAL_DMA_DeInit(&W25Qxx_dma_rx_handler);
    HAL_DMA_DeInit(&W25Qxx_dma_tx_handler);
    if (HAL_DMA_Init(&W25Qxx_dma_tx_handler)!=HAL_OK || HAL_DMA_Init(&W25Qxx_dma_rx_handler) != HAL_OK){
        Error_Handler();
    }

    /*##---- Configure the NVIC for DMA #########################################*/ 
    /* NVIC configuration for DMA transfer complete interrupt (Tx) */
    HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_1);
    HAL_NVIC_SetPriority(W25Qxx_DMA_Tx_IRQn, 0, 1);
    HAL_NVIC_EnableIRQ(W25Qxx_DMA_Tx_IRQn);
    
    /* NVIC configuration for DMA transfer complete interrupt (Rx) */
    HAL_NVIC_SetPriority(W25Qxx_DMA_Rx_IRQn, 0, 0);
    HAL_NVIC_EnableIRQ(W25Qxx_DMA_Rx_IRQn);
  
    /*##-5- Configure the NVIC for SPI #########################################*/
    HAL_NVIC_SetPriority(W25Qxx_SPI_IRQn, 0, 2);
    HAL_NVIC_EnableIRQ(W25Qxx_SPI_IRQn);
}

/// @brief Write 1-byte Command to W25Qxx 
/// @param byte 
void __W25Qxx_WriteCmd(uint8_t byte){
    if (HAL_SPI_Transmit_DMA(&W25Qxx_spi_handler, (uint8_t*)(&byte), 1))
    {
        Error_Handler();
    }
    while (HAL_SPI_GetState(&W25Qxx_spi_handler) != HAL_SPI_STATE_READY){
    };
}

uint8_t __W25Qxx_ExchangeByte(uint8_t byte){
    uint8_t ch;
    if (HAL_SPI_TransmitReceive_DMA(&W25Qxx_spi_handler, (uint8_t*)&byte, &ch, 1))
    {
        Error_Handler();
    }
    while (HAL_SPI_GetState(&W25Qxx_spi_handler) != HAL_SPI_STATE_READY);
    return ch;
}

// read Manufacture ID
uint8_t W25Qxx_ReadID(uint8_t* mid, uint16_t* did){
    uint8_t tx[3] = {0xff, 0xff, 0xff};
    uint8_t rx[3] = {0xff, 0xff, 0xff};
    W25Qxx_CS_LOW();
    __W25Qxx_WriteCmd(W25QxxCmd_JedecDeviceID);
    if (HAL_SPI_TransmitReceive_DMA(&W25Qxx_spi_handler, (uint8_t*) tx, (uint8_t*)rx, 3)){
        Error_Handler();
    }
    while (HAL_SPI_GetState(&W25Qxx_spi_handler) != HAL_SPI_STATE_READY);

    uint8_t MID = rx[0];
    uint16_t DID = (rx[1] << 8 | rx[2]);
    W25Qxx_CS_HIGH();
    if (mid!= NULL && did!= NULL)
    {
        (*mid) = MID;
        (*did) = DID;
    }
    if (MID == 0xFF) return 1;
    return 0;
}

/// @brief Init W25Qxx Series Flash 
uint8_t W25Qxx_Init(){
    __W25Qxx_GPIO_Init();
    __W25Qxx_DMA_Init();  
    __W25Qxx_SPI_Init();  //
    return W25Qxx_ReadID(NULL, NULL);
}

/// @brief Enable Write Function
/// @param write_enable use true
void __W25Qxx_WriteEnable(uint8_t write_enable){
    W25Qxx_CS_LOW();
    if (write_enable) __W25Qxx_WriteCmd(W25QxxCmd_WriteEnable);
    else __W25Qxx_WriteCmd(W25QxxCmd_WriteDisable);
    W25Qxx_CS_HIGH();
}

/// @brief Wait for Busy Status
void __W25Qxx_WaitBusy(){
    W25Qxx_CS_LOW();
    __W25Qxx_WriteCmd(W25QxxCmd_ReadStatusReg);          // only read register 1
    while ((__W25Qxx_ExchangeByte(0xFF) & 0x01) != 0);   // while not BUSY
    W25Qxx_CS_HIGH();
}

/// @brief Erase the sector the byte address exists
/// @param SectorAddr address of the sector to erase
void W25Qxx_SectorErase(uint32_t SectorAddr){
    __W25Qxx_WaitBusy();
    __W25Qxx_WriteEnable(1);
    W25Qxx_CS_LOW();
    __W25Qxx_WriteCmd(W25QxxCmd_SectorErase);
    __W25Qxx_WriteCmd((SectorAddr & 0xFF0000) >> 16);
    __W25Qxx_WriteCmd((SectorAddr & 0x00FF00) >> 8);
    __W25Qxx_WriteCmd((SectorAddr & 0x0000FF));
    W25Qxx_CS_HIGH();
    __W25Qxx_WaitBusy();
}

/// @brief erase the sector of addr and then write message to it.
/// @note don't Write more than 256 bytes at once or exceed page 
void W25Qxx_WriteData(const uint32_t addr, uint8_t* buff, uint16_t size){
    W25Qxx_SectorErase(addr); // erase the sector
    __W25Qxx_WriteEnable(1);
    W25Qxx_CS_LOW();
    __W25Qxx_WriteCmd(W25QxxCmd_PageProgram);
    __W25Qxx_WriteCmd((addr & 0xFF0000)>> 16);
    __W25Qxx_WriteCmd((addr & 0x00FF00)>> 8);
    __W25Qxx_WriteCmd((addr & 0x0000FF));
    HAL_SPI_Transmit_DMA(&W25Qxx_spi_handler, buff, size);
    while (HAL_SPI_GetState(&W25Qxx_spi_handler) != HAL_SPI_STATE_READY);

    W25Qxx_CS_HIGH();
    __W25Qxx_WaitBusy();
}


/// @brief Read Data from address
/// @param addr Data Address to be read from 
/// @param buff 
/// @param size no limit 
/// @return 0 read succeed, 1 read failed 
uint8_t W25Qxx_ReadData(uint32_t addr, uint8_t *buff, uint16_t size){
    uint8_t result;
    __W25Qxx_WaitBusy();
    W25Qxx_CS_LOW();
    __W25Qxx_WriteCmd(W25QxxCmd_ReadData);
    /*  construct 24-bit address    */
    __W25Qxx_WriteCmd((addr & 0xFF0000)>>16);
    __W25Qxx_WriteCmd((addr & 0x00FF00)>>8);
    __W25Qxx_WriteCmd((addr & 0x0000FF));

    result = HAL_SPI_Receive_DMA(&W25Qxx_spi_handler, buff, size);
    while (HAL_SPI_GetState(&W25Qxx_spi_handler) != HAL_SPI_STATE_READY);
    W25Qxx_CS_HIGH();
    return result;
}
```




