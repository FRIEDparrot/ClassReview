## 一、 ES8388 录音基本原理
wav 格式录音是通过 I2S 接口传输给 STM32F4 后, 软件编码成为 wav 格式; 采集到模拟信号转换为数字信号; 同时可以实现声音大小的检测;

根据 ES8388 原理图部分, 麦克风接口接线如图: 
![[attachments/Pasted image 20240805123318.png]]
首先采用咪头进行录音, 经过100nF电容到达MIC_P 和 MIC_N 两个通道部分, <mark style="background: transparent; color: red">左右声道均接入同一个咪头, 因此其数据实际上是相同的</mark>;

第二, 对于 STM32F4 部分, 全双工模式需要采用 I2Sx_Ext 部分, 同时, 全双工模式下, I2Sx 向 I2S_ext 提供 CK 信号和 WS 时钟信号部分; 

从 I2S_ext 接收来自 ES8388 的ADC数据, 必须采用全双工模式进行。而主 I2Sx 需要循环发送数据 0x0000 给 ES8388, 来产生 CK, WS, MCK 信号;

> [!NOTE] 同时进行声音强度检测和播放声音方法
> 另外给出 MicroPhone 的常见电路, **因此实际上我们只需要将 MIC_P 接入正极进行左声道录音即可, 而 MIN_N 部分可以接入 ADC, 以做出声音强度的检测效果**。

![[attachments/Pasted image 20240805143529.png]]

对于 I2S2 和 I2S2ext 部分, 对于主机, 采用 I2S 主机发送模式, 而 I2Sext 可以设置从机接收模式, 注意: 必须同时使能 DMA 部分, 第二设置主 I2S 的采样率, 以提供对应的信号;

注意: 在录音模式下不需要开启 DMA 传输完成的中断, 第二, 使用 DMA1 的Stream3 的 Channel3 实现 DMA 数据接收, 并设置为双缓冲循环模式;

对于同时进行发送和接收的情况, <mark style="background: transparent; color: red">通过 DMA 将 I2SDR 寄存器的数据搬运到缓冲区(即内存1), 同时CPU负责将内存2的部分搬运到 TF 卡。需要说明, 此时程序需要保存DMA，程序保存时间小于DMA 接收满的时间</mark>;
对于工作模式, 拓展的 I2S 需要使用从机模式进行接收 (**使用 I2S_MODE_SLAVE_RX**), 一般选择 16 位数据格式 (16ext是扩展到32位帧中);

实际上还是先初始化 WAV 文件头,  
需要说明: **i2s_init 是作为主机发送进行 初始化的, 而拓展 i2s 是作为从机接收进行初始化的**; 
对于TX 的 DMA, 只需要先将 DR 置零, 然后循环发送就可以了(实际上例程定义了一个2大小数组用于发送); 接收时进行缓冲;

另外, 对于录音接收的 FIFO 数组指针部分; 10 个成员(共申请 10 * 4096缓冲区申请); 
最终偏移到文件头并写入文件的头数据即可。



 