éœ€è¦è¯´æ˜ï¼Œ ä½¿ç”¨ RabbitMQ å®ç°æœ€ç»ˆä¸€è‡´æ€§çš„æ–¹å¼æ— æ³•æ»¡è¶³â€œä¸¤ä¸ªäº‹åŠ¡éƒ½å›æ»šâ€çš„éœ€æ±‚ã€‚è¿™æ˜¯å› ä¸º RabbitMQ æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒçš„ä½œç”¨æ˜¯è§£è€¦å’Œå¼‚æ­¥å¤„ç†ï¼Œè€Œä¸æ˜¯æä¾›åˆ†å¸ƒå¼äº‹åŠ¡çš„åŸå­æ€§ä¿è¯ã€‚å¦‚æœ `reviews_db` æ’å…¥å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šç•™åœ¨é˜Ÿåˆ—ä¸­é‡è¯•ï¼Œä½† `blog_db` çš„äº‹åŠ¡å·²ç»æäº¤ï¼Œæ— æ³•å›æ»šã€‚

å¦‚æœä½ éœ€è¦ä¿è¯è·¨åº“çš„åŸå­æ€§ï¼ˆå³ä¸¤ä¸ªæ•°æ®åº“çš„äº‹åŠ¡è¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å›æ»šï¼‰ï¼Œä¼ ç»Ÿçš„å•æ•°æ®åº“äº‹åŠ¡æœºåˆ¶æ— æ³•æ»¡è¶³éœ€æ±‚ã€‚ä½ éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ **ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰** æˆ– **Saga æ¨¡å¼**ã€‚ 

## ä¸€ã€ SqlAlchemy é”™è¯¯æ•è·åŸç† 
### (1) é”™è¯¯è§¦å‘ 
æˆ‘ä»¬ä»¥  add ä¸ºä¾‹ï¼Œ  åœ¨ Sqlalchemy ä¸­ï¼Œ  ä¸€èˆ¬éœ€è¦è¿›è¡Œ ä¸¤é˜¶æ®µçš„ Add å’Œ flush (), Add ä¸ä¼šä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œ ä½†æ˜¯ flush ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ 
- **`add` çš„ä½œç”¨** : 
  - å°†å¯¹è±¡æ·»åŠ åˆ°ä¼šè¯ï¼ˆSessionï¼‰ä¸­ï¼Œæ ‡è®°ä¸ºâ€œå¾…æ’å…¥â€çŠ¶æ€ã€‚
  - æ­¤æ—¶å¹¶ä¸ä¼šç«‹å³å°†æ•°æ®å‘é€åˆ°æ•°æ®åº“ï¼Œè€Œæ˜¯å°†æ“ä½œç¼“å­˜åœ¨ä¼šè¯ä¸­ã€‚ 
  - **é€šå¸¸ä¸ä¼šè§¦å‘é”™è¯¯**ï¼š`add` åªæ˜¯å°†å¯¹è±¡æ·»åŠ åˆ°ä¼šè¯ä¸­ï¼Œä¸ä¼šç«‹å³æ£€æŸ¥æ•°æ®åº“çº¦æŸï¼ˆå¦‚å”¯ä¸€æ€§çº¦æŸã€æ•°æ®ç±»å‹ç­‰ï¼‰ã€‚
  - **ç‰¹æ®Šæƒ…å†µ**ï¼š
    - å¦‚æœå¯ç”¨äº† SQLAlchemy çš„ **`flush` æœºåˆ¶**ï¼ˆä¾‹å¦‚åœ¨æŸ¥è¯¢å‰è‡ªåŠ¨åˆ·æ–°ï¼‰ï¼Œå¯èƒ½ä¼šè§¦å‘æ•°æ®åº“çº¦æŸæ£€æŸ¥ã€‚
    - å¦‚æœ==æ‰‹åŠ¨è°ƒç”¨ `session.flush()`ï¼Œä¼šå°†æŒ‚èµ·çš„æ“ä½œå‘é€åˆ°æ•°æ®åº“ï¼Œæ­¤æ—¶ä¼šè§¦å‘é”™è¯¯==ã€‚

å› æ­¤ï¼Œ æˆ‘ä»¬å¯ä»¥è°ƒç”¨ flush æ¥æ˜¾å¼è§¦å‘é”™è¯¯ :  
1. **`flush`Â çš„ä½œç”¨**:
    - `flush`Â ä¼šå°†æŒ‚èµ·çš„æ“ä½œï¼ˆå¦‚Â `add`ï¼‰å‘é€åˆ°æ•°æ®åº“ï¼Œä½†ä¸ä¼šæäº¤äº‹åŠ¡ã€‚
    - å¦‚æœåœ¨Â `flush`Â åå‘ç”Ÿé”™è¯¯ï¼Œ**å½“å‰ä¼šè¯çš„äº‹åŠ¡å¯ä»¥å›æ»šï¼Œä½†å¦ä¸€ä¸ªä¼šè¯çš„äº‹åŠ¡ä¸å—å½±å“ã€‚**
2. **æ˜¯å¦éœ€è¦å›æ»š**ï¼š
    - å¦‚æœä¸è°ƒç”¨Â `commit`ï¼Œäº‹åŠ¡ä¸ä¼šæäº¤ï¼Œæ•°æ®åº“ä¸ä¼šæœ‰ä»»ä½•æ›´æ”¹ã€‚
    - ä½†å¦‚æœåœ¨Â `flush`Â åå‘ç”Ÿé”™è¯¯ï¼Œä»ç„¶éœ€è¦æ˜¾å¼è°ƒç”¨Â `rollback`Â æ¥æ¸…ç†ä¼šè¯çŠ¶æ€ã€‚ 
### (2)  roll back å›æ»šæœºåˆ¶ 
**1. `commit` å’Œ `rollback` çš„ä½œç”¨**
- **`commit`**ï¼š
  - æäº¤äº‹åŠ¡ï¼Œå°†æ‰€æœ‰æŒ‚èµ·çš„æ“ä½œï¼ˆå¦‚ `add`ã€`update`ã€`delete`ï¼‰æ°¸ä¹…ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚
  - å¦‚æœ `commit` æˆåŠŸï¼Œäº‹åŠ¡ç»“æŸï¼Œæ•°æ®è¢«æŒä¹…åŒ–ã€‚

- **`rollback`**ï¼š
  - å›æ»šäº‹åŠ¡ï¼Œæ’¤é”€æ‰€æœ‰æœªæäº¤çš„æ“ä½œã€‚
  - å¦‚æœå‘ç”Ÿé”™è¯¯ï¼ˆå¦‚æ•°æ®åº“çº¦æŸå†²çªã€ç½‘ç»œé—®é¢˜ç­‰ï¼‰ï¼Œè°ƒç”¨ `rollback` å¯ä»¥ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€‚

**2. `rollback` çš„ä½¿ç”¨åœºæ™¯**
- **å‘ç”Ÿé”™è¯¯æ—¶**ï¼š
  - å¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼ˆä¾‹å¦‚æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œåº”è¯¥è°ƒç”¨ `rollback` æ¥æ’¤é”€æœªæäº¤çš„æ“ä½œã€‚
  - å¦‚æœä¸è°ƒç”¨ `rollback`ï¼Œæœªæäº¤çš„æ“ä½œå¯èƒ½ä¼šç»§ç»­å ç”¨èµ„æºï¼Œç”šè‡³å¯¼è‡´æ•°æ®åº“å¤„äºä¸ä¸€è‡´çŠ¶æ€ã€‚

- **`commit` æˆåŠŸå**ï¼š
  - ==å¦‚æœ `commit` æˆåŠŸï¼Œäº‹åŠ¡å·²ç»ç»“æŸï¼Œæ•°æ®è¢«æŒä¹…åŒ–ï¼Œæ­¤æ—¶è°ƒç”¨ `rollback` ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœ==ã€‚
  - æ¢å¥è¯è¯´ï¼Œ`rollback` åªå¯¹æœªæäº¤çš„äº‹åŠ¡æœ‰æ•ˆã€‚

å› æ­¤ï¼Œ å¯¹äºä»¥ä¸‹çš„åŒäº‹åŠ¡å›æ»šæ“ä½œ :   
```python
except Exception as e:
	session.rollback()
	session_accounts.rollback()
	if isinstance(e, ServiceException):
		raise e
	if isinstance(e, SQLAlchemyError):
		database_logger.error(f"Database error: {e}", exc_info=True)
	else:
		system_logger.error(f"Unexpected error: {e}", exc_info=True)
	raise ServiceException("Failed to accept registration request",
						   1) from e
```
é‡‡ç”¨ä¸¤ä¸ª session çš„æ–¹æ¡ˆ : <b><mark style="background: transparent; color: orange">å³ä½¿åŠ å…¥äº† flush, ä¹Ÿæ— æ³•ä¿è¯æ“ä½œåŸå­æ€§</mark></b>ã€‚ 

## äºŒã€é‡è¦å‚æ•°

åœ¨ RabbitMQ ä¸­ï¼Œ`queue_declare` å’Œ `basic_consume` æ˜¯ä¸¤ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºå£°æ˜é˜Ÿåˆ—å’Œå¯åŠ¨æ¶ˆè´¹è€…ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°è¯¦è§£ï¼š

---

### (1) å›è°ƒå‡½æ•°å‚æ•°è§£é‡Š 
1. **`ch`Â (channel)**:
    - ç±»å‹:Â `pika.channel.Channel`
    - å«ä¹‰: è¿™æ˜¯ä¸ RabbitMQ æœåŠ¡å™¨é€šä¿¡çš„é€šé“å¯¹è±¡ã€‚é€šè¿‡è¿™ä¸ªé€šé“ï¼Œä½ å¯ä»¥æ‰§è¡Œè¯¸å¦‚æ¶ˆæ¯ç¡®è®¤ã€æ‹’ç»ç­‰æ“ä½œã€‚
2. **`method`**:
    - ç±»å‹:Â `pika.spec.Basic.Deliver`
    - å«ä¹‰: è¿™ä¸ªå¯¹è±¡åŒ…å«äº†æ¶ˆæ¯çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚æ¶ˆæ¯çš„æŠ•é€’æ ‡ç­¾ï¼ˆdelivery tagï¼‰ã€äº¤æ¢æœºåç§°ï¼ˆexchangeï¼‰ã€è·¯ç”±é”®ï¼ˆrouting keyï¼‰ç­‰ã€‚è¿™äº›ä¿¡æ¯é€šå¸¸ç”¨äºæ¶ˆæ¯çš„ç¡®è®¤æˆ–æ‹’ç»ã€‚
3. **`properties`**:
    - ç±»å‹:Â `pika.spec.BasicProperties`
    - å«ä¹‰: è¿™ä¸ªå¯¹è±¡åŒ…å«äº†æ¶ˆæ¯çš„å±æ€§ï¼Œæ¯”å¦‚æ¶ˆæ¯çš„å†…å®¹ç±»å‹ï¼ˆcontent typeï¼‰ã€å†…å®¹ç¼–ç ï¼ˆcontent encodingï¼‰ã€æ¶ˆæ¯çš„ä¼˜å…ˆçº§ï¼ˆpriorityï¼‰ã€æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼ˆexpirationï¼‰ç­‰ã€‚
4. **`body`**:
    - ç±»å‹:Â `bytes`
    - å«ä¹‰: è¿™æ˜¯æ¶ˆæ¯çš„å®é™…å†…å®¹ï¼Œé€šå¸¸æ˜¯å­—èŠ‚ç±»å‹ã€‚ä½ éœ€è¦æ ¹æ®æ¶ˆæ¯çš„ç¼–ç æ–¹å¼ï¼ˆå¦‚ JSONã€å­—ç¬¦ä¸²ç­‰ï¼‰å°†å…¶è§£ç ä¸ºå¯ç”¨çš„æ•°æ®æ ¼å¼ã€‚ 

### (2) Basic Publish å‚æ•°è¯¦è§£
åœ¨ RabbitMQ ä¸­ï¼Œ`basic_publish` æ˜¯ç”¨äºå°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šé˜Ÿåˆ—æˆ–äº¤æ¢å™¨çš„æ–¹æ³•ã€‚å®ƒçš„å‚æ•°å†³å®šäº†æ¶ˆæ¯å¦‚ä½•è¢«è·¯ç”±å’Œå¤„ç†ã€‚ä¸‹é¢æ˜¯å¯¹ `basic_publish` æ–¹æ³•çš„å„ä¸ªå‚æ•°çš„è¯¦ç»†è§£é‡Šï¼Œç‰¹åˆ«æ˜¯ `exchange` å’Œ `routing_key` çš„ä½œç”¨ã€‚
#### 1. `basic_publish` æ–¹æ³•ç­¾å
```python
basic_publish(exchange, routing_key, body, properties=None, mandatory=False)
```
#### 2. å‚æ•°è¯¦è§£
1. **`exchange`**:
   - **ä½œç”¨**: æŒ‡å®šæ¶ˆæ¯å‘é€åˆ°çš„äº¤æ¢å™¨ï¼ˆExchangeï¼‰ã€‚äº¤æ¢å™¨æ˜¯ RabbitMQ ä¸­ç”¨äºæ¥æ”¶æ¶ˆæ¯å¹¶å°†å…¶è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—çš„ç»„ä»¶ã€‚
   - **å–å€¼**:
     - `''` (ç©ºå­—ç¬¦ä¸²): è¡¨ç¤ºä½¿ç”¨é»˜è®¤äº¤æ¢å™¨ã€‚é»˜è®¤äº¤æ¢å™¨æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„äº¤æ¢å™¨ï¼Œå®ƒä¼šå°†æ¶ˆæ¯ç›´æ¥è·¯ç”±åˆ°ä¸ `routing_key` åŒåçš„é˜Ÿåˆ—ã€‚
     - `'exchange_name'`: æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„äº¤æ¢å™¨åç§°ã€‚äº¤æ¢å™¨éœ€è¦æå‰åœ¨ RabbitMQ ä¸­å£°æ˜ã€‚
   - **ç¤ºä¾‹**: å¦‚æœä½ ä½¿ç”¨ `exchange=''`ï¼Œæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°é»˜è®¤äº¤æ¢å™¨ï¼Œå¹¶ä¸” `routing_key` å¿…é¡»æŒ‡å®šç›®æ ‡é˜Ÿåˆ—çš„åç§°ã€‚

2. **`routing_key`**:
   - **ä½œç”¨**: æŒ‡å®šæ¶ˆæ¯çš„è·¯ç”±é”®ï¼ˆRouting Keyï¼‰ã€‚è·¯ç”±é”®ç”¨äºå†³å®šæ¶ˆæ¯å¦‚ä½•è¢«äº¤æ¢å™¨è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚
   - **å–å€¼**:
     - å¦‚æœä½¿ç”¨é»˜è®¤äº¤æ¢å™¨ï¼ˆ`exchange=''`ï¼‰ï¼Œ`routing_key` å¿…é¡»æŒ‡å®šç›®æ ‡é˜Ÿåˆ—çš„åç§°ã€‚
     - å¦‚æœä½¿ç”¨è‡ªå®šä¹‰äº¤æ¢å™¨ï¼Œ`routing_key` çš„å€¼å–å†³äºäº¤æ¢å™¨çš„ç±»å‹ï¼ˆå¦‚ directã€topicã€fanout ç­‰ï¼‰ã€‚
   - **ç¤ºä¾‹**: å¦‚æœ `routing_key='prepare_queue'`ï¼Œå¹¶ä¸”ä½¿ç”¨é»˜è®¤äº¤æ¢å™¨ï¼Œæ¶ˆæ¯ä¼šè¢«å‘é€åˆ°åä¸º `prepare_queue` çš„é˜Ÿåˆ—ã€‚

3. **`body`**:
   - **ä½œç”¨**: æ¶ˆæ¯çš„å†…å®¹ï¼Œé€šå¸¸æ˜¯å­—èŠ‚ç±»å‹çš„æ•°æ®ã€‚
   - **å–å€¼**: å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€å­—èŠ‚æ•°ç»„æˆ–ä»»ä½•å¯ä»¥è¢«åºåˆ—åŒ–çš„æ•°æ®ã€‚
   - **ç¤ºä¾‹**: å¦‚æœä½ å‘é€ JSON æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ `json.dumps(data)` å°†å­—å…¸è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ã€‚

4. **`properties`**:
   - **ä½œç”¨**: å¯é€‰å‚æ•°ï¼Œç”¨äºæŒ‡å®šæ¶ˆæ¯çš„å±æ€§ï¼ˆå¦‚æ¶ˆæ¯å¤´ã€ä¼˜å…ˆçº§ã€æŒä¹…åŒ–ç­‰ï¼‰ã€‚
   - **å–å€¼**: é€šå¸¸æ˜¯ä¸€ä¸ª `pika.BasicProperties` å¯¹è±¡ã€‚
   - **ç¤ºä¾‹**: ä½ å¯ä»¥è®¾ç½®æ¶ˆæ¯çš„ `delivery_mode=2` æ¥ä½¿æ¶ˆæ¯æŒä¹…åŒ–ï¼Œç¡®ä¿æ¶ˆæ¯åœ¨ RabbitMQ é‡å¯åä¸ä¼šä¸¢å¤±ã€‚

5. **`mandatory`**:
   - **ä½œç”¨**: å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå¦‚æœæ¶ˆæ¯æ— æ³•è¢«è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—æ—¶ï¼Œæ˜¯å¦è¿”å›æ¶ˆæ¯ç»™ç”Ÿäº§è€…ã€‚
   - **å–å€¼**: `True` æˆ– `False`ã€‚
   - **ç¤ºä¾‹**: å¦‚æœè®¾ç½®ä¸º `True`ï¼Œå¹¶ä¸”æ¶ˆæ¯æ— æ³•è¢«è·¯ç”±åˆ°ä»»ä½•é˜Ÿåˆ—ï¼ŒRabbitMQ ä¼šé€šè¿‡ `basic.return` æ–¹æ³•å°†æ¶ˆæ¯è¿”å›ç»™ç”Ÿäº§è€…ã€‚

#### 3. ä»£ç ç¤ºä¾‹ 
å‡è®¾ä½ æœ‰ä¸€ä¸ªåä¸º `prepare_queue` çš„é˜Ÿåˆ—ï¼Œå¹¶ä¸”ä½ å¸Œæœ›å°†æ¶ˆæ¯å‘é€åˆ°è¿™ä¸ªé˜Ÿåˆ—ã€‚ä½ å¯ä»¥è¿™æ ·è°ƒç”¨ `basic_publish`ï¼š

```python
self.channel.basic_publish(
    exchange='',  # ä½¿ç”¨é»˜è®¤äº¤æ¢å™¨
    routing_key='prepare_queue',  # æŒ‡å®šç›®æ ‡é˜Ÿåˆ—åç§°
    body=json.dumps(data),  # æ¶ˆæ¯å†…å®¹
    properties=pika.BasicProperties(
        delivery_mode=2,  # ä½¿æ¶ˆæ¯æŒä¹…åŒ–
    ),
    mandatory=False  # å¦‚æœæ¶ˆæ¯æ— æ³•è·¯ç”±ï¼Œä¸è¿”å›ç»™ç”Ÿäº§è€…
)
```

- **`exchange`**: æŒ‡å®šæ¶ˆæ¯å‘é€åˆ°çš„äº¤æ¢å™¨ã€‚ä½¿ç”¨ `''` è¡¨ç¤ºé»˜è®¤äº¤æ¢å™¨ã€‚
- **`routing_key`**: æŒ‡å®šæ¶ˆæ¯çš„è·¯ç”±é”®ã€‚å¦‚æœä½¿ç”¨é»˜è®¤äº¤æ¢å™¨ï¼Œ`routing_key` å¿…é¡»æ˜¯ç›®æ ‡é˜Ÿåˆ—çš„åç§°ã€‚
- **`body`**: æ¶ˆæ¯çš„å†…å®¹ï¼Œé€šå¸¸æ˜¯åºåˆ—åŒ–åçš„æ•°æ®ã€‚
- **`properties`**: å¯é€‰å‚æ•°ï¼Œç”¨äºè®¾ç½®æ¶ˆæ¯çš„å±æ€§ï¼ˆå¦‚æŒä¹…åŒ–ã€ä¼˜å…ˆçº§ç­‰ï¼‰ã€‚
- **`mandatory`**: å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå¦‚æœæ¶ˆæ¯æ— æ³•è·¯ç”±æ—¶æ˜¯å¦è¿”å›ç»™ç”Ÿäº§è€…ã€‚

é€šè¿‡åˆç†è®¾ç½®è¿™äº›å‚æ•°ï¼Œä½ å¯ä»¥æ§åˆ¶æ¶ˆæ¯å¦‚ä½•è¢« RabbitMQ è·¯ç”±å’Œå¤„ç†ã€‚

### (3) **`queue_declare` æ–¹æ³•**
`queue_declare` ç”¨äºå£°æ˜ä¸€ä¸ªé˜Ÿåˆ—ã€‚å¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼ŒRabbitMQ ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒï¼›å¦‚æœé˜Ÿåˆ—å·²å­˜åœ¨ï¼Œåˆ™ä¸ä¼šé‡å¤åˆ›å»ºã€‚

#### **æ–¹æ³•ç­¾å**
```python
queue_declare(queue, passive=False, durable=False, exclusive=False, auto_delete=False, arguments=None)
```

#### **å‚æ•°è¯¦è§£**
| å‚æ•°å         | ç±»å‹    | é»˜è®¤å€¼  | è¯´æ˜                                                                 |
|----------------|---------|---------|----------------------------------------------------------------------|
| `queue`        | str     | `''`    | é˜Ÿåˆ—åç§°ã€‚å¦‚æœä¸ºç©ºï¼ŒRabbitMQ ä¼šç”Ÿæˆä¸€ä¸ªéšæœºåç§°ã€‚                   |
| `passive`      | bool    | `False` | å¦‚æœä¸º `True`ï¼Œä»…æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨ï¼Œä¸ä¼šåˆ›å»ºé˜Ÿåˆ—ã€‚                    |
| `durable`      | bool    | `False` | å¦‚æœä¸º `True`ï¼Œé˜Ÿåˆ—ä¼šè¢«æŒä¹…åŒ–ï¼Œå³ä½¿ RabbitMQ é‡å¯ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚        |
| `exclusive`    | bool    | `False` | å¦‚æœä¸º `True`ï¼Œé˜Ÿåˆ—ä»…å¯¹å½“å‰è¿æ¥å¯è§ï¼Œè¿æ¥å…³é—­æ—¶é˜Ÿåˆ—ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚   |
| `auto_delete`  | bool    | `False` | å¦‚æœä¸º `True`ï¼Œå½“æœ€åä¸€ä¸ªæ¶ˆè´¹è€…æ–­å¼€è¿æ¥æ—¶ï¼Œé˜Ÿåˆ—ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚        |
| `arguments`    | dict    | `None`  | é¢å¤–çš„é˜Ÿåˆ—å‚æ•°ï¼ˆå¦‚æ¶ˆæ¯ TTLã€é˜Ÿåˆ—é•¿åº¦é™åˆ¶ç­‰ï¼‰ã€‚                       |

#### **ç¤ºä¾‹**
```python
self.channel.queue_declare(
    queue="my_queue",
    durable=True,        # é˜Ÿåˆ—æŒä¹…åŒ–
    exclusive=False,     # é˜Ÿåˆ—å¯¹æ‰€æœ‰è¿æ¥å¯è§
    auto_delete=True,    # å½“æœ€åä¸€ä¸ªæ¶ˆè´¹è€…æ–­å¼€æ—¶åˆ é™¤é˜Ÿåˆ—
    arguments={
        "x-message-ttl": 60000  # æ¶ˆæ¯å­˜æ´»æ—¶é—´ï¼ˆ60ç§’ï¼‰
    }
)
```

---

### (4) **`basic_consume` æ–¹æ³•**
`basic_consume` ç”¨äºå¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç›‘å¬æŒ‡å®šé˜Ÿåˆ—å¹¶å¤„ç†æ¶ˆæ¯ã€‚

#### **æ–¹æ³•ç­¾å**
```python
basic_consume(queue, on_message_callback, auto_ack=False, exclusive=False, consumer_tag=None, arguments=None)
```

#### **å‚æ•°è¯¦è§£**
| å‚æ•°å               | ç±»å‹         | é»˜è®¤å€¼  | è¯´æ˜                                                                 |
|----------------------|--------------|---------|----------------------------------------------------------------------|
| `queue`              | str          | -       | è¦ç›‘å¬çš„é˜Ÿåˆ—åç§°ã€‚                                                  |
| `on_message_callback`| callable     | -       | æ¶ˆæ¯å¤„ç†å›è°ƒå‡½æ•°ï¼Œæ ¼å¼ä¸º `callback(ch, method, properties, body)`ã€‚  |
| `auto_ack`           | bool         | `False` | å¦‚æœä¸º `True`ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ `basic_ack`ã€‚      |
| `exclusive`          | bool         | `False` | å¦‚æœä¸º `True`ï¼Œé˜Ÿåˆ—ä»…å…è®¸å½“å‰æ¶ˆè´¹è€…è¿æ¥ï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¼šè¢«æ‹’ç»ã€‚        |
| `consumer_tag`       | str          | `None`  | æ¶ˆè´¹è€…æ ‡ç­¾ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†æ¶ˆè´¹è€…ã€‚                                     |
| `arguments`          | dict         | `None`  | é¢å¤–çš„æ¶ˆè´¹è€…å‚æ•°ï¼ˆå¦‚ä¼˜å…ˆçº§ã€QoS ç­‰ï¼‰ã€‚                              |

#### **ç¤ºä¾‹**
```python
def callback(ch, method, properties, body):
    print(f"Received message: {body.decode()}")
    # æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
    ch.basic_ack(delivery_tag=method.delivery_tag)

self.channel.basic_consume(
    queue="my_queue",
    on_message_callback=callback,
    auto_ack=False,       # æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
    exclusive=False,      # å…è®¸å¤šä¸ªæ¶ˆè´¹è€…
    consumer_tag="my_consumer",
    arguments={
        "x-priority": 10  # è®¾ç½®æ¶ˆè´¹è€…ä¼˜å…ˆçº§
    }
)
```

### 3. **å‚æ•°ç»„åˆä½¿ç”¨åœºæ™¯**
ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„å‚æ•°ç»„åˆåŠå…¶ä½¿ç”¨åœºæ™¯ï¼š
```python
self.channel.queue_declare(queue="my_queue", durable=True)
self.channel.basic_consume(queue="my_queue", on_message_callback=self.callback, auto_ack=False)
```
#### **åœºæ™¯ 1ï¼šæŒä¹…åŒ–é˜Ÿåˆ— + æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯**
- **`queue_declare`**ï¼š
  - `durable=True`ï¼šé˜Ÿåˆ—æŒä¹…åŒ–ï¼Œç¡®ä¿ RabbitMQ é‡å¯åé˜Ÿåˆ—ä»ç„¶å­˜åœ¨ã€‚
- **`basic_consume`**ï¼š
  - `auto_ack=False`ï¼š<b><mark style="background: transparent; color: orange">æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ï¼Œç¡®ä¿æ¶ˆæ¯å¤„ç†å®Œæˆåå†ç¡®è®¤</mark></b>ã€‚
```python
self.channel.queue_declare(queue="my_queue", durable=True)
self.channel.basic_consume(queue="my_queue", on_message_callback=self.callback, auto_ack=False)
```
#### **åœºæ™¯ 2ï¼šä¸´æ—¶é˜Ÿåˆ— + è‡ªåŠ¨åˆ é™¤**
- **`queue_declare`**ï¼š
  - `exclusive=True`ï¼šé˜Ÿåˆ—ä»…å¯¹å½“å‰è¿æ¥å¯è§ã€‚
  - `auto_delete=True`ï¼šå½“æœ€åä¸€ä¸ªæ¶ˆè´¹è€…æ–­å¼€æ—¶ï¼Œé˜Ÿåˆ—è‡ªåŠ¨åˆ é™¤ã€‚
- **`basic_consume`**ï¼š
  - `auto_ack=True`ï¼šè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯ï¼Œé€‚åˆä¸éœ€è¦ä¸¥æ ¼æ¶ˆæ¯ç¡®è®¤çš„åœºæ™¯ã€‚

```python
self.channel.queue_declare(queue="temp_queue", exclusive=True, auto_delete=True)
self.channel.basic_consume(queue="temp_queue", on_message_callback=self.callback, auto_ack=True)
```

#### **åœºæ™¯ 3ï¼šä¼˜å…ˆçº§é˜Ÿåˆ— + æ¶ˆè´¹è€…ä¼˜å…ˆçº§**
- **`queue_declare`**ï¼š
  - `arguments={"x-max-priority": 10}`ï¼šè®¾ç½®é˜Ÿåˆ—æ”¯æŒä¼˜å…ˆçº§æ¶ˆæ¯ï¼ˆä¼˜å…ˆçº§èŒƒå›´ä¸º 0-10ï¼‰ã€‚
- **`basic_consume`**ï¼š
  - `arguments={"x-priority": 5}`ï¼šè®¾ç½®æ¶ˆè´¹è€…ä¼˜å…ˆçº§ã€‚

```python
self.channel.queue_declare(queue="priority_queue", arguments={"x-max-priority": 10})
self.channel.basic_consume(queue="priority_queue", on_message_callback=self.callback, arguments={"x-priority": 5})
```

- **`queue_declare`**ï¼š
  - ç”¨äºå£°æ˜é˜Ÿåˆ—ï¼Œæ”¯æŒæŒä¹…åŒ–ã€ç‹¬å ã€è‡ªåŠ¨åˆ é™¤ç­‰ç‰¹æ€§ã€‚
  - å¯ä»¥é€šè¿‡ `arguments` è®¾ç½®é¢å¤–çš„é˜Ÿåˆ—å‚æ•°ï¼ˆå¦‚æ¶ˆæ¯ TTLã€ä¼˜å…ˆçº§ç­‰ï¼‰ã€‚
- **`basic_consume`**ï¼š
  - ç”¨äºå¯åŠ¨æ¶ˆè´¹è€…ï¼Œæ”¯æŒè‡ªåŠ¨ç¡®è®¤ã€ç‹¬å æ¶ˆè´¹è€…ç­‰ç‰¹æ€§ã€‚
  - å¯ä»¥é€šè¿‡ `arguments` è®¾ç½®é¢å¤–çš„æ¶ˆè´¹è€…å‚æ•°ï¼ˆå¦‚ä¼˜å…ˆçº§ã€QoS ç­‰ï¼‰ã€‚

é€šè¿‡åˆç†ç»„åˆè¿™äº›å‚æ•°ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„éœ€æ±‚ï¼Œå¦‚æŒä¹…åŒ–é˜Ÿåˆ—ã€ä¸´æ—¶é˜Ÿåˆ—ã€ä¼˜å…ˆçº§é˜Ÿåˆ—ç­‰ã€‚ 

## ä¸‰ã€ 2PC æäº¤æ¨¡å¼å’Œå¼ºä¸€è‡´æ€§å®ç° 
### (1) æ€»ä½“ 2PC æäº¤é˜Ÿåˆ—è®¾è®¡
åœ¨ RabbitMQ ä¸­ï¼Œ å¦‚æœç›¸åŒæœåŠ¡å†…é‡‡ç”¨åŒä¸€é˜Ÿåˆ— ï¼Œ è€ŒRabbitMQæœ¬èº«ä¸æ”¯æŒæ¶ˆè´¹è€…çº§åˆ«çš„æ¶ˆæ¯è¿‡æ»¤ï¼Œ å¦‚æœä¸åŒäº‹åŠ¡å…±äº«é˜Ÿåˆ—ï¼Œ å¯èƒ½å¯¼è‡´æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…ç«äº‰ï¼Œ æ˜¾ç„¶ä¸ç¬¦åˆéœ€æ±‚ã€‚ 

- **RabbitMQ çš„æ¶ˆæ¯åˆ†å‘æœºåˆ¶**:  
    - RabbitMQ é»˜è®¤ä¼šå°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è½®è¯¢åˆ†å‘ç»™æ‰€æœ‰æ¶ˆè´¹è€…ã€‚
    - å¦‚æœå¤šä¸ªæ¶ˆè´¹è€…ç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¶ˆæ¯ä¼šè¢«ç«äº‰æ¶ˆè´¹ï¼Œæ— æ³•ä¿è¯ç‰¹å®šæ¶ˆè´¹è€…åªå¤„ç†ç‰¹å®šäº‹åŠ¡çš„æ¶ˆæ¯ã€‚ 

RabbitMQ çš„è®¾è®¡æ˜¯æ”¯æŒä¸Šåƒä¹ƒè‡³ä¸‡çº§åˆ«çš„é˜Ÿåˆ—çš„ï¼Œå› æ­¤ï¼Œ ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å®è·µæ˜¯<b><mark style="background: transparent; color: orange">ä¸ºæ¯ä¸ªäº‹åŠ¡ç§ç±»åˆ›å»ºå•ç‹¬çš„é˜Ÿåˆ—ï¼Œå¹¶é‡‡ç”¨åŠ¨æ€åˆ›å»ºç­‰åŠæ³•ï¼Œå‡å°‘ RabbitMQ è´Ÿæ‹…</mark></b>ã€‚ 

åŸºæœ¬æ€è·¯ç¤ºä¾‹ä»£ç å¦‚ä¸‹ : 
```python
from flask import Flask, request, jsonify
from sqlalchemy import create_engine, Column, Integer, String, Text
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import pika
import json
import threading

app = Flask(__name__)

# é…ç½®æ•°æ®åº“è¿æ¥
blog_db_engine = create_engine('sqlite:///blog.db', echo=True)
reviews_db_engine = create_engine('sqlite:///reviews.db', echo=True)

# åˆ›å»ºåŸºç±»
Base = declarative_base()

# å®šä¹‰ Blog æ¨¡å‹
class Blog(Base):
    __tablename__ = 'blogs'
    id = Column(Integer, primary_key=True)
    title = Column(String(100))
    content = Column(Text)

# å®šä¹‰ Review æ¨¡å‹
class Review(Base):
    __tablename__ = 'reviews'
    id = Column(Integer, primary_key=True)
    blog_id = Column(Integer)
    review_content = Column(Text)

# åˆ›å»ºè¡¨
Base.metadata.create_all(blog_db_engine)
Base.metadata.create_all(reviews_db_engine)

# åˆ›å»ºä¼šè¯ç±»
BlogSession = sessionmaker(bind=blog_db_engine)
ReviewSession = sessionmaker(bind=reviews_db_engine)

# RabbitMQ é…ç½®
rabbitmq_connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
rabbitmq_channel = rabbitmq_connection.channel()
rabbitmq_channel.queue_declare(queue='prepare_queue')  # å‡†å¤‡é˜¶æ®µé˜Ÿåˆ—
rabbitmq_channel.queue_declare(queue='commit_queue')   # æäº¤é˜¶æ®µé˜Ÿåˆ—
rabbitmq_channel.queue_declare(queue='rollback_queue')  # å›æ»šé˜¶æ®µé˜Ÿåˆ—

# æäº¤æ–‡ç« çš„è·¯ç”±
@app.route('/submit_blog', methods=['POST'])
def submit_blog():
    data = request.json
    title = data.get('title')
    content = data.get('content')

    # ç”Ÿæˆäº‹åŠ¡ ID
    transaction_id = hash(f"{title}_{content}")

    # å‘é€å‡†å¤‡æ¶ˆæ¯åˆ° RabbitMQ
    prepare_message = {
        'transaction_id': transaction_id,
        'title': title,
        'content': content
    }
    rabbitmq_channel.basic_publish(
        exchange='',
        routing_key='prepare_queue',
        body=json.dumps(prepare_message)
    )
    return jsonify({'status': 'success', 'transaction_id': transaction_id})


# RabbitMQ æ¶ˆè´¹è€…ï¼šå¤„ç†å‡†å¤‡é˜¶æ®µ
def consume_prepare():
    def callback(ch, method, properties, body):
        message = json.loads(body)
        transaction_id = message['transaction_id']
        title = message['title']
        content = message['content']

        # åœ¨ blog_db ä¸­å‡†å¤‡äº‹åŠ¡
        blog_session = BlogSession()
        new_blog = Blog(title=title, content=content)
        blog_session.add(new_blog)
        blog_session.flush()  # æš‚ä¸æäº¤

        # åœ¨ reviews_db ä¸­å‡†å¤‡äº‹åŠ¡
        review_session = ReviewSession()
        new_review = Review(blog_id=new_blog.id, review_content=f"Initial review for blog {new_blog.id}")
        review_session.add(new_review)
        review_session.flush()  # æš‚ä¸æäº¤

        # è¿”å›â€œåŒæ„â€æ¶ˆæ¯
        agree_message = {
            'transaction_id': transaction_id,
            'status': 'agree'
        }
        rabbitmq_channel.basic_publish(
            exchange='',
            routing_key='commit_queue',
            body=json.dumps(agree_message)
        )

    rabbitmq_channel.basic_consume(queue='prepare_queue', on_message_callback=callback, auto_ack=True)
    rabbitmq_channel.start_consuming()

# RabbitMQ æ¶ˆè´¹è€…ï¼šå¤„ç†æäº¤é˜¶æ®µ
def consume_commit():
    def callback(ch, method, properties, body):
        message = json.loads(body)
        transaction_id = message['transaction_id']
        status = message['status']
        if status == 'agree':
            # æäº¤ blog_db äº‹åŠ¡
            blog_session = BlogSession()
            blog_session.commit()

            # æäº¤ reviews_db äº‹åŠ¡
            review_session = ReviewSession()
            review_session.commit()

            print(f"Transaction {transaction_id} committed")
        else:
            # å›æ»š blog_db äº‹åŠ¡
            blog_session = BlogSession()
            blog_session.rollback()

            # å›æ»š reviews_db äº‹åŠ¡
            review_session = ReviewSession()
            review_session.rollback()

            print(f"Transaction {transaction_id} rolled back")

    rabbitmq_channel.basic_consume(queue='commit_queue', on_message_callback=callback, auto_ack=True)
    rabbitmq_channel.start_consuming()

if __name__ == '__main__':
    # å¯åŠ¨æ¶ˆè´¹è€…çº¿ç¨‹
    prepare_thread = threading.Thread(target=consume_prepare)
    prepare_thread.daemon = True
    prepare_thread.start()

    commit_thread = threading.Thread(target=consume_commit)
    commit_thread.daemon = True
    commit_thread.start()

    # å¯åŠ¨ Flask åº”ç”¨
    app.run(debug=True)
```


###  (2) åŸºäºåŠ¨æ€é˜Ÿåˆ— + æ¶ˆè´¹è€…ç»‘å®šçš„ 2PC å®ç°æ–¹æ¡ˆ
**æ¯ä¸ªäº‹åŠ¡ä¸­çš„æ¯æ¬¡æäº¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„ UUIDï¼Œå¹¶ä¸”è¿™äº› UUID æ˜¯çŸ­æš‚çš„ï¼ˆäº‹åŠ¡ç»“æŸåæ¸…é™¤é˜Ÿåˆ—ï¼‰**ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä¸ºæ¯ä¸ª UUID åˆ›å»ºä¸€ç»„é˜Ÿåˆ—ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. **é˜Ÿåˆ—æ•°é‡çˆ†ç‚¸**ï¼š
   - æ¯æ¬¡æäº¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ UUIDï¼Œå¯¼è‡´é˜Ÿåˆ—æ•°é‡å¿«é€Ÿå¢åŠ ã€‚
   - å³ä½¿äº‹åŠ¡ç»“æŸåæ¸…é™¤é˜Ÿåˆ—ï¼Œé«˜å¹¶å‘åœºæ™¯ä¸‹ä»ç„¶å¯èƒ½äº§ç”Ÿå¤§é‡é˜Ÿåˆ—ã€‚

2. **é˜Ÿåˆ—ç«äº‰**ï¼š
   - å¦‚æœå¤šä¸ªäº‹åŠ¡å…±äº«åŒä¸€ç»„é˜Ÿåˆ—ï¼ˆå¦‚ `prepare`ã€`commit`ã€`rollback`ï¼‰ï¼ŒRabbitMQ ä¼šå°†æ¶ˆæ¯åˆ†å‘ç»™ä¸åŒçš„æ¶ˆè´¹è€…ï¼Œå¯¼è‡´æ¶ˆæ¯è¢«ç«äº‰æ¶ˆè´¹ã€‚
   - è¿™ä¸ 2PC çš„éœ€æ±‚ï¼ˆæ¯ä¸ªäº‹åŠ¡çš„æ¶ˆæ¯å¿…é¡»ç”±ç‰¹å®šæ¶ˆè´¹è€…å¤„ç†ï¼‰ç›¸å†²çªã€‚

ä¸ºäº†æ—¢èƒ½ **å‡å°‘é˜Ÿåˆ—æ•°é‡**ï¼Œåˆèƒ½ **é¿å…æ¶ˆæ¯ç«äº‰** çš„æ–¹æ¡ˆï¼Œè®¾è®¡å¦‚ä¸‹ ï¼š 

**åŠ¨æ€é˜Ÿåˆ— + æ¶ˆè´¹è€…ç»‘å®š**
- **æ ¸å¿ƒæ€æƒ³**ï¼š
  - ä¸ºæ¯ä¸ªäº‹åŠ¡åŠ¨æ€åˆ›å»ºç‹¬ç«‹çš„é˜Ÿåˆ—ï¼ˆå¦‚ `txn_<uuid>_prepare`ã€`txn_<uuid>_commit`ã€`txn_<uuid>_rollback`ï¼‰ã€‚
  - æ¶ˆè´¹è€…åœ¨äº‹åŠ¡å¼€å§‹æ—¶ç»‘å®šåˆ°å¯¹åº”çš„é˜Ÿåˆ—ï¼Œäº‹åŠ¡ç»“æŸåè§£ç»‘å¹¶åˆ é™¤é˜Ÿåˆ—ã€‚
- **ä¼˜ç‚¹**ï¼š
  - å®Œå…¨éš”ç¦»æ¶ˆæ¯ï¼Œé¿å…ç«äº‰æ¶ˆè´¹ã€‚
  - é˜Ÿåˆ—æ•°é‡åŠ¨æ€è°ƒæ•´ï¼Œèµ„æºåˆ©ç”¨ç‡é«˜ã€‚
- **ç¼ºç‚¹**ï¼š
  - å®ç°å¤æ‚ï¼Œéœ€è¦åŠ¨æ€ç®¡ç†é˜Ÿåˆ—å’Œæ¶ˆè´¹è€…ç»‘å®šå…³ç³»ã€‚

#### **å®ç°æ­¥éª¤**
1. **äº‹åŠ¡å¼€å§‹æ—¶**ï¼š
   - ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ UUIDã€‚
   - åŠ¨æ€åˆ›å»ºé˜Ÿåˆ—ï¼ˆå¦‚ `txn_<uuid>_prepare`ã€`txn_<uuid>_commit`ã€`txn_<uuid>_rollback`ï¼‰ã€‚
   - æ¶ˆè´¹è€…ç»‘å®šåˆ°è¿™äº›é˜Ÿåˆ—ã€‚

2. **äº‹åŠ¡è¿›è¡Œä¸­**ï¼š
   - ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”çš„é˜Ÿåˆ—ã€‚
   - æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­æ¥æ”¶æ¶ˆæ¯å¹¶å¤„ç†ã€‚

3. **äº‹åŠ¡ç»“æŸæ—¶**ï¼š
   - æ¶ˆè´¹è€…è§£ç»‘é˜Ÿåˆ—ã€‚
   - åˆ é™¤é˜Ÿåˆ—ä»¥é‡Šæ”¾èµ„æºã€‚

#### **ä»£ç ç¤ºä¾‹**
```python
import pika
import uuid

def create_transaction_queue(queue_name):
    connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
    channel = connection.channel()
    channel.queue_declare(queue=queue_name)
    connection.close()
    print(f"Created queue: {queue_name}")

def delete_transaction_queue(queue_name):
    connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
    channel = connection.channel()
    channel.queue_delete(queue=queue_name)
    connection.close()
    print(f"Deleted queue: {queue_name}")

def consume_transaction_messages(queue_name):
    connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
    channel = connection.channel()

    def on_message(ch, method, properties, body):
        print(f"Received message from {queue_name}: {body.decode()}")
        # å¤„ç†æ¶ˆæ¯é€»è¾‘
        if body.decode() == "prepare":
            print("Processing prepare...")
        elif body.decode() == "commit":
            print("Processing commit...")
        elif body.decode() == "rollback":
            print("Processing rollback...")

    channel.basic_consume(queue=queue_name, on_message_callback=on_message, auto_ack=True)
    print(f"Consumer for {queue_name} is waiting for messages...")
    channel.start_consuming()

# ç¤ºä¾‹ï¼šäº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ
transaction_uuid = str(uuid.uuid4())
prepare_queue = f"txn_{transaction_uuid}_prepare"
commit_queue = f"txn_{transaction_uuid}_commit"
rollback_queue = f"txn_{transaction_uuid}_rollback"

# äº‹åŠ¡å¼€å§‹
create_transaction_queue(prepare_queue)
create_transaction_queue(commit_queue)
create_transaction_queue(rollback_queue)

# æ¶ˆè´¹è€…ç»‘å®šé˜Ÿåˆ—ï¼ˆå‡è®¾ä½¿ç”¨å¤šçº¿ç¨‹æˆ–å¼‚æ­¥å¤„ç†ï¼‰
consume_transaction_messages(prepare_queue)
consume_transaction_messages(commit_queue)
consume_transaction_messages(rollback_queue)

# äº‹åŠ¡ç»“æŸ
delete_transaction_queue(prepare_queue)
delete_transaction_queue(commit_queue)
delete_transaction_queue(rollback_queue)
```

### (3) åŸºäºçº¿ç¨‹è¿æ¥æ± çš„ RabbitMQ ç»“æ„è®¾è®¡
é¦–å…ˆï¼Œ æŒ‰ç…§ä¸Šè¿°æ–¹æ³•ï¼Œå¯¹äºæ¯ä¸ª 2PC è¿æ¥å¯¹è±¡ï¼Œ é¦–å…ˆéœ€è¦ä¸€ä¸ªè¿æ¥å‚æ•° conn,  ä½†æ˜¯,  å¯¹äºå°å‹åº”ç”¨èƒ½å¦å…±äº« conn ç›´æ¥ä¸ºä¸€ä¸ªå…¨å±€çš„ rabbitMQconn å¯¹è±¡ï¼Œä»ç„¶æ˜¯å­˜åœ¨é¡¾è™‘çš„ : 
#### 1. çº¿ç¨‹å®‰å…¨æ€§åˆ†æ
è™½ç„¶ RabbitMQ çš„é€šé“ (`channel`) æ˜¯çº¿ç¨‹éš”ç¦»çš„ï¼ˆæ¯ä¸ªé€šé“çš„æ“ä½œæ˜¯ç‹¬ç«‹çš„ï¼‰ï¼Œä½†Â `pika.BlockingConnection`Â çš„è¿æ¥å¯¹è±¡ (`conn`) æœ¬èº«**ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**ã€‚

**å…±äº«è¿æ¥  +  ç‹¬ç«‹çº¿ç¨‹é€šé“**æ˜¯ä¸å®‰å…¨çš„ï¼Œ ä¾‹å¦‚ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ : 
```python
# çº¿ç¨‹1å’Œçº¿ç¨‹2åŒæ—¶æ‰§è¡Œä»¥ä¸‹ä»£ç 
channel = rabbit_conn.channel()  # å…±äº«å…¨å±€ rabbit_conn
```
**å¯èƒ½å¯¼è‡´å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹è¿æ¥å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¯¼è‡´åè®®è§£æé”™è¯¯æˆ–ç¼“å†²åŒºæŸå**ã€‚ ç”±äºçŠ¶æ€æ··ä¹±ï¼Œè¿æ¥å¯èƒ½ä¼šæ„å¤–æ–­å¼€

**ä¸ºä»€ä¹ˆå…±äº«è¿æ¥ + ç‹¬ç«‹é€šé“ä¸å®‰å…¨ï¼Ÿ**
- **åº•å±‚å®ç°åŸå› **ï¼š  
    `pika.BlockingConnection`Â **æ˜¯åŸºäºåŒæ­¥é˜»å¡ I/O çš„å®ç°**ï¼Œå…¶å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚åè®®å¸§è§£æã€ç¼“å†²åŒºç®¡ç†ï¼‰åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨æ—¶æ— æ³•ä¿è¯åŸå­æ€§ã€‚
- **åè®®é™åˆ¶**ï¼š  
    AMQP åè®®è¦æ±‚<b><mark style="background: transparent; color: orange">è¿æ¥å’Œé€šé“çš„åˆ›å»ºæ˜¯é¡ºåºçš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ›å»ºé€šé“ä¼šç ´ååè®®çš„é¡ºåºæ€§</mark></b>ã€‚

è§£å†³ä¸Šè¿°é—®é¢˜çš„æ–¹æ³•ä¸€æ˜¯ä½¿ç”¨çº¿ç¨‹é” (`threading.Lock`) ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åˆ›å»ºé€šé“ã€‚ 
```python
import threading

# å…¨å±€è¿æ¥å’Œé”
rabbit_conn = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel_lock = threading.Lock()
# æ¥ä¸‹æ¥ä½¿ç”¨ threading åˆ›å»ºçš„éƒ¨åˆ†å°±æ˜¯å®‰å…¨çš„ï¼Œ ä½†æ˜¯åœ¨é«˜å¹¶å‘ä¸‹å¾€å¾€ä¼šäº§ç”Ÿé—®é¢˜
```

#### 2. åŸºäºçº¿ç¨‹æ± åˆ†é…çš„è§£å†³æ–¹æ¡ˆ  
å› ä¸º RabbitMQ çš„ TCP è¿æ¥æ˜¯å¾ˆæ˜‚è´µçš„æ“ä½œ,    ä¸ºäº†å¹³è¡¡å¹¶å‘æ€§å’Œæ€§èƒ½å¼€é”€ï¼Œ å¯ä»¥ä½¿ç”¨è¿æ¥æ± ç®¡ç†å¤šä¸ªè¿æ¥ï¼ŒæŒ‰éœ€åˆ†é…è¿æ¥ç»™çº¿ç¨‹; 

```python
class RabbitMQConnPool:  
    def __init__(self, max_conn=10):  
        self.max_conn = max_conn  
        self.pool = Queue(maxsize=max_conn)  
        for i in range(max_conn):  
            conn = pika.BlockingConnection(  
                pika.ConnectionParameters('localhost')  # RabbitMQ server IP address  
            )  
            self.pool.put(conn)  
  
    def get_conn(self):  
        if self.pool.empty():  
            system_logger.warn("Connection pool is empty. Connection limit reached.")  
            raise RuntimeError("Connection pool is empty. No connections available.")  
        return self.pool.get()  
  
    def release_conn(self, conn):  
        self.pool.put(conn)
```

ä½¿ç”¨ä¸€ä¸ª ï¼Œ æ¯æ¬¡æœåŠ¡,  éœ€è¦åˆ›å»ºä¸€ä¸ª transaction å¯¹è±¡ï¼Œ å¤šä¸ªå®¢æˆ·ç«¯ï¼Œæ¯æ¬¡åˆ›å»ºçš„ transaction å¯¹è±¡ä¸åŒ, å®é™…ä¸Šä¹Ÿæ˜¯ä½¿ç”¨ä¸åŒè¿æ¥æ± çš„ï¼Œå› æ­¤ä¸ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜ 

### (3) çº¿ç¨‹é”æœºåˆ¶è¯´æ˜
ä½†æ˜¯è€ƒè™‘åˆ° channel çº¿ç¨‹ä¸å®‰å…¨æ—¶ä¼šå‘ç”Ÿä¸å¯é¢„æ–™æ“ä½œï¼Œ  å› æ­¤ä»ç„¶å¯ä»¥è€ƒè™‘ç”¨ `channel_lock` è¿›è¡Œä¸€ä¸ªå…œåº•æ“ä½œï¼Œ å³ä½¿å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶åˆ›å»ºÂ `transaction`Â å¯¹è±¡ï¼Œä¹Ÿèƒ½ä¿è¯Â `channel`Â çš„åˆ›å»ºæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ åŒæ—¶é è¿æ¥æ± çš„æ–¹æ³•ï¼Œ ä»¥åº”å¯¹é«˜å¹¶å‘çš„æœºåˆ¶ã€‚ 

éœ€è¦è¯´æ˜, ==å¦‚æœåç»­æœ‰å…¶ä»–æ“ä½œï¼ˆå¦‚Â `prepare`ã€`commit`ã€`rollback`ï¼‰éœ€è¦è®¿é—®Â `self.channel`ï¼Œä¹Ÿéœ€è¦åŠ é”==ã€‚ä¾‹å¦‚: 
```python
 with self.channel_lock: 
	  self.channel.basic_publish(
            exchange='',
            routing_key=self.queue,
            body=data_str,
            properties=pika.BasicProperties(
                delivery_mode=TwoPC_DELIVERY_MODE,
                headers={
                    '__type__': Base2PCStatus.PREPARE.value,
                }
            ),
            mandatory=True,
        )
```

åŸºäº Threading.Lock çš„è¶…æ—¶æœºåˆ¶è®¾ç½® : 
ç”±äºæ˜¯å¤šçº¿ç¨‹è¿è¡Œç¯å¢ƒï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œçº¿ç¨‹é”æ—¶ï¼Œ ä¸ºäº†åº”å¯¹é«˜å¹¶å‘åœºæ™¯ï¼Œ åº”å½“è¿›è¡Œé”çš„è¶…æ—¶æœºåˆ¶è®¾ç½®ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `threading.semaphore` å®ç°è¶…æ—¶é”ï¼Œ å¯è‡ªå®šä¹‰ä¸€ä¸ªç±»å‹å¦‚ä¸‹: 
```python
class TimeoutLock:  
    def __init__(self):  
        # only 1 thread can acquire the lock at a time.  
        self._semaphore = threading.Semaphore(1)  
  
    def acquire(self, timeout=None):  
        if not self._semaphore.acquire(timeout=timeout):  
            raise TimeoutError("Failed to acquire lock")  
        return True  
  
    def release(self):  
        self._semaphore.release()
```

**ä½¿ç”¨å’Œè·å–éé˜»å¡é”** 
ä¸€èˆ¬é™¤äº†è¶…æ—¶é”ï¼Œ ç”¨çš„æ›´åŠ å¹¿æ³›çš„è¿˜æœ‰éé˜»å¡é”, åŒæ—¶ä¸ºäº†èƒ½å¤Ÿåœ¨ with ä¸­ä½¿ç”¨ï¼Œ æˆ‘ä»¬ä¸€èˆ¬å®šä¹‰ `__enter__` å’Œ `__exit__`  æ–¹æ³•è¿›è¡Œè·å–ã€‚ 

ä½†æ˜¯ç”±äºæˆ‘ä»¬åœ¨å…³é—­æ—¶å¯èƒ½ä¹Ÿéœ€è¦åŠ é”ï¼Œ è€Œæ˜¾ç„¶æ— æ³•è·å–ä¼šç«‹å³é”™è¯¯ï¼Œ ä¸ç¬¦åˆéœ€æ±‚ï¼Œ é‚£ä¹ˆå®é™…å¯èƒ½ä¸éœ€è¦é”çš„æ“ä½œã€‚ 

### (4) å¼‚æ­¥ç¼–ç¨‹å’Œ Prepare ç»“æœçš„éé˜»å¡ç­‰å¾… 
Python æä¾›äº†Â `asyncio`Â åº“æ¥æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œ å¯¹äºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ asyncio ä»¥å®ç°<b><mark style="background: transparent; color: orange">éé˜»å¡å¼åœ°ç­‰å¾…æ“ä½œ</mark></b>ã€‚ å‚è€ƒ[[ğŸ“˜ClassNotes/âŒ¨ï¸Programming/ğŸPython/â›³Python è¿›é˜¶ä¸è½¯ä»¶æ¶æ„è®¾è®¡ç›¸å…³/8. Python å¼‚æ­¥ç¼–ç¨‹,   asyncio åº“ä¸ async, await è¯­æ³•|Python å¼‚æ­¥ç¼–ç¨‹,   asyncio åº“ä¸ async, await è¯­æ³•]]  

éœ€è¦è¯´æ˜: åœ¨ flask æ¡†æ¶ä¸­, `await`Â ä¸ä¼šé˜»å¡å…¶ä»–å®¢æˆ·ç«¯çš„æ“ä½œï¼Œå› ä¸ºÂ `asyncio`Â æ˜¯**åŸºäºäº‹ä»¶å¾ªç¯çš„å¼‚æ­¥æ¡†æ¶**ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æœ‰è‡ªå·±çš„åç¨‹ä¸Šä¸‹æ–‡ã€‚åªè¦äº‹ä»¶å¾ªç¯æ²¡æœ‰è¢«é˜»å¡ï¼Œå¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥å¹¶å‘æ‰§è¡Œã€‚ 

åŸºæœ¬çš„æ–°è¯­æ³•ä¸º : 
```python
import asyncio
async def prepare(self, data: dict) -> None: 
```


ayncio.run