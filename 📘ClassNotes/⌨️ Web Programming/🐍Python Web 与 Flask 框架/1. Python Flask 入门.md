[Flask å®˜æ–¹æ–‡æ¡£](https://flask.palletsprojects.com/en/stable/): Flask æ˜¯ä¸€ä¸ª<mark style="background: transparent; color: red">åŸºäº Werkzeug å’Œ Jinja2  çš„åç«¯æ¡†æ¶</mark>, ç±»ä¼¼çš„ Django ç­‰éƒ½æ˜¯å±äºåç«¯æ¡†æ¶ç±»å‹. 

æˆ‘ä»¬å¾€å¾€<b><mark style="background: transparent; color: orange">å¯ä»¥ä½¿ç”¨ Flask æä¾›çš„è·¯ç”±å’Œè§†å›¾åŠŸèƒ½æ¥æ¥å— HTTP è¯·æ±‚</mark></b>ï¼Œè¿”å› JSON æ•°æ®ã€‚Vue.js å¯ä»¥é€šè¿‡ Axios æˆ– Fetch API ä» Flask åç«¯è·å–è¿™äº›æ•°æ®ã€‚è¿™ç§æ–¹å¼é€šå¸¸ç”¨äºæ„å»ºå•é¡µé¢åº”ç”¨ï¼ˆSPAï¼‰

é¦–å…ˆå¯¹äº linux ä¸»æœºä¸Šçš„ python ç¯å¢ƒåˆ›å»º, å¯ä»¥é‡‡ç”¨:
```sh
python3 -m venv myvenv
cd myvenv
source ./bin/activate
deactivate   #  é€€å‡ºè™šæ‹Ÿç¯å¢ƒ
```

## ä¸€ã€ Flask å¼€å‘åŸºç¡€
### (1) åŸºæœ¬ Flask æ¡†æ¶ä¸è£…é¥°å™¨çš„ä½¿ç”¨
é¦–å…ˆ, å¯¹äºæœ€å°çš„ Flask æ¡†æ¶ç¨‹åºå¦‚ä¸‹:
```python
#coding = utf-8  
from flask import Flask  
  
app = Flask(__name__)  
  
@app.route('/')  
def hello_world():  
    return 'Hello World!'  
  
if __name__ == '__main__':  
    app.run(host='0.0.0.0', port=8080)
```

ä»£ç ä¸­ï¼Œ`@app.route('/')` æ˜¯ä¸€ä¸ª **è£…é¥°å™¨** çš„ä½¿ç”¨ã€‚å‚è€ƒ[[ğŸ“˜ClassNotes/âŒ¨ï¸Programming/ğŸPython/â›³Python è¿›é˜¶ä¸è½¯ä»¶æ¶æ„è®¾è®¡ç›¸å…³/2. Python é—­åŒ…å‡½æ•°, è£…é¥°å™¨|2. Python é—­åŒ…å‡½æ•°, è£…é¥°å™¨]]

### (2) Config ç›¸å…³åŸºæœ¬é…ç½®
å‚è€ƒ [flask.Config](https://flask.palletsprojects.com/en/stable/api/#flask.Config)  éƒ¨åˆ†ï¼Œå¯ä»¥é€šè¿‡ from_pyfile, from_object ç­‰ç­‰æ–¹æ³•   
ä¸€èˆ¬è€Œè¨€, å¯ä»¥ä» app.config è¿›è¡Œ app çš„ç›¸å…³é…ç½®, å…¶ä¸­ app.config æ˜¯ flask.config.Config çš„å®ä¾‹ã€‚

```python
app = Flask(__name__);
app.config['DEBUG'] = True;   #  è¿™ä¸ªæ˜¯é…ç½®çš„æ–¹æ³•1 
app.debug = True;
app.config.update(   # æ›´æ–°é…ç½®æ–¹æ³•, åˆ©ç”¨ config.update è¿›è¡Œ 
	DEBUG = True,
	SECRET_KEY = '...',
)
app.config.from_object("settings");  # é€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½

import settings
app.config.from_object(settings);  # ç›¸å…³ api, ç•¥å»

app.config.from_pyfile('yourconfig.cfg');   # è‡ªå®šä¹‰ä¸€ä¸ª config.json æ–‡ä»¶è¿›è¡Œé…ç½®
app.config.from_envvar('YOURAPPLICATION_SETTINGS');   # é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®, å®é™…ä¸Šè¦æ±‚æ˜¯æ–‡ä»¶è·¯å¾„  export YOURAPPLICATION_SETTINGS='/path/to/config/file'
```

å¦å¤–ä¹Ÿå¯ä»¥ä½¿ç”¨ app.debug è¿›è¡Œé…ç½®, å…·ä½“å¯ä»¥å‚è€ƒ[flash.config.ConfigAttribute](https://flask.palletsprojects.com/en/stable/config/), åŒ…å« DEBUG, TESTING ç­‰ç­‰, å®é™…ä¸Šå’Œ `app.config['DEBUG']` æ˜¯ç­‰ä»·çš„ã€‚

å¦‚æœéœ€è¦ä» toml æˆ–è€… json ä¸­è¯»å–é…ç½®,  åˆ™é‡‡ç”¨:
```python
import json
app.config.from_file("config.json", load=json.load)

import tomllib
app.config.from_file("config.toml", load=tomllib.load, text=False)

from_mapping(_mapping=None_,Â _**kwargs_)

app.config['IMAGE_STORE_TYPE'] = 'fs'
app.config['IMAGE_STORE_PATH'] = '/var/app/images'
app.config['IMAGE_STORE_BASE_URL'] = 'http://img.website.com'

# è·å–å…¶ä¸­æŸä¸ª NAMESPACE ä¸‹çš„é…ç½® 
image_store_config = app.config.get_namespace('IMAGE_STORE_')  
{    # å…¶ä¸­å¾—åˆ° image_store_config éƒ¨åˆ†ç±»ä¼¼å¦‚ä¸‹: 
    'type': 'fs',
    'path': '/var/app/images',
    'base_url': 'http://img.website.com'
}
```

### (3) åŠ¨æ€è·¯ç”±è§„åˆ™
Flask çš„è·¯ç”±è§„åˆ™æ˜¯åŸºäº Werkzeug çš„è·¯ç”±æ¨¡å—, éœ€è¦ä¿è¯å”¯ä¸€çš„ url, ä¾‹å¦‚, ç»“å°¾å¸¦ `/` çš„éƒ¨åˆ†å’Œä¸å¸¦çš„éƒ¨åˆ†åº”è¯¥æ˜¯ç›¸åŒçš„,  å› æ­¤éƒ½ä¼šè¢«é‡å®šå‘åˆ°å¸¦æœ‰ / çš„è·¯ç”±ä¸­. ä¾‹å¦‚ `/projects` è¢«é‡å®šå‘åˆ° `/projects/` éƒ¨åˆ†;

#### 1. Flask ä¸­çš„åŠ¨æ€è·¯ç”±è½¬æ¢å™¨
åœ¨ Flask ä¸­ï¼Œ**ç‰¹æ®Šå­—æ®µæ ‡è®°**å’Œ**è½¬æ¢å™¨**åŠŸèƒ½å¯ä»¥ç”¨äºæ„å»ºåŠ¨æ€è·¯ç”±(dynamic url)ï¼Œè¿™ä½¿å¾— URL æ›´åŠ çµæ´»å’ŒåŠŸèƒ½å¼ºå¤§ã€‚ä»¥ä¸‹æ˜¯å¯¹ Flask è·¯ç”±è½¬æ¢å™¨çš„è®²è§£ä»¥åŠç‰¹æ®Šå­—æ®µæ ‡è®°çš„è¯¦è§£ã€‚

å¯¹äºå¤åˆåŒç§è§„åˆ™çš„ url, å¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ª url æ¨¡å¼, å¾€å¾€ç”¨äºä¸åŒæ–‡ç« ç­‰ id çš„ç´¢å¼•éƒ¨åˆ†, å…·ä½“å¦‚ä¸‹:
```python
@app.route('/item1/1/')
@app.route('/item1/2/')
@app.route('/item1/3/')
# ä¸Šè¿°æ–¹æ³•å¯ä»¥é‡‡ç”¨: 
@app.route('/item/<id>')  # å°†å…¶ä¸­ id åŒ¹é…åˆ°çš„éƒ¨åˆ†ï¼Œä¼šä½œä¸ºå‚æ•°æ˜ å°„åˆ°ç›¸åº”çš„è·¯ç”±
def item(id):
	return '{id}'.format(id)
```
<b><mark style="background: transparent; color: orange">è½¬æ¢å™¨è¯­æ³•</mark></b>ä¸º `@app.route('/path/<converter:variable_name>/')`, å…¶ä¸­:
- **`converter`**: è½¬æ¢å™¨åç§°ï¼Œå®šä¹‰å˜é‡çš„ç±»å‹æˆ–è§„åˆ™ã€‚
- **`variable_name`**: å˜é‡åï¼Œå¯ä»¥åœ¨è§†å›¾å‡½æ•°ä¸­ä½¿ç”¨ã€‚
æ”¯æŒçš„è½¬æ¢å™¨ç±»å‹å¦‚ä¸‹:

| è½¬æ¢å™¨åç§°      | æè¿°                                    | ç¤ºä¾‹                         |
| ---------- | ------------------------------------- | -------------------------- |
| **string** | é»˜è®¤ç±»å‹ï¼ŒåŒ¹é…ä»»æ„ä¸åŒ…å«æ–œæ  `/` çš„æ–‡æœ¬ã€‚               | `/user/<string:username>/` |
| **int**    | åŒ¹é…æ­£æ•´æ•°ï¼Œè§†å›¾å‡½æ•°ä¸­ä¼šå°†å€¼è½¬æ¢ä¸º `int` ç±»å‹ã€‚           | `/order/<int:order_id>/`   |
| **float**  | åŒ¹é…æµ®ç‚¹æ•°ï¼Œè§†å›¾å‡½æ•°ä¸­ä¼šå°†å€¼è½¬æ¢ä¸º `float` ç±»å‹ã€‚         | `/price/<float:amount>/`   |
| **path**   | åŒ¹é…ä»»æ„æ–‡æœ¬ï¼ˆåŒ…æ‹¬æ–œæ  `/`ï¼‰ï¼Œé€‚åˆå¤„ç†è·¯å¾„ã€‚              | `/file/<path:filepath>/`   |
| **uuid**   | åŒ¹é…æœ‰æ•ˆçš„ UUID å­—ç¬¦ä¸²ï¼Œè§†å›¾å‡½æ•°ä¸­ä¼šå°†å€¼è½¬æ¢ä¸º `UUID` å¯¹è±¡ã€‚ | `/user/<uuid:user_id>/`    |
é€šè¿‡å¦‚ä¸‹çš„å¤šä¸ªæ–¹æ³•å®šä¹‰, å®é™…ä¸Šå°±å¯ä»¥å®ç°é€šè¿‡ç”¨æˆ·è®¿é—®ä¸åŒçš„è·¯ç”±ï¼Œå®é™…ä¼ é€’å‡ºä¸åŒçš„å‚æ•°, è¿›è€Œé€šè¿‡è®¿é—®åç«¯æ•°æ®åº“åŠ è½½å‡ºå¯¹åº”çš„ç•Œé¢ã€‚ 
```python
#  any çš„ä½¿ç”¨ç¤ºä¾‹(æ¥å—ä¸€ç»„å¯æ¥å—çš„å€¼) 
@app.route('/<any(a, b, c):page_name>/')
def handle_page(page_name):
    return f"Page: {page_name}"
#- è·¯ç”± `/home/` åŒ¹é…ï¼Œ`page_name` çš„å€¼ä¸º `"home"`ã€‚
#- è·¯ç”± `/about/` åŒ¹é…ï¼Œ`page_name` çš„å€¼ä¸º `"about"`ã€‚
#- è·¯ç”± `/contact/` åŒ¹é…ï¼Œ`page_name` çš„å€¼ä¸º `"contact"`ã€‚

# è·¯ç”± `/file/uploads/images/` åŒ¹é…ï¼Œ`filepath` çš„å€¼ä¸º `"uploads/images"`
@app.route('/file/<path:filepath>/')
def file(filepath):
    return f"File Path: {filepath}"

@app.route('/order/<int:order_id>/')
def order(order_id):
    return f"Order ID: {order_id}"
# è·¯ç”± `/order/123/` åŒ¹é…ï¼Œ`order_id` çš„å€¼ä¸º `123`ï¼ˆæ•´æ•°ï¼‰ã€‚

@app.route('/user/<uuid:user_id>/')
def user(user_id):
    return f"User ID: {user_id}"
#è·¯ç”± `/user/550e8400-e29b-41d4-a716-446655440000/` åŒ¹é…ï¼Œ`user_id` çš„å€¼ä¸º `UUID('550e8400-e29b-41d4-a716-446655440000')`ã€‚

@app.route('/user/<string:username>/')
def user_profile(username):
    return f"User: {username}"
# è·¯ç”± `/user/john/` åŒ¹é…ï¼Œ`username` çš„å€¼ä¸º `"john"`ã€‚
```

éœ€è¦è¯´æ˜:
1. **é¡ºåºåŒ¹é…**  
   Flask <mark style="background: transparent; color: red">æŒ‰æ³¨å†Œè·¯ç”±çš„é¡ºåºè¿›è¡ŒåŒ¹é…</mark>ã€‚<b><mark style="background: transparent; color: orange">åŠ¨æ€è·¯ç”±å¯èƒ½ä¼šè¢«æ›´å…·ä½“çš„è·¯ç”±è¦†ç›–</mark></b>ã€‚
   ```python
   @app.route('/user/<int:id>/')
   @app.route('/user/all/')
   ```
   è®¿é—® `/user/all/` ä¼šä¼˜å…ˆåŒ¹é…ç¬¬äºŒä¸ªè·¯ç”±ã€‚
2. **é»˜è®¤ç±»å‹ä¸º `string`**  
   å¦‚æœæœªæŒ‡å®šè½¬æ¢å™¨ï¼Œåˆ™å˜é‡é»˜è®¤ç±»å‹ä¸º `string`ã€‚
3. **æ•è·æœªåŒ¹é…çš„è·¯ç”±** 
   ä½¿ç”¨è½¬æ¢å™¨æ—¶ï¼Œå¦‚æœ URL ä¸ç¬¦åˆè§„åˆ™ï¼ŒFlask ä¼šè¿”å› 404 é”™è¯¯ã€‚

ä¾‹å¦‚ä¹Ÿå¯ä»¥å¦‚ä¸‹æ–¹æ³•, ç»“åˆå¤šä¸ªè½¬æ¢å™¨:
```python
@app.route('/blog/<int:year>/<string:title>/')
def blog(year, title):
    return f"Blog {year}: {title}"
```
- è·¯ç”± `/blog/2024/python-tutorial/` åŒ¹é…ï¼š
- `year` ä¸º `2024`ï¼ˆæ•´æ•°ï¼‰ã€‚
- `title` ä¸º `"python-tutorial"`ã€‚

#### 2. è‡ªå®šä¹‰è·¯ç”±è½¬æ¢å™¨ 
å¯¹äºæœç´¢å…³é”®è¯ç­‰ç­‰æ–¹é¢, æˆ‘ä»¬å¾€å¾€éœ€è¦é‡‡ç”¨ search = "topic1+topic2"è¿›è¡Œåˆ†å‰²è·¯ç”±, æˆ–è€… & åˆ†å‰²è·¯ç”±; 

é¦–å…ˆè‡ªå®šä¹‰ç†ç”±è½¬æ¢å™¨éœ€è¦ç»§æ‰¿è‡ª werkzeug.routing çš„ BaseConverter éƒ¨åˆ†, åŒæ—¶<mark style="background: transparent; color: red">éœ€è¦è®¾ç½® to_python å’Œ to_url ä¸¤ä¸ªæ–¹æ³•</mark>; å…¶ä¸­å¯ä»¥æŒ‰éœ€è¿›è¡Œå®ç°  (å¦‚æœå¯¹å‚æ•°è¿›è¡Œç‰¹æ®Šè§£æ, éªŒè¯ç­‰ç­‰, åˆ™å¿…é¡»å¯¹ to_python è¿›è¡Œå®šä¹‰, å¦‚æœéœ€è¦å¯¹è·¯ç”±å‚æ•°è¿›è¡Œç‰¹æ®Šçš„åºåˆ—åŒ–æˆ–æ ¼å¼åŒ–ï¼ˆå¦‚æ‹¼æ¥å­—ç¬¦ä¸²ã€è½¬ä¹‰å­—ç¬¦ç­‰ï¼‰ï¼Œåˆ™å¿…é¡»å®šä¹‰ to_url)
```python
import typing as t
from werkzeug.routing import BaseConverter

class dynamic_router(BaseConverter):  
    def __init__(self, url_map, sep):  
        super(dynamic_router, self).__init__(url_map)  
        # self.regex = reg   # The Regulation  of the URL  
        self.separator = sep  
	# ç”¨æˆ·è®¿é—®è·¯ç”±æ—¶ï¼ŒFlask ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œå°† URL å‚æ•°è½¬åŒ–åä¼ é€’ç»™è§†å›¾å‡½æ•°ã€‚
	def to_python(self, value):
	    return value.split(self.separator)  # åˆ†å‰²å­—ç¬¦ä¸²æˆåˆ—è¡¨
	# ä½¿ç”¨ Flask çš„ `url_for()` å‡½æ•°ç”Ÿæˆ URL æ—¶è°ƒç”¨ 
    def to_url(self, values: t.Any) -> str:  
        return self.separator.join( BaseConverter.to_url(value) for value in values)  

app.url_map.converters['dynamic'] = dynamic_router   # ç›´æ¥åœ¨ Flask åº”ç”¨çš„ `url_map.converters` å­—å…¸ä¸­æ³¨å†Œäº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ URL è½¬æ¢å™¨ `dynamic_router`ï¼Œå¹¶å°†å…¶åç§°è®¾ä¸º `'dynamic'`
# app.add_url_rule('/<dynamic:dynamic>', view_func=hello_world)   ç›´æ¥åœ¨ Flask åº”ç”¨çš„ `url_map.converters` å­—å…¸ä¸­æ³¨å†Œäº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ URL è½¬æ¢å™¨ `dynamic_router`ï¼Œå¹¶å°†å…¶åç§°è®¾ä¸º `'dynamic'`, 
# ç¬¬äºŒå¥å®é™…ä¸Šåˆ›å»ºäº†ä¸€ä¸ªå…·ä½“çš„è·¯ç”±ï¼Œå¦‚ `/value1,value2/`ï¼Œå¹¶å°†è¯·æ±‚åˆ†æ´¾ç»™ `hello_world`ã€‚
```

ä¸€ä¸ªæ›´åŠ å®Œæ•´çš„å®ç°ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤º:
```python
from flask import Flask, url_for
from werkzeug.routing import BaseConverter

class DynamicListConverter(BaseConverter):
    def __init__(self, url_map, separator=','):
        super(DynamicListConverter, self).__init__(url_map)
        self.separator = separator

    def to_python(self, value):
        # å°† URL ä¸­çš„å€¼è§£æä¸ºåˆ—è¡¨
        return value.split(self.separator)

    def to_url(self, values):
        # å°†åˆ—è¡¨è½¬æ¢ä¸º URL å¯ç”¨çš„å­—ç¬¦ä¸²
        return self.separator.join(map(str, values))

app = Flask(__name__)
app.url_map.converters['list'] = DynamicListConverter

@app.route('/items/<list:values>/')
def show_items(values):
    return f"Values: {values}"   # ç”¨äºè®¿é—®æ—¶è§£æåˆ†éš”ç¬¦åˆ†å‰²çš„ url éƒ¨åˆ†

@app.route('/generate_url/')
def generate_url():
    url = url_for('show_items', values=[1, 2, 3])   # url_for è°ƒç”¨ to_url æ–¹æ³•, æ ¹æ®å‚æ•°ç”Ÿæˆ url 
    return f"Generated URL: {url}"

if __name__ == "__main__":
    app.run(debug=True)
```

#### 3.  è·¯ç”±å’Œé™æ€æ–‡ä»¶ç®¡ç†
å¯¹äºä¸€èˆ¬ web åº”ç”¨, å¾€å¾€ä¼šæä¾›é™æ€æ–‡ä»¶æœåŠ¡, ä¸»è¦åŒ…å« css æ ·å¼æ–‡ä»¶, JavaScript è„šæœ¬æ–‡ä»¶, å›¾ç‰‡å’Œå­—ä½“ç­‰ç­‰é™æ€èµ„æºæ–‡ä»¶ç­‰ç­‰; å¯¹äº Flask ä¹Ÿæ”¯æŒé™æ€æ–‡ä»¶è®¿é—®, <mark style="background: transparent; color: red">é¦–å…ˆéœ€è¦åœ¨é¡¹ç›®ä¸‹åˆ›å»º /static ç›®å½•</mark>, å¹¶é‡‡ç”¨ `/static` å¼€å¤´è®¿é—®ï¼Œ ä½†æ˜¯ä¸€èˆ¬æ›´å¤šé‡‡ç”¨ Nginx å’Œ Web æœåŠ¡å™¨ç­‰ç­‰ç®¡ç†é™æ€æ–‡ä»¶ã€‚

å®é™…ä¸Šé»˜è®¤çš„é™æ€æ–‡ä»¶å¤¹æ˜¯ /static , ä¹Ÿå¯ä»¥åœ¨ app ä¸­æŒ‡å®š:

å¸¸è§çš„å…¶ä»–æœ‰ templatefolder = ./template ç­‰ç­‰

```python
app = Flask(__name__, static_folder = '/temp')   
url_for('static', filename='style.css')
# æ­¤æ—¶å¯ä»¥é€šè¿‡è®¿é—® localhost:xxx/static/style.css ç›´æ¥è®¿é—®é™æ€æ–‡ä»¶ç›®å½•, url_for ä¹Ÿæ˜¯ç”Ÿæˆè¿™ä¸ªè·¯å¾„
```

### (4) Http æ–¹æ³•, url æ„é€ ï¼Œè·³è½¬å’Œé‡å®šå‘
#### 1. Http æ–¹æ³•ç®€ä»‹
HTTP æ–¹æ³•åŒ…æ‹¬å¦‚ä¸‹å‡ ç§(å¹‚ç­‰è¡¨ç¤ºç›¸åŒæ•°æ®ï¼Œå‚æ•°ä¸‹ï¼Œ æ‰§è¡Œä¸€æˆ–è€…å¤šæ¬¡æ•ˆæœæ˜¯ç›¸åŒçš„):
1. GET : ç”¨äºè·å–èµ„æº (æ˜¯å¹‚ç­‰çš„)
2. HEAD : æƒ³è·å–ä¿¡æ¯
3. POST åˆ›å»ºä¸€ä¸ªæ–°çš„èµ„æº 
4. PUT : å®Œæ•´åœ°æ›¿æ¢èµ„æºæˆ–è€…åˆ›å»ºèµ„æº(æœ‰å‰¯ä½œç”¨, ä½†æ˜¯æ˜¯å¹‚ç­‰çš„)
5. DELETE: åˆ é™¤èµ„æº, æœ‰å‰¯ä½œç”¨ , ä½†æ˜¯æ˜¯å¹‚ç­‰çš„, 
6. OPTIONS : è·å–èµ„æºæ”¯æŒçš„æ‰€æœ‰ HTTP æ–¹æ³•  
7. PATCH :  å±€éƒ¨æ›´æ–°,  ä¿®æ”¹æŸä¸ªå·²æœ‰çš„èµ„æº

é»˜è®¤æƒ…å†µä¸‹, è·¯ç”±ä»…å›åº” GET è¯·æ±‚, è€Œé€šè¿‡ app.route ä¼ é€’ methodså‚æ•°å¯ä»¥æ”¹å˜è¯¥è¡Œä¸º:
```python 
@app.route('/login', methods=['GET','POST'])
```
å…¶ä¸­å¦‚æœå­˜åœ¨ GET, ä¹Ÿä¼šè‡ªåŠ¨æ·»åŠ  HEAD æ–¹æ³•, ä» Flask 0.6 å¼€å§‹ä¹Ÿå®ç°äº† OPTIONS  çš„è‡ªåŠ¨å¤„ç†.

è¯·æ±‚å¤´æ•°æ®å¯ä»¥é‡‡ç”¨ request.headers.get è¿›è¡Œè·å–.

#### 2. é‡‡ç”¨ url_for æ„é€  url
```python
from flask import Flask,url_for 
app = Flask(__name__)
@app.route('/item/1')
def item(id):
	pass  
	
with app.test_request_context():
	print(url_for('item', id='1'))     # äº§ç”Ÿ /item/1/?id  = 1
	print(url_for('item', id=2,next ='/'))  # äº§ç”Ÿ /item   
```

éœ€è¦è¯´æ˜, å¯¹äºurl æ„å»º, ä¸€èˆ¬é€‰ç”¨é‡‡ç”¨ url_for æ„å»ºçš„æ–¹æ¡ˆ, è€Œä¸é‡‡ç”¨è½¬ä¹‰å­—ç¬¦ä¸²æ–¹æ¡ˆ, å¹¶è‡ªåŠ¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ä»¥åŠ Unicode æ•°æ®ç­‰ç­‰ã€‚æ›´åŠ æ–¹ä¾¿. <mark style="background: transparent; color: red">éœ€è¦è¯´æ˜,  ä¸€èˆ¬ url_for å†…çš„éƒ¨åˆ†ä¼šæ‹¼æ¥èµ·æ¥, è€Œå¦‚æœæ˜¯è¯·æ±‚, åˆ™ä¼šç”¨  ? æ‹¼æ¥èµ·æ¥</mark>

#### 3. flask ä¸­çš„é‡å®šå‘
åœ¨ flask ä¸­, é€šè¿‡ flask.redirect è¿›è¡Œé‡å®šå‘, é»˜è®¤é‡å®šå‘æ˜¯ 302  
```python
flask.redirect(location);   # å®é™…ä¸Šé»˜è®¤çŠ¶æ€ç æ˜¯ 302
flask.redirect(location, code=303)  # å¯æŒ‡å®šçŠ¶æ€ç (301, 303,305,307)
```

ä¾‹å¦‚, æŒ‡å®šå¤šä¸ªè·¯ç”±å’Œè¿›è¡Œé‡å®šå‘è®¾ç½®:
```python
#coding = utf-8  
import typing as t  
from flask import Flask, request, abort, redirect, url_for  
import urllib  
from werkzeug.routing import BaseConverter  
  
app = Flask(__name__)  
  
@app.route('/hello')  
def hello_world():  
    name = request.args.get('name')   # è·å–è¯·æ±‚ä¸­ name éƒ¨åˆ† çš„å€¼ (å®é™…ä¸Šæ˜¯åœ¨)  
    if name is None:  
        name = 'Guest'  
    print("get name:", name)  
    return f'Hello World,{name}'  
  
# è®¿é—® http://127.0.0.1:8080/people?name=123 -> é‡å®šå‘åˆ° hello world å¹¶ä¼ é€’è¯·æ±‚å‚æ•°  
@app.route('/people')  
def people():  
    _name = request.args.get('name')   # è·å–è¯·æ±‚ä¸­ name éƒ¨åˆ† çš„å€¼ (å®é™…ä¸Šæ˜¯åœ¨)  
    return redirect(url_for('hello_world', name=_name))   # æ„é€ è¯·æ±‚å¹¶é‡å®šå‘(å…¶ä¸­nameä¼šä½œä¸º request å‚æ•°ç›´æ¥è¢«  request get åˆ°)  
    # url_for å¯ä»¥æŒ‡å®šä¸€ä¸ªå…¶ä»–çš„å‡½æ•°è¿›è¡Œé‡å®šå‘(å¦‚æœæ˜¯åœ¨ url_for ä¸­æŒ‡å®š, åˆ™ç±»ä¼¼äºä¼ å…¥å‚æ•° name = _name)

@app.route('/secret')  
def secret():  
    abort(404)   # å¼¹å‡º 404 Not Found ç•Œé¢  

@app.route('login', method=['GET', 'POST'])  
def login():  
    if request.method == 'POST':  
        user_id = request.form.get('user_id')    # è°ƒç”¨ request.form.get è·å–è¡¨å•æ•°æ®  
        user_agent = request.headers.get('User-Agent')  # è°ƒç”¨ request.headers.get è·å–è¯·æ±‚å¤´æ•°æ® (æ³¨æ„: è¯·æ±‚å¤´æ•°æ®æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„)  
        return f'user: {user_id}'  
    else:  
        abort(404)  
    return 'login'
  
if __name__ == '__main__':  
    app.run(host='0.0.0.0', port=8080)
```

ä¹Ÿå¯ä»¥è¿™æ ·, ä½†æ˜¯æ­¤æ—¶ name ä¼šä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’, è€Œä¸æ˜¯ä½œä¸ºè¯·æ±‚å‚æ•°æ·»åŠ è¿›å»(å¦‚æœæœ‰åˆ™ä¼ å‚, æ²¡æœ‰åˆ™ä½œä¸º request æ‹¼æ¥)
```python
@app.route('/hello/<name>')
def hello_world(name):
    return f'Hello, {name}!'
@app.route('/redirect-to-hello')
def redirect_to_hello():
    return redirect(url_for('hello_world', name='Alice'))
```

#### 4. HTTP ä¸­çš„ Request è¯·æ±‚å’Œ Response å“åº”å¯¹è±¡
å¯¹äº Request éƒ¨åˆ†,  æœ€å¤šç”¨çš„æ–¹æ³•æœ‰ GET å’Œ POST, å…¶ä¸­ä½¿ç”¨æµè§ˆå™¨è®¿é—®, é»˜è®¤é‡‡ç”¨çš„è¯·æ±‚æ–¹æ³•æ˜¯ GET è€Œä¸æ˜¯  POST,  å³è®¿é—®é¡µé¢é»˜è®¤é‡‡ç”¨ GET è®¿é—®ã€‚
```python
@app.route('/testlink', methods=['GET','POST'])  
def testlink():
	if request.method == 
```
ä½†æ˜¯, å½“é‡‡ç”¨æäº¤è¡¨å•çš„æƒ…å†µä¸‹ï¼Œ å‘é€çš„æ˜¯ POST è¯·æ±‚. 

Response å“åº”è¯¦è§£
å¯¹äºè§†å›¾å‡½æ•°(ä¸Šé¢æ‰€å®šä¹‰ app.route éƒ¨åˆ†ç­‰ç­‰), ä¼šè½¬æ¢ä¸ºä¸€ä¸ªå“åº”å¯¹è±¡, å¹¶ä»è§†å›¾ç›´æ¥è¿”å›.
1. Return a **String**
When a view function returns a string, Flask automatically treats it as the response body, which is sent back to the client as the content of the response 
```python
@app.route('/') 
def hello_world(): 
	return 'Hello, World!'
```
(This is equivalent to returning `Response('Hello, World!')`, where Flask sets the status code to `200 OK` by default.)

2. Returning a **Tuple**
When a view function returns a tuple, Flask interprets the tuple in a specific way. The tuple can contain:

- The **response body** (such as a string or a list of headers),
- The **status code** (optional),
- The **headers** (optional).
The typical structure of the tuple is:
```python
@app.route('/custom_response_with_headers')
def custom_response_with_headers():
    return 'Custom Response', 200, {'X-Custom-Header': 'Some value'}
```

- Explanation of the Tuple Return Type
**First element** (`return_value`): The body of the response. This can be a string, HTML content, or JSON data, among other things.
**Second element** (optional, `status_code`): The HTTP status code of the response. If not provided, Flask defaults to `200 OK`.
**Third element** (optional, `headers`): A dictionary of headers you want to add to the response.

3. **JSON objects** (Flask will automatically convert them to a JSON response):
  ```python
  from flask import jsonify
  @app.route('/json')
  def json_response():
      return jsonify({'message': 'Hello, JSON!'})
  ```

4. **Response objects** (you can directly create a `Response` object for more control):
  ```python
  from flask import Response
  @app.route('/custom_response_object')
  def custom_response_object():
      return Response('Custom Response Body', status=200, headers={'X-Custom': 'Header'})
  ```

ä¸€èˆ¬å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²æˆ–è€…å…ƒç»„, Flask ä¼šå‡è®¾æ˜¯ä¸€ä¸ªåˆæ³•çš„ WSGI åº”ç”¨ç¨‹åº, å¹¶é€šè¿‡ Response.force_type(rv, request.environ) è¿›è¡Œè½¬æ¢ä¸ºè¯·æ±‚å¯¹è±¡. 

å¦å¤–, å¯ä»¥é‡‡ç”¨ make_response  çš„æ–¹æ³• 
```python
from flask import  make_response, 

@app.errorhandler(404)
def not_found(err):
	resp = make_response(
		render_template("eroor.html", 404)
	)
	return resp
```


```python
from flask import Flask, jsonify, request

app = Flask(__name__)

# Sample data to return in JSON format
data = {
    'message': 'Welcome to Flask!',
    'status': 'success',
    'items': [
        {'id': 1, 'name': 'Item 1'},
        {'id': 2, 'name': 'Item 2'},
        {'id': 3, 'name': 'Item 3'}
    ]
}

# Endpoint that returns a JSON response
# curl http://127.0.0.1:5000/api/data  -> get the reponse 
@app.route('/api/data', methods=['GET'])
def get_data():
    return jsonify(data)

# Endpoint that receives JSON and returns a response
# curl -X POST -H "Content-Type: application/json" -d '{"user": "Alice", "action": "login"}' http://127.0.0.1:5000/api/data  
@app.route('/api/data', methods=['POST'])
def post_data():
    # Get the JSON data sent in the request body
    received_data = request.get_json()
    
    # Process data (here, just echoing it back for demonstration)
    return jsonify({
        'message': 'Data received',
        'received_data': received_data
    }), 200  # HTTP 200 OK

if __name__ == '__main__':
    app.run(debug=True)
```

ç”±äº request çš„ä¸Šä¸‹æ–‡åœ¨æœåŠ¡å™¨ä¸Šå¼€å§‹æ—¶ä¼šæ¶ˆå¤±æ¥ä¿è¯æ€§èƒ½, 
å¦‚æœéœ€è¦åœ¨ streamed_responses ä¸­è®¿é—®æŸä¸ª  request.args, å¿…é¡»æŒ‡å®š streamed_with_context è£…é¥°å™¨, å…·ä½“å¦‚ä¸‹:
```python
from flask import stream_with_context, request, Response

@app.route('/stream')
def streamed_response():
    @stream_with_context
    def generate():
        yield 'Hello '
        yield request.args['name']
        yield '!'
    return Response(generate())
```

### (5) Flask æ ¸å¿ƒä¾èµ–éƒ¨åˆ†
#### 1. WSGI å·¥å…· Werkzeug 
Flask æ˜¯ä¸€ä¸ª<mark style="background: transparent; color: red">åŸºäº Werkzeug å’Œ Jinja2 çš„å¾®æ¡†æ¶</mark>ã€‚
- Werkzeug æä¾›äº† Flask çš„ WSGI (Web Server Gateway Interface) å·¥å…·ï¼ŒåŒ…æ‹¬è¯·æ±‚ã€å“åº”å¤„ç†å’Œè·¯ç”±æœºåˆ¶ã€‚
- Flask ä¸­è®¸å¤šåº•å±‚åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ Werkzeug å®ç°çš„ï¼Œä¾‹å¦‚ï¼š
  - è¯·æ±‚å’Œå“åº”å¯¹è±¡ (`Request` å’Œ `Response`)
  - URL è·¯ç”±åŒ¹é…
  - å¼‚å¸¸å¤„ç†å’Œè°ƒè¯•å™¨
  - ä¸­é—´ä»¶æ”¯æŒ
WerkZeug æ˜¯ä¸€ä¸ª WSGI (Web Server Gateway Interface) ç½‘ç»œåº”ç”¨ç¨‹åºåº“, æä¾›äº†åº•å±‚ HTTP åŠŸèƒ½å’Œå·¥å…·ã€‚æä¾›ä»¥ä¸‹çš„åŠŸèƒ½ : 
  - è¯·æ±‚/å“åº”å°è£…
  - URL è·¯ç”±è§£æ
  - HTTP ä¸­é—´ä»¶
#### 2. æ¨¡æ¿ç³»ç»Ÿ Jinja2 
æœ€å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹æ¨¡æ¿ç³»ç»Ÿæ˜¯ Jinja2 å’Œ  Mako, è€Œ Flask ä»¥
å¯¹äº jinja2 éƒ¨åˆ†,  å¯ä»¥é‡‡ç”¨å¦‚ä¸‹è¿›è¡Œæ¨¡æ¿æ¸²æŸ“ 
```python
from jinja2 import Template, Environment  
  
template = Template("Hello, {{name}}!")  
print(template.render(name="123"))  
  
# ä¹Ÿå¯ä»¥é‡‡ç”¨ä¸‹é¢éƒ¨åˆ†è¿›è¡Œå®ç°:  
env = Environment()  
template = env.from_string("Hello, {{name}}!")  
template.render(namee="123")  

# å…¶ä¸­, Environment()æ˜¯jinja2çš„æ¨¡æ¿ç¯å¢ƒ, from_string()åˆ™æ˜¯ä»å­—ç¬¦ä¸²ä¸­åˆ›å»ºæ¨¡æ¿, render()åˆ™æ˜¯æ¸²æŸ“æ¨¡æ¿  
# Environment å®ä¾‹ç”¨äºå­˜å‚¨é…ç½®å’Œå…¨å±€å¯¹è±¡, ä»¥åŠå¤„ç†å…¨å±€å˜é‡å’Œè¿‡æ»¤å™¨ç­‰
# ä»¥ä¸‹é¢ä¸€ä¸ªæ¨¡æ¿ä¸ºä¾‹, é‡‡ç”¨ template 
template  = env.get_template("./hello.html")
template.render(name="123")   # ä¼šè‡ªåŠ¨æ›¿æ¢å…¶ä¸­çš„æ•°æ®
```

å¯¹äº Vue å’Œå“åº” Flask æ¡†æ¶çš„ç»“åˆ, æˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨ç»Ÿä¸€è¿”å› Json æ•°æ®çš„æ–¹æ³•' 
**åç«¯è¿”å› JSON æ•°æ®**ï¼š
- ä½¿ç”¨ `jsonify()` å°†æ•°æ®ç»“æ„è½¬æ¢ä¸º JSON æ ¼å¼è¿”å›ã€‚
**å‰ç«¯é€šè¿‡ Axios è¯·æ±‚ API**:
Axios åº“æ˜¯ç”¨äºå‘èµ· è¯·æ±‚çš„ HTTPåº“ 
- `axios.get()` è·å–æ•°æ®ã€‚
- `axios.post()` æäº¤æ•°æ®ã€‚

å…¶ä¸­ä¸»è¦çš„å‡ ç§æ¸²æŸ“æ ‡è¯†ç¬¦:
1.  `{# ... #}`  æ¨¡æ¿æ³¨é‡Š 
2. `{% ... %}`  æ‰§è¡Œ for ç­‰å¾ªç¯è¯­å¥ 
3. `{{ ... }}`  è¡¨è¾¾å¼çš„ç»“æœè¾“å‡ºåˆ°æ¨¡æ¿ä¸Š

ä¾‹å¦‚ 
```html
<div>
<ul id ="nav-bar">
	{% for item in items %}
		<li> <a href="{{item.href}}">{{item.caption}}</a></li>
	{% endfor%}
</ul>
</div>
```

æ­¤å¤–,  é€šè¿‡  `{% block blk1 %}` `{% endblock %}`  ä»£ç å—å¯ä»¥å®šä¹‰å‡ºå¯ä»¥åœ¨å­æ¨¡æ¿é‡è½½çš„æ¨¡æ¿ã€‚ä¾‹å¦‚å¦‚ä¸‹çš„å†…å®¹ : 
```html title:base.html
<!DOCTYPE html>  
<html lang="zh">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>{% block title %}é»˜è®¤æ ‡é¢˜{% endblock %}</title>  
</head>  
<body>  
    <header>  
        <h1>æˆ‘çš„ç½‘ç«™</h1>  
    </header>  
    
    <main>  
        {% block content %}  
        <p>è¿™æ˜¯é»˜è®¤å†…å®¹ã€‚</p>  
        {% endblock %}  
    </main>  
    
    <footer>  
        <p>ç‰ˆæƒæ‰€æœ‰ &copy; 2024</p>  
    </footer>  
</body>  
</html>
```

å…¶ä¸­é»˜è®¤æ ‡é¢˜å’Œé»˜è®¤å†…å®¹å¯ä»¥è¿›è¡Œé‡è½½ï¼Œ ç¤ºä¾‹ä»£ç å¦‚ä¸‹: 
```html   title:index.html
{% extends "base.html" %}  

{% block title %}  
ä¸»é¡µ  
{% endblock %}  

{% block content %}  
    <h2>æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸»é¡µï¼</h2>  
    <p>è¿™é‡Œæ˜¯ä¸€äº›å…³äºæˆ‘çš„ä¿¡æ¯ã€‚</p>  
{% endblock %}
```
éœ€è¦è¯´æ˜çš„æ˜¯, å®é™…ä¸Šå¦‚æœå‰ç«¯é‡‡ç”¨ Vue æ¡†æ¶, åˆ™å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œé‡è½½
å¦å¤–è¿˜æœ‰å¦‚ä¸‹å…³é”®å­—ï¼Œ å‡å¯ä»¥é‡‡ç”¨åµŒå…¥ Html çš„ Python è¯­å¥ :
```python
{{ super() }}  #   è¡¨ç¤ºå…ˆä½¿ç”¨çˆ¶ç±»ä¸­çš„å†…å®¹,  å†åŸºäºæ­¤æ·»åŠ  CSS æ ·å¼ 
{{% set a = 1 %}}   # èµ‹å€¼è¯­å¥
{{import 'header.html'}}  #   åŒ…å«ä¸€ä¸ªæ¨¡æ¿ ï¼Œ æ·»åŠ å¯¹åº”å†…å®¹ 
```

```html
{% macro hello(name) %}     # å®šä¹‰å®æ¨¡æ¿
{endmacro} 

{% import  'base.html' as macro %} 
{% from 'base.html import  hello' %} 
```

## äºŒã€Flask è§†å›¾ç±»å‹
### (1) å³æ’è§†å›¾å’Œæ ‡å‡†è§†å›¾
æ ‡å‡†è§†å›¾å¿…é¡»ç»§æ‰¿è‡ª flask.views.View, åŒæ—¶<mark style="background: transparent; color: red">éœ€è¦è¿›è¡Œå®ç° dispatch_request</mark>, ç”¨äºè§£åŒ…å¯¹åº”çš„ request, å¹¶è¿”å›ç›¸åº”çš„ç•Œé¢

åœ¨ Python çš„ Flask æˆ–ç±»ä¼¼æ¡†æ¶ä¸­ï¼Œå½“ä½ ä½¿ç”¨ `**context` è§£åŒ…å­—å…¸ä¼ é€’å‚æ•°åˆ° `render_template` æ—¶ï¼Œ`context` ä¸­çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹éƒ½ä¼šä½œä¸ºæ¨¡æ¿ä¸­çš„å˜é‡å¯ç”¨ã€‚
```python
import flask  
from flask import Flask, request , render_template, abort  
from flask.views import View  
  
app =  Flask(__name__, template_folder='./templates')
  
class ViewPort1(View):  
    def dispatch_request(self):  
        if request.method == 'GET':  
            context = {  
                'name': 'John',  
                'age': 30  
            }  
            return self.render_template("Hello World", context)  
        else:  
            abort(404)  
  
    def render_template(self, template_name, context):  
        return render_template(self.get_template_name(), **context)  
  
    def get_template_name(self):  
        return 'view1.html'  
  
app.add_url_rule('/view1', view_func=ViewPort1.as_view('view1'))

if __name__ == "__main__" :  
    app.run(host='0.0.0.0', port=9000, debug=True)
```

é¦–å…ˆ, <mark style="background: transparent; color: red">éœ€è¦åœ¨é¡¹ç›®ä¸‹é¢å»ºç«‹ templates æ–‡ä»¶å¤¹</mark>, ä¸Šè¿°æ–¹æ³•ä¼šåœ¨è®¿é—® view1.html æ—¶, å¯¼èˆªåˆ° templates æ–‡ä»¶å¤¹ä¸‹çš„ view1.html æ–‡ä»¶, åŒæ—¶ä¼ å…¥å¯¹åº”çš„å‚æ•°. ä¾‹å¦‚ `./templates` ä¸‹, é‡‡ç”¨å¦‚ä¸‹çš„ html æ–‡ä»¶æ¥å—å‚æ•°:
```html
<!DOCTYPE html>  
<html lang="en">  
	<head>  
	  <meta charset="UTF-8">  
	  <title>Title</title>
	</head>  
	<body>  
	<h1> {{name}} </h1>  
	<p> {{age}} </p>  
	</body>  
</html>
```
![[attachments/Pasted image 20241119094515.png|250]]
æ­¤å¤–, å¦‚æœæƒ³åœ¨ Python ä»£ç ä¸­è®¿é—® `context` ä¸­çš„å˜é‡ï¼ˆä¾‹å¦‚åœ¨è§†å›¾é€»è¾‘ä¸­ï¼‰ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨å­—å…¸çš„æ–¹æ³•ï¼Œæ¯”å¦‚:
```python
some_value = context.get('some_key')
```
å¦å¤–ä¹Ÿå¯ä»¥å¾ªç¯æ¸²æŸ“:
```html
<ul>
	{% for item in items %}
		<li>Item: {{ item }}</li>
	{% endfor %}
</ul>
```
- `items` ä¼šè¢«ç”¨æ¥ç”Ÿæˆä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶ä¸­ `item` æ˜¯åœ¨ `for` å¾ªç¯ä¸­è®¿é—®æ¯ä¸ªå…ƒç´ ã€‚
### (2)  è°ƒåº¦æ–¹æ³•è§†å›¾å’Œ url è°ƒåº¦æ–¹æ³•çš„ç±»å°è£…
 flaskview.MethodView æ˜¯ä¸€ç§åŸºäºç±»çš„è§†å›¾  (Class-Based Views, CBV) ,  <b><mark style="background: transparent; color: orange">å®é™…ä¸Šæ˜¯å¯¹äºæ¯ä¸ª Http æ–¹æ³•, ä¼šæ‰§è¡Œä¸åŒçš„å‡½æ•°</mark></b>, ç›¸åº”çš„, <b><mark style="background: transparent; color: orange">åœ¨ç»§æ‰¿ MethodView æ‰€è·å¾—çš„è°ƒåº¦æ–¹æ³•è§†å›¾ä¸­</mark></b>, å¯ä»¥å®šä¹‰åŒ…æ‹¬ `get`, `post`, `put`, `delete` ç­‰ç­‰æ–¹æ³• (å‚è€ƒ[[#1. Http æ–¹æ³•ç®€ä»‹]]).

<b><mark style="background: transparent; color: orange">è°ƒåº¦æ–¹æ³•è§†å›¾ MethodView å…è®¸å°†è·¯ç”±å¤„ç†é€»è¾‘ç»„ç»‡åˆ°ç±»ä¸­ï¼Œè€Œä¸æ˜¯å‡½æ•°ï¼Œä»è€Œæ›´å®¹æ˜“ç®¡ç†å¤æ‚çš„åº”ç”¨é€»è¾‘</mark></b>ï¼Œå°¤å…¶æ˜¯éœ€è¦å¤„ç†å¤šç§ HTTP æ–¹æ³•æ—¶ã€‚ ä¾‹å¦‚ä¸€ä¸ªè·¯ç”±é™¤äº†GET, POST æ–¹æ³•ç­‰ç­‰, <mark style="background: transparent; color: red">å°±ä¸éœ€è¦é€šè¿‡å¤šä¸ª if åˆ¤æ–­æ–¹æ³•ï¼Œæé«˜å¯è¯»æ€§</mark>ï¼Œæä¾› RESTful é£æ ¼çš„è·¯ç”±æ”¯æŒ

åŒæ—¶, `MethodView` æ˜¯åŸºäºç±»çš„ï¼Œå¯ä»¥<mark style="background: transparent; color: red">åˆ©ç”¨ç±»ç»§æ‰¿å’Œç»„åˆæ¥å¤ç”¨ä»£ç ã€‚ä¹Ÿå¯ä»¥é€šè¿‡åŠ¨æ€ URL å‚æ•°ä¸ç±»è§†å›¾ç»“åˆ</mark>ï¼Œ å¯ä»¥ä¸ºç‰¹å®šæ–¹æ³•æ·»åŠ è£…é¥°å™¨æˆ–é’©å­ï¼Œè€Œä¸ä¼šå¹²æ‰°å…¶ä»–æ–¹æ³•ã€‚ä¾‹å¦‚ : 
```python
class UserAPI(MethodView):
    @require_auth
    def get(self):
        return "Protected GET"

    def post(self):
        return "Public POST"
```

ä¾‹å¦‚**é‡‡ç”¨å¦‚ä¸‹çš„è°ƒåº¦æ–¹æ³•è§†å›¾**, æœ€ç®€å•çš„é€»è¾‘æ˜¯ return jsonify, è€Œä¸‹é¢ç»™å‡ºäº†ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„æ•´ä½“æŒ‰ç…§decorator çš„éªŒè¯ç”¨æˆ·åå’Œå¯†ç çš„ç¤ºä¾‹,  æœ€ç»ˆé€šè¿‡  `app.add_url_rule(view_func=viewfun.as_view())` å°†è¿™äº›æ–¹æ³•ç»‘å®šåˆ°è·¯ç”±éƒ¨åˆ†ã€‚ 

```python
from flask import Flask, request, render_template, jsonify, session, redirect, url_for, g, abort  
from flask.views import MethodView  

app = Flask(__name__)  
app.secret_key = 'your_secret_key'  # Required for session management  

# Mock user database
users = {
    "john": "password123",  
    # Username: Password  
}

# Simulate a logged-in user by setting g.user  
@app.before_request  
def load_user():  
    g.user = session.get('user')

# Decorator for user authentication  
def user_required(f):  
    def decorator(*args, **kwargs):  
        if not g.user:  
            return jsonify({"error": "User not logged in"}), 403  # Use 403 Forbidden for not authenticated  
        return f(*args, **kwargs)  
    return decorator  

class UserAPI(MethodView):
    decorators = [user_required]
    def get(self, user_name, user_age):  
        return jsonify({  
            'name': user_name,  
            'age': user_age  
        })

@app.route('/login', methods=['GET', 'POST'])
def login():  
    if request.method == 'POST':
        username = request.form['username']   #  å®é™…ä¸Šæ˜¯è·å– login.html ä¸­çš„ usernameåå­—ä¸º username çš„ form 
        password = request.form['password']   #  è·å–è¡¨æ ¼ä¸­çš„ password éƒ¨åˆ†,

		# æ£€æŸ¥å¯¹åº”çš„å­—å…¸, æ£€æŸ¥loginå¯†ç æ˜¯å¦åœ¨æ•°æ®åº“ä¸­
        if username in users and users[username] == password:    
            session['user'] = username  # Save user in session  
            return redirect(url_for('user_api', user_name=username, user_age=30))  # Redirect to user API with example age  
        return "Invalid credentials", 401  
    return render_template('login.html')  # Render a login form  

@app.route('/logout')  
def logout():  
    session.pop('user', None)  # Remove user from session  
    return "Logged out", 200  

app.add_url_rule('/usr/<user_name>/<int:user_age>', view_func=UserAPI.as_view('user_api'))  

if __name__ == '__main__':  
    app.run(debug=True)
```

å¯¹åº”çš„ login.html ç¤ºä¾‹ä»£ç å¦‚ä¸‹, å®é™…ä¸Šéœ€è¦è¿”å› render_template æ¥æ¸²æŸ“ç•Œé¢, è€Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ç”¨å‰ç«¯ vue æ¡†æ¶ä¼ é€’æ•°æ®åˆ°åç«¯ flask æ¡†æ¶ä¸Šè¿›è¡Œå®ç°ã€‚ 
```html
<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Login</title>  
</head>  
<body>  
    <h2>Login</h2>  
    <form method="POST">  
        <div>  
            <label for="username">Username:</label>  
            <input type="text" id="username" name="username" required>  
        </div>  
        <div>  
            <label for="password">Password:</label>  
            <input type="password" id="password" name="password" required>  
        </div>  
        <button type="submit">Login</button>  
    </form>  
</body>  
</html>
```
è®¿é—® http://127.0.0.1:5000/usr/1/2 æ—¶, å¦‚æœå·²ç»éªŒè¯ç™»å½•æˆåŠŸ, å¯ä»¥å¾—åˆ°ç›¸åº” json æ•°æ®.

éœ€è¦è¯´æ˜çš„æ˜¯, å¯¹äºåŸºäºç±»çš„ View å¯¹è±¡(å³ class-based-views), æ–¹æ³•ä¸€æ˜¯ç›´æ¥é‡‡ç”¨ add_url_rule è¿›è¡Œå¯¼èˆª, è€Œä¸æ˜¯é‡‡ç”¨ä¿®é¥°å™¨ @ è¯­æ³•è¿›è¡Œ 

### (3) è“å›¾ BluePrint 
å¯¹äºè“å›¾, é€šå¸¸ç”¨äºç›¸åŒ url å‰ç¼€(å¦‚ user/:id, user/profile ç­‰åœ°å€å¯¼èˆª), å¾€å¾€åº”ç”¨äºç½‘é¡µåº”ç”¨çš„æ¨¡å—åŒ–, ä»è€Œä½¿åº”ç”¨å±‚æ¬¡æ›´åŠ æ¸…æ™°. 
ç»™å‡ºä¸€ä¸ªç¤ºä¾‹å¦‚ä¸‹: å…¶ä¸­, æ¯ä¸ªæ¨¡å—, éƒ½ä¼šæš´éœ²å…¨å±€å˜é‡ bp, ä¸»ç¨‹åºé€šè¿‡ import ç›¸åº”çš„æ¨¡å—, å¹¶é‡‡ç”¨ register è°ƒç”¨å…¶ bp å‚æ•°, å°±å¯ä»¥å°†è¯¥éƒ¨åˆ†å°è£…ä¸ºä¸€ä¸ªæ¨¡å—.
```python
from flask import Flask, request, render_template, Blueprint  
  
bp = Blueprint('blueprint_view',  
               __name__,  
               url_prefix='/user',  
               template_folder='../templates')  
  
@bp.route('/')   # http://127.0.0.1:5000/user/  
def index():  
    return 'User Blueprint Index page'
```

```python title:è°ƒç”¨blueprintçš„ä¸»ç¨‹åºéƒ¨åˆ†
from flask import Flask  
import blueprint_view  
  
app = Flask(__name__)  
app.register_blueprint(blueprint_view.bp)   # æ³¨å†Œ blueprint è“å›¾åˆ° app  
if __name__ == '__main__':  
    app.run(debug=True)
```
æ­¤æ—¶åœ¨ app ä¸­è®¿é—®å¯¹åº”çš„ /user å³å¯å¾—åˆ°å¯¹åº”çš„ Index page å“åº”

```python
app.config['SERVER_NAME'] = '127.0.0.1:5000'
@app.url_processor
def get_site(endpoint, values):
	g.site =  values.pop('subdomain')

@app.route('/', subdomain='<subdomain>'
def index():
	return g.site

	
```

## ä¸‰ã€Flask è¿è¡Œå’Œå‘½ä»¤è¡Œæ¥å£æ·»åŠ 
### (1) é…ç½®ç¯å¢ƒå˜é‡å’Œ Flask è¿è¡Œ
é¦–å…ˆ, éœ€è¦è®¾ç½®  FLASK_APP ç¯å¢ƒå˜é‡åˆ° Flask åº”ç”¨ä¸»æ–‡ä»¶å¤¹, æ­¤æ—¶ï¼Œä¾‹å¦‚åº”ç”¨æ–‡ä»¶æ˜¯ app.py (ä¸€èˆ¬éƒ½é‡‡ç”¨app.py) åˆ™: 
1. åœ¨ Linux æˆ–è€… macOS ä¸­: è®¾ç½®ç¯å¢ƒå˜é‡:
```sh
export FLASK_APP=app.py
```
2. windows ä¸­: è®¾ç½®ç¯å¢ƒå˜é‡: 
```sh
set FLASK_APP=app.py
```
ç„¶ååŠ¨è¿‡å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ flask shell: 
```sh
flask shell
```
å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿è¡Œ flask App  
```sh
flask run -h 127.0.0.1 -p  9000
```

### (2) Flask å‘½ä»¤è¡Œæ¥å£ä¸ Pythonæ ‡å‡†å­—ç¬¦ä¸²æ¨¡æ¿çš„ä½¿ç”¨

éœ€è¦è¯´æ˜çš„æ˜¯, <b><mark style="background: transparent; color: orange">flask çš„å‘½ä»¤è¡Œæ˜¯é€šè¿‡ click å®ç°çš„, å®é™…ä¸Š import click å³å¯flask çš„å‘½ä»¤è¡Œæ˜¯é€šè¿‡ click å®ç°çš„, å®é™…ä¸Šéœ€è¦  import click, ç„¶åé‡‡ç”¨ @app.cli.command("cmd name") çš„æ–¹æ³•ä¸ºå‘½ä»¤è¡Œæ¥å£æ·»åŠ å‘½ä»¤:</mark></b>  

```python
import click
from flask import Flask
from flask.cli import with_appcontext

# åˆ›å»º Flask åº”ç”¨
app = Flask(__name__)

# è‡ªå®šä¹‰ CLI å‘½ä»¤
@app.cli.command("initdb", short_help="Initialize the database.")
@click.option('--msg', default="Database initialized.", help="Message to display after initialization.")
@click.option('--verbose', is_flag=True, help="Enable verbose output.")
@with_appcontext
def initdb(msg, verbose):
    """
    Initialize the database. This command sets up the database schema
    and optionally outputs a message.
    """
    # æ¨¡æ‹Ÿæ•°æ®åº“åˆå§‹åŒ–é€»è¾‘
    click.echo("Initializing the database...")

    if verbose:
        click.echo("Verbose mode is enabled. More details will be shown.")
    
    # è¾“å‡ºç”¨æˆ·å®šä¹‰çš„æ¶ˆæ¯
    click.echo(msg)


# å¸¦å‚æ•°çš„å‘½ä»¤
@app.cli.command("adduser", short_help="Add a new user.")
@click.argument('username')  # å¿…é¡»å‚æ•°
@click.option('--email', default=None, help="The user's email address.")
@with_appcontext
def adduser(username, email):
    """
    Add a new user to the database. Requires a username and optionally an email address.
    """
    click.echo(f"Adding user '{username}' to the database.")
    if email:
        click.echo(f"Email: {email}")
    else:
        click.echo("No email provided.")

# `@app.cli.command`: ç”¨äºåˆ›å»ºè‡ªå®šä¹‰å‘½ä»¤ã€‚
# `click.argument`ï¼šå®šä¹‰å¿…éœ€çš„å‘½ä»¤å‚æ•°ã€‚
# `click.option`ï¼šå®šä¹‰å¯é€‰å‚æ•°æˆ–æ ‡å¿—ï¼Œæ”¯æŒé»˜è®¤å€¼ã€å¸®åŠ©ä¿¡æ¯ç­‰ã€‚
#is_flag=True ï¼šæ ‡è¯†å¸ƒå°”æ ‡å¿—ï¼ˆæ— å‚æ•°æ—¶å€¼ä¸º `True`ï¼Œå¦åˆ™ä¸º `False`ï¼‰-> å¦‚æœè®¾ç½®ä¸º False , åˆ™æœ‰å‚ä¸º False 
# å¤šå‚æ•°å’Œè£…é¥°å™¨çš„ç»„åˆ
@app.cli.command("config", short_help="Display or modify configuration settings.")
@click.argument('key')  # å¿…é¡»å‚æ•°
@click.argument('value', required=False)  # å¯é€‰å‚æ•°
@click.option('--show', is_flag=True, help="Display the current value of a configuration key.") 
@with_appcontext
def config(key, value, show):
    """
    Display or update a configuration setting.
    """
    if show:
        click.echo(f"Current value for '{key}': [Simulated Value]")  # æ¨¡æ‹Ÿè¯»å–é…ç½®
    elif value:
        click.echo(f"Setting '{key}' to '{value}'.")
    else:
        click.echo("You must provide a value or use --show to display the current setting.")

if __name__ == "__main__":
    # å¼€å‘ç¯å¢ƒä¸­è¿è¡Œåº”ç”¨
    app.run(debug=True)
```

æ­¤æ—¶å¯ä»¥é‡‡ç”¨ inidb å‘½ä»¤
```python
flask initdb --msg "message"
flask adduser JohnDoe --email john@example.com
flask config SECRET_KEY --show    # æ˜¾ç¤ºæŸä¸ªé…ç½®é”®å€¼ 
flask config  SECRET_KEY 12345  # é‡‡ç”¨ value å¯é€‰å‚æ•° (required = False) 
```

> [!caution] å…³é”®å­—è¡¥å…… 
> å¯¹äºä½¿ç”¨ app å…³é”®å­—çš„éƒ¨åˆ†, éœ€è¦åŠ ä¸Š with_appcontext è£…é¥°å™¨, 

è§†å›¾å‡½æ•°ç›´æ¥è¿”å›æ–‡æœ¬æ˜¾ç„¶ä¸€èˆ¬é¡¹ç›®æ˜¯ä¸éœ€è¦ç”¨åˆ°çš„ï¼Œå¯¹äº HTML ä»£ç éƒ¨åˆ†,  æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ string.Template æä¾›çš„**æ ‡å‡†å­—ç¬¦ä¸²æ¨¡æ¿è¿›è¡Œå­—ç¬¦ä¸²éƒ¨åˆ†æ›¿æ¢ç­‰æ“ä½œ**ã€‚   ä½†æ˜¯å°± Template æœ¬èº«è€Œè¨€,  **ä¸èƒ½å¤Ÿå†™æ§åˆ¶è¯­å¥, å¹¶ä¸”æ— æ³•ç»§æ‰¿é‡ç”¨**ã€‚
```python
from string import Template

s = Template('$This is a $duck')
s.safe_substitute(This ='That',duck='dog')
```
å‚è€ƒ Template æºç : 
```python
class Template:  
    """A string class for supporting $-substitutions."""  
  
    delimiter = '$'  
    # r'[a-z]' matches to non-ASCII letters when used with IGNORECASE, but  
    # without the ASCII flag.  We can't add re.ASCII to flags because of    # backward compatibility.  So we use the ?a local flag and [a-z] pattern.    # See https://bugs.python.org/issue31672    idpattern = r'(?a:[_a-z][_a-z0-9]*)'  
    braceidpattern = None  
    flags = _re.IGNORECASE
```
å¯ä»¥è‡ªå®šä¹‰å¦‚ä¸‹çš„ template ç±»:
```python


# é‡å®šä¹‰ Template å¯¹è±¡:
class MyTemplate(Template):
	deliminator ="#"
	idpattern = r'([a-z]+\.[a-z]+)'   # å¿…é¡»ç¬¦åˆæ¨¡å¼æ‰èƒ½å¤Ÿè¢«æ›¿æ¢
```

## å››ã€MySQL æ•°æ®åº“è°ƒç”¨æ¦‚è¿°
### (1) mysql-connector ç›´æ¥æ“ä½œæ•°æ®åº“
ä½¿ç”¨ `pip install mysql-connector-python` å¯ä»¥ä½¿ç”¨ mysql  è¯­å¥è¿›è¡Œç›´æ¥çš„æ“ä½œã€‚
```python
import mysql.connector  
  
databaseName = "web_users"  
  
conn = mysql.connector.connect(  
    host="localhost",  
    user="friedparrot",  
    password="12345",  
    database=databaseName  
)
# test conn success  
if conn.is_connected():  
    print("Connected to MySQL database")  
    cursor = conn.cursor()  
    result = cursor.execute(  
        """  
        SELECT * FROM table_test1;       
         """
	) # get current database  
    print(cursor.fetchall())  
    conn.close()
```

è¦ä»æŸ¥è¯¢ä¸­è·å–ç»“æœï¼Œä½ éœ€è¦è°ƒç”¨ `fetchone()`ã€`fetchmany()` æˆ– `fetchall()`ã€‚

| åº“                      | ç‰¹ç‚¹                                | é€‚ç”¨åœºæ™¯                      |
| ---------------------- | --------------------------------- | ------------------------- |
| mysql-connector-python | å®˜æ–¹æ”¯æŒï¼Œç¨³å®šå¯é ï¼ŒåŸç”Ÿé©±åŠ¨ï¼Œæ€§èƒ½è¾ƒé«˜ã€‚              | åå‘éœ€è¦ç›´æ¥æ“ä½œæ•°æ®åº“çš„å¼€å‘è€…ã€‚          |
| PyMySQL                | çº¯ Python å®ç°ï¼Œæ— éœ€ C æ‰©å±•ï¼Œè·¨å¹³å°æ–¹ä¾¿ï¼Œç¤¾åŒºæ”¯æŒæ´»è·ƒã€‚ | éœ€è¦è·¨å¹³å°æˆ–é¿å…ä¾èµ–ç¼–è¯‘çš„åœºæ™¯ã€‚          |
| Flask-MySQLdb          | è½»é‡çº§ Flask é›†æˆï¼Œç®€å•æ˜“ç”¨ï¼Œä¾èµ– MySQLdbã€‚     | åå‘è½»é‡é¡¹ç›®ä¸”ç†Ÿæ‚‰ MySQLdb é©±åŠ¨çš„å¼€å‘è€…ã€‚ |
| SQLAlchemy             | æ”¯æŒ ORMï¼Œæä¾›é«˜çº§æŸ¥è¯¢èƒ½åŠ›å’Œæ¨¡å‹ç®¡ç†ï¼Œé€‚é…å¤šç§æ•°æ®åº“ã€‚     | æ¨èç”¨äºä¸­å¤§å‹é¡¹ç›®ï¼Œå°¤å…¶æ˜¯å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚      |

å®é™…ä¸Š,  æˆ‘ä»¬æ›´å¤šé‡‡ç”¨ä»¥ä¸‹å¸¸ç”¨çš„è¯­å¥ç»“æ„ï¼Œä½¿ç”¨å¦‚ä¸‹çš„ try.... catch ç»“æ„ with å³å¯ä¿è¯äº‹åŠ¡ä¸æ‰§è¡ŒæˆåŠŸå³å›æ»šï¼Œ æ‰§è¡ŒæˆåŠŸåˆ™æäº¤ã€‚
Mysql ä¸­, InnoDB å¼•æ“æ”¯æŒäº‹åŠ¡æ“ä½œ, è€Œ MyISAM å¼•æ“ä¸æ”¯æŒäº‹åŠ¡æ“ä½œ, 
```python
if conn.is_connected():
    print("Connected to MySQL database")
    try:
        with conn.cursor() as cursor:
            cursor.execute(
                """
                INSERT INTO table_test1 (name, value) VALUES ('NewName', 123);
                """
            )
            # æäº¤äº‹åŠ¡
            conn.commit()
            print("Data inserted successfully.")
    except Exception as e:
        # å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡
        conn.rollback()
        print(f"An error occurred: {e}")
    finally:
        conn.close()
```

### (2)  ORM æ¦‚å¿µåŠSQLAlchemyæ¡†æ¶åŸºç¡€ 
ORM (Objective Relation Mapping), å³å¯¹è±¡å…³ç³»æ˜ å°„, é€šè¿‡ç›´æ¥é‡‡ç”¨ Python-tutorialon ç±»çš„æ–¹æ³•ï¼Œå°†è¡¨æ˜ å°„æˆç±»ï¼Œ å¯ä»¥ä¸é‡‡ç”¨åŸç”Ÿ SQL è¯­å¥çš„æƒ…å†µä¸‹, å°†ç±»å’Œå®ä¾‹çš„æ“ä½œè½¬æ¢ä¸ºSQL è¯­å¥è¿›è¡Œï¼Œ åŒæ—¶å¯ä»¥å‡å°‘æŸè€—å’Œå‡è½»å¤æŸ¥è¯¢çš„è´Ÿæ‹…ã€‚
**ç‰¹ç‚¹**ï¼š
- å°†æ•°æ®åº“è¡¨æ˜ å°„ä¸ºç±»ï¼Œè®°å½•æ˜ å°„ä¸ºç±»çš„å®ä¾‹ã€‚
- å…è®¸ä»¥å¯¹è±¡æ“ä½œçš„æ–¹å¼æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œã€‚
- è‡ªåŠ¨ç”Ÿæˆå’Œä¼˜åŒ– SQL æŸ¥è¯¢ã€‚
- å¯ç§»æ¤æ€§, å¯ä»¥å‡ ä¹æ— ç¼åˆ‡æ¢ SQLite  ç­‰ç­‰æ•°æ®åº“,  èƒ½å¤Ÿå®ç°å¤šæ¡†æ¶æ”¯æŒã€‚

SQLAlchemy, Django ORM,Peewee  éƒ½æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ ORM æ¡†æ¶, SQLAlchemy å¯åœ¨ ORM æ¨¡å¼å’Œç›´æ¥ SQL æ¨¡å¼ä¹‹é—´è‡ªç”±åˆ‡æ¢ã€‚ ç¤ºä¾‹ä»£ç å¦‚ä¸‹ : 
```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)

engine = create_engine('mysql+mysqlconnector://user:password@localhost/mydatabase')
Session = sessionmaker(bind=engine)
session = Session()

# æ·»åŠ æ–°ç”¨æˆ·
new_user = User(name="Alice")
session.add(new_user)
session.commit()
```

å¯¹äºSqlalchemy,  å³ä½¿æ˜¯é‡‡ç”¨åŸç”Ÿçš„ sql, ç»“æœä¹Ÿéœ€è¦é€šè¿‡è¿”å›å€¼è·å–ï¼Œ è€Œä¸éœ€è¦æ‰§è¡Œ fetchone æˆ–è€… fetch all ç­‰ç­‰ã€‚åŒæ—¶ flask ä¹Ÿæä¾›äº† Flask-SQLAlchemy  æ¡†æ¶ï¼Œ åªéœ€ `pip install Flask-SQLAlchemy` å³å¯ã€‚
```python
from sqlalchemy import create_engine

eng = create_engine("....")
with eng.connect() as conn: 
	res1 = conn.execute("test sentence1"); 
	print(res1)
```

##  äº”ã€Flask æ—¥å¿—å’Œä¸Šä¸‹æ–‡
### (1) æ…¢æŸ¥è¯¢æ—¥å¿—è®°å½•æ–¹æ³• 
 Flask ä¸­çš„æ—¥å¿—å¯¹è±¡å¯ä»¥é‡‡ç”¨ `app.logger` è¿›è¡Œè®¿é—®, å¯¹äºé‡‡ç”¨sqlarchemy æ—¥å¿—éƒ¨åˆ†, éœ€è¦é‡‡ç”¨ `SQLARCHEMY _RECORD_QUERIES` å®. 
 
 ç»“åˆ python æ ‡å‡†åº“ logging åº“,  é‡‡ç”¨ `app.logger.addHandler` æ–¹æ³•æ·»åŠ æ—¥å¿—è¾“å‡ºå¥æŸ„,   å¸¸ç”¨çš„æœ‰ StreamingHandler(ç”¨äºè¾“å‡ºåˆ°æ§åˆ¶å°), FileHandler, NullHandler, RotatingFileHandler ç­‰ç­‰ã€‚

å¯¹äº  Logging éƒ¨åˆ†, æ—¥å¿—é»˜è®¤æ˜¯è¾“å‡ºåˆ° æ§åˆ¶å°çš„, ä½†æ˜¯å¦‚æœå¸Œæœ›è®©å…¶å…¨éƒ¨è¾“å‡ºåˆ°æŸä¸ªæ–‡ä»¶, 
é€šè¿‡ AddHamdler å¯ä»¥å°†
```python
import logging  
import logging.config  
from logging.handlers import RotatingFileHandler  
import flask_sqlalchemy as fksql  
from flask import Flask, request, jsonify, Blueprint
```


éœ€è¦è¯´æ˜, `logging.basicConfig` çš„é…ç½®ä¸ `RotatingFileHandler` çš„é…ç½®å¯èƒ½å­˜åœ¨å†²çªï¼Œå¯¼è‡´æ—¥å¿—åªè¾“å‡ºåˆ°æ§åˆ¶å°ã€‚å› æ­¤éœ€è¦ åˆ é™¤ baseConfig ç›¸å…³é…ç½®

ä»¥ä¸‹ä»£ç ç»™å‡ºäº†ä¸€ä¸ªè®¿é—® testlink åè¯·æ±‚æ•°æ®åº“, å¹¶ä¸”å½“æ‰§è¡Œæ—¶é—´ > 0.01s æ—¶,  ä¼šå°†æ—¥å¿—è®°å½•åˆ° /logs/log_test.log ä¸­ (å…¶ä¸­é€šè¿‡ä» `from sqlalchemy import event` å¯¹åº”çš„ `event.listen` æ–¹æ³•,  è¿›è¡ŒæŸ¥è¯¢å‰åçš„é€»è¾‘ç¼–å†™å’Œè¾“å‡ºåˆ°æ–‡ä»¶)

å¦å¤–, å»ºè®®ä½¿ç”¨ app.logger.warning, ä¸ç”¨ logging .warning 
```python
import logging  
import logging.config  
import time  
from logging.handlers import RotatingFileHandler  
import flask_sqlalchemy  
from flask import Flask, request, jsonify, Blueprint  
from sqlalchemy import create_pool_from_url, create_engine, event  
from sqlalchemy import Column, Integer, String, ForeignKey, DateTime, Boolean, func, or_, and_  
from sqlalchemy.orm import sessionmaker, Session  
from flask_sqlalchemy import SQLAlchemy  
from sqlalchemy.ext.declarative import declarative_base  
  
# åˆ›å»º app, å¹¶è®¾ç½® Logging ä¿¡æ¯  
app = Flask(__name__)  
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymsql//.....'  # æ•°æ®åº“ URL é…ç½®  
app.config['DATABASE_QUERY_TIME_OUT'] = 0.01  
app.config['SQLALCHEMY_RECORD_QUERIES'] = True  
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False       # å…³é—­ sqlalchemy çš„ä¿®æ”¹è¿½è¸ªåŠŸèƒ½  
  
db = SQLAlchemy(app)  # åˆ›å»º SQLAlchemy çš„æ•°æ®åº“å¯¹è±¡ å¹¶ç»‘å®šåˆ° app  
# è¿›è¡Œ logging é…ç½®, é…ç½®æ—¥å¿—è¾“å‡ºç­‰çº§å’Œæ ¼å¼  
handler = RotatingFileHandler('./logs/log_test.log', maxBytes=5* 1024 * 1024, backupCount=10)  # 5MB maximum  
handler.setLevel(logging.INFO)   # æ­£å¸¸çš„éƒ¨åˆ†ä¼šä½œä¸º info è¿›è¡Œè¾“å‡º  
handler.setFormatter(logging.Formatter('[%(levelname)s]:- %(asctime)s - %(message)s'))  
app.logger.addHandler(handler)   # å°† logger  ç»‘å®šåˆ° app.logger éƒ¨åˆ†  
logger = logging.getLogger()  
logger.addHandler(handler)  # å°†å…¨å±€ logger é‡å®šå‘åˆ°æ–‡ä»¶  
logger.setLevel(logging.DEBUG)  # å…¨å±€æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶  
  
class UserInfo(db.Model):  
    __tablename__  = 'user-info'   # æŒ‡å®šè¡¨åå­—  
    id = db.Column(db.Integer, primary_key=True, name='id')    # å…¶ä¸­çš„  id å­—æ®µå±æ€§ (name ä¸æŒ‡å®šåˆ™é‡‡ç”¨å˜é‡åä»£æ›¿)  
    name = db.Column(db.String, primary_key=True, name='name') # å…¶ä¸­çš„  name å­—æ®µå±æ€§  
    def __repr__(self):  
        # representation of the printf return value  
        return f"<UserInfo(name={self.name})>"  
  
# äº‹ä»¶å¤„ç†å™¨,  ç”¨äºå®ç°äº‹ä»¶ç›‘å¬æœºåˆ¶ , åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰, è®°å½•ä¸‹å¼€å§‹æ—¶é—´  
def before_cursor_execute(conn, cursor, statement, parameters, context, executemany):  
    context._query_start_time = time.time()  

def after_cursor_execute(conn, cursor, statement, parameters, context, executemany):  
    total_time = time.time() - context._query_start_time # è®¡ç®—æŸ¥è¯¢æ—¶é—´  
    if total_time > app.config['DATABASE_QUERY_TIME_OUT']:  
        app.logger.warn(msg=f"Executing query: {statement}, spend time: {total_time}")
  
# é‡‡ç”¨ app çš„ä¸Šä¸‹æ–‡, è·å– app çš„æ•°æ®åº“ä¼šè¯å¯¹è±¡å¹¶å»ºç«‹ query
def init_database():  
    with app.app_context():  
        db.create_all()  # åˆ›å»ºæ•°æ®åº“è¡¨  
        event.listen(db.engine, 'before_cursor_execute', before_cursor_execute)  # ç›‘å¬åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰çš„æ“ä½œ  
        event.listen(db.engine, 'after_cursor_execute', after_cursor_execute)  # ç›‘å¬åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹åçš„æ“ä½œ  
        print("Database initialized")  
  
def get_user():  
    with app.app_context():  
        r = db.session.query(UserInfo).all()  # æŸ¥è¯¢æ‰€æœ‰æ•°æ®, å³ select * from user-info        return r  

# ä½¿ç”¨æµ‹è¯•è·¯ç”±, åªè¦è®¿é—®æµ‹è¯•è·¯ç”±, å°±ä¼šè§¦å‘æ•°æ®åº“æŸ¥è¯¢  
@app.route('/testlink', methods=['GET','POST'])  
def testlink():  
    if request.method == 'GET':  
        res = {}  
        usrinfo = get_user()  
        for info in usrinfo:  
            print(f"{info.name} : {info.id}")  # æŒ‰ç…§ç±»è®¿é—®å¯¹åº”çš„å¯¹è±¡  
            res[info.name] = info.id  
        return res  
    else:  
        return "POST"  
  
# db.session.add(user)  
# db.session.commit()  
  
if __name__ == "__main__":  
    init_database()  
    app.run(debug=True)
```

ç”Ÿæˆå¦‚ä¸‹çš„æ—¥å¿—ä¿¡æ¯ : 
```python
[INFO]:- 2024-12-03 17:08:58,272 - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m  
 * Running on http://127.0.0.1:5000  
[INFO]:- 2024-12-03 17:08:58,273 - [33mPress CTRL+C to quit[0m  
[INFO]:- 2024-12-03 17:08:58,274 -  * Restarting with stat  
[WARNING]:- 2024-12-03 17:09:00,531 -  * Debugger is active!  
[INFO]:- 2024-12-03 17:09:00,538 -  * Debugger PIN: 623-640-508  
[INFO]:- 2024-12-03 17:09:20,546 - 127.0.0.1 - - [03/Dec/2024 17:09:20] "[33mGET / HTTP/1.1[0m" 404 -  
[WARNING]:- 2024-12-03 17:09:28,776 - Executing query: SELECT `user-info`.id AS `user-info_id`, `user-info`.name AS `user-info_name`   
FROM `user-info`, spend time: 0.18616557121276855  
[INFO]:- 2024-12-03 17:09:28,944 - 127.0.0.1 - - [03/Dec/2024 17:09:28] "GET /testlink HTTP/1.1" 200 -
```
### (2) Flask ä¸­çš„ Context ä¸Šä¸‹æ–‡ä½¿ç”¨  
#### 1. Thread Local æ¦‚å¿µ
é¦–å…ˆä»‹ç»<b><mark style="background: transparent; color: orange">æœ¬åœ°çº¿ç¨‹(Thread Local) çš„æ¦‚å¿µ</mark></b>: å‚è€ƒ[[ğŸ“˜ClassNotes/âŒ¨ï¸Programming/ğŸPython/â›³Python è¿›é˜¶ä¸è½¯ä»¶æ¶æ„è®¾è®¡ç›¸å…³/5. Python å¤šçº¿ç¨‹, åç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹|5. Python å¤šçº¿ç¨‹, åç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹]] å®é™…ä¸Šä¸åŒçº¿ç¨‹çŠ¶æ€ä¸åŒ, ç›¸äº’ç‹¬ç«‹ã€‚
ç”±äº  `using global variables in Python web applications is not thread safe;` æ‰€ä»¥ werkzeug, æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„æœ¬åœ°çº¿ç¨‹åŒ… `werkzeug.local.Local` ç±»ã€‚ ç›¸å¯¹äº threading.local éƒ¨åˆ† : 
1. é‡‡ç”¨  `__storge__` ä¿å­˜ä¸åŒçº¿ç¨‹ä¸‹çš„çŠ¶æ€ 
2. æä¾›äº†é‡Šæ”¾æœ¬åœ°çº¿ç¨‹çš„ `release_local` æ–¹æ³• 
3. ä¼˜å…ˆé€‰ç”¨ greenlet è·å– get_ident å‡½æ•° (<mark style="background: transparent; color: red">ç”¨äºè·å¾—çº¿ç¨‹æˆ–åç¨‹çš„æ ‡è¯†ç¬¦</mark>),

æ­¤å¤–ï¼Œ æä¾›äº† LocalStack å’Œ LocalProxyéƒ¨åˆ†,  æä¾›æ ˆç»“æ„å’Œä»£ç†æ¨¡å¼ã€‚ 

å…¶ä¸­,**`LocalStack`** æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å †æ ˆï¼Œå…è®¸ä¸åŒçº¿ç¨‹å„è‡ªæ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®ï¼Œåœ¨ Flask ä¸­ï¼Œç”¨äºå­˜å‚¨ä¸è¯·æ±‚ç›¸å…³çš„ä¸Šä¸‹æ–‡ã€‚**`LocalProxy` æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ŒåŠ¨æ€åœ°ä»çº¿ç¨‹æœ¬åœ°çš„ `LocalStack` ä¸­è·å–å¯¹è±¡**ã€‚==ä»£ç†ä½¿å¾—å¯ä»¥ç›´æ¥ä½¿ç”¨ `request` ç­‰å¯¹è±¡ï¼Œè€Œæ— éœ€æ‰‹åŠ¨ç®¡ç†å †æ ˆæ•°æ®==ã€‚

#### 2. request çš„çº¿ç¨‹éš”ç¦»é€»è¾‘å’Œå‚æ•°è®¿é—®
å¯¹äº flask çš„ request å¯¹è±¡, å®é™…ä¸Šæ˜¯è·å–ä¸€ä¸ª `_request_ctx_stack` çš„æ ˆé¡¶å¯¹è±¡çš„ LocalProxy å®ä¾‹ï¼Œ èƒŒåä¾èµ–äº `werkzeug.local.LocalStack` ä»¥å®ç°çº¿ç¨‹éš”ç¦»ã€‚å®ƒæ˜¯é€šè¿‡å°†è¯·æ±‚ç›¸å…³çš„æ•°æ®å­˜å‚¨åœ¨çº¿ç¨‹æœ¬åœ°ï¼ˆthread-localï¼‰çš„å †æ ˆä¸­ï¼Œä»è€Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹çš„è¯·æ±‚æ•°æ®æ˜¯äº’ç›¸ç‹¬ç«‹çš„ã€‚Flask çš„ `request`ã€`session` ç­‰å¯¹è±¡éƒ½åŸºäº `LocalProxy`ï¼Œæå¤§åœ°ç®€åŒ–äº†è¯·æ±‚å¤„ç†é€»è¾‘ã€‚

å› æ­¤,  ç½‘é¡µçš„è¿è¡Œé€»è¾‘æ˜¯  :  
1. ç”¨æˆ·è®¿é—®äº§ç”Ÿè¯·æ±‚
2. è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒFlask ä¼šå°†è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆ`RequestContext`ï¼‰æ¨å…¥ `LocalStack` ä¸ºæœ¬åœ°çš„å †æ ˆéƒ¨åˆ†ã€‚
3. å½“è§†å›¾å‡½æ•°ä¸­è°ƒç”¨ `request` æ—¶ï¼Œé€šè¿‡ `LocalProxy` ä»æ ˆé¡¶è·å–ä¸Šä¸‹æ–‡æ•°æ®ã€‚

åœ¨ Flask çš„æºç ä¸­ï¼Œ`_request_ctx_stack` æ˜¯æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒç®¡ç† `RequestContext` çš„æ ˆã€‚é€šè¿‡ `LocalProxy` ä»£ç†è®¿é—®å½“å‰çº¿ç¨‹çš„ `RequestContext`ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ `request` å¯¹è±¡å®Œæˆæ“ä½œï¼Œ  **åœ¨ Flask çš„æºç ä¸­ï¼Œ`_request_ctx_stack` æ˜¯æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒç®¡ç† `RequestContext` çš„æ ˆ**ã€‚é€šè¿‡ `LocalProxy` ä»£ç†è®¿é—®å½“å‰çº¿ç¨‹çš„ `RequestContext`ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ `request` å¯¹è±¡å®Œæˆæ“ä½œè€Œæ— éœ€æ„ŸçŸ¥åº•å±‚ç»†èŠ‚ã€‚

å› æ­¤, æ¯ä¸ªè§†å›¾å®é™…ä¸Šä¸éœ€è¦åŠ å…¥ request å‚æ•°, è€Œå¯ä»¥åœ¨è§†å›¾å‡½æ•°ä¸­å…¨å±€ä½¿ç”¨è¿™ä¸ª request éƒ¨åˆ† :
```python
from flask import request, Flask 
app = Flask(__name__)

@app.route('/test1')
def test1() : 
	name = request.args.get('name') 
```

ç»™å‡ºå¦‚ä¸‹çš„ LocalStack å’Œ  LocalProxy ä½¿ç”¨çš„ç›¸å…³ä»£ç è®²è§£éƒ¨åˆ†, å®é™…ä¸Š  flask è‡ªåŠ¨åœ°å°†è¯·æ±‚ request å¯¹åº”çš„éƒ¨åˆ†è¿›è¡Œå…¥æ ˆ,    å°½ç®¡ä¸åŒçš„è¯·æ±‚åœ¨ä¸åŒçº¿ç¨‹ä¸­è¿è¡Œï¼ˆæˆ–åœ¨å¼‚æ­¥æ¡†æ¶ä¸­åœ¨ä¸åŒåç¨‹ä¸­è¿è¡Œï¼‰ï¼Œæ ˆä»ç„¶èƒ½å¤Ÿä¸ºæ¯ä¸ªçº¿ç¨‹ç®¡ç†å„è‡ªçš„è¯·æ±‚ä¸Šä¸‹æ–‡ã€‚**è¿™æ˜¯å› ä¸º`LocalStack`æ˜¯ç‰¹å®šäºçº¿ç¨‹çš„ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆç©ºé—´**ã€‚

è‡³äºä½¿ç”¨æ ˆçš„åŸå› ï¼Œ æ˜¯ç”±äº**åœ¨Webæ¡†æ¶ä¸­ï¼Œæ¯ä¸ªè¯·æ±‚å¯èƒ½ä¼šåœ¨å¤šä¸ªå±‚æ¬¡ä¸Šè¢«å¤„ç†  (ä¾‹å¦‚ï¼Œè·¯ç”±ã€è§†å›¾ã€è¯·æ±‚é’©å­ç­‰)ã€‚è¿™ä¼šæ¶‰åŠåˆ°å¤šä¸ªåŠŸèƒ½ç»„ä»¶**ï¼Œè€Œæ ˆç»“æ„æ°å¥½ç¬¦åˆFFLï¼ˆåè¿›å…ˆå‡ºï¼‰ç‰¹æ€§ï¼Œä¾¿äºåœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ç®¡ç†ä¸Šä¸‹æ–‡çš„å…¥æ ˆå’Œå‡ºæ ˆã€‚ä¾‹å¦‚åœ¨èº«ä»½éªŒè¯ä¸­,  éœ€è¦ç­‰å¾…èº«ä»½éªŒè¯éƒ¨åˆ† (åè¿›) å®Œæˆä¹‹å, å¼¹å‡ºå¯¹åº”çš„æ ˆé¡¶å¯¹è±¡,  ç›´åˆ°æ¯ä¸€å±‚éƒ½å¼¹å‡ºå®Œæ¯•, åˆ™è¯·æ±‚ç»“æŸã€‚

```python
from flask import Flask, request
from werkzeug.local import LocalStack, LocalProxy

app = Flask(__name__)

# æ¨¡æ‹Ÿä¸€ä¸ª LocalStack
_request_ctx_stack = LocalStack()

# ä½¿ç”¨ LocalProxy å®ç°çš„ request å¯¹è±¡
request_proxy = LocalProxy(lambda: _request_ctx_stack.top)

@app.before_request
def push_request_context():
    """
    è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ¨¡æ‹Ÿ Flask å°†è¯·æ±‚ä¸Šä¸‹æ–‡æ¨å…¥ LocalStackã€‚
    """
    ctx = {"method": request.method, "path": request.path, "args": request.args}
    _request_ctx_stack.push(ctx)

@app.after_request
def pop_request_context(response):
    """
    è¯·æ±‚å®Œæˆåï¼Œæ¸…ç†æ ˆé¡¶å¯¹è±¡ã€‚
    """
    _request_ctx_stack.pop()
    return response

@app.route('/hello', methods=['GET'])
def hello_world():
    """
    ä½¿ç”¨ request_proxy è®¿é—®è¯·æ±‚æ•°æ®ã€‚
    """
    method = request_proxy['method']  # é€šè¿‡ LocalProxy è·å– method å‚æ•° 
    path = request_proxy['path']             # path å‚æ•° 
    name = request.args.get('name', 'World') # World æ˜¯é»˜è®¤å‚æ•°, å¦‚æœæ²¡æœ‰è·å–åˆ°,  åˆ™é‡‡ç”¨ World 
    return f"Hello, {name}! You accessed {path} using {method}."

if __name__ == '__main__':
    app.run(debug=True)
```

#### 3. Flask ä¸­çš„ Context ä½¿ç”¨ 
åœ¨ Flask ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„ä¸Šä¸‹æ–‡æ¦‚å¿µ:  <b><mark style="background: transparent; color: orange">åº”ç”¨ä¸Šä¸‹æ–‡</mark></b> (app.app_context() )  å’Œ<b><mark style="background: transparent; color: orange">è¯·æ±‚ä¸Šä¸‹æ–‡</mark></b> (request_contextéƒ¨åˆ†) 

ä½¿ç”¨ Context æ˜¯ç”¨äº ç¼“å­˜ä¸€äº›å‘ç”Ÿè¯·æ±‚ä¹‹å‰ä½¿ç”¨çš„èµ„æºçš„æƒ…å†µ,  åŒ…æ‹¬ç”Ÿæˆæ•°æ®åº“é“¾æ¥å’Œç¼“å­˜éƒ¨åˆ†å¯¹è±¡ç­‰ç­‰ã€‚  

- **è¯·æ±‚ä¸Šä¸‹æ–‡ï¼ˆRequest Contextï¼‰**: åœ¨Flaskä¸­ï¼Œè¯·æ±‚ä¸Šä¸‹æ–‡åŒ…å«äº†ä¸å½“å‰è¯·æ±‚ç›¸å…³çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šè¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„ã€è¯·æ±‚å‚æ•°ç­‰ï¼‰ã€‚Flaské€šè¿‡`request`å¯¹è±¡æ¥æä¾›è¿™äº›ä¿¡æ¯, å‚è€ƒ[Request Hooks](https://flask.palletsprojects.com/en/latest/reqcontext/#request-hooks) éƒ¨åˆ†ã€‚
- **åº”ç”¨ä¸Šä¸‹æ–‡æ˜¯åœ¨æ¨å…¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹ä¸­ç”Ÿæˆçš„**,  è€Œè¯·æ±‚ç»“æŸæ—¶ä¹Ÿä¼šå°†è¯·æ±‚ä¸Šä¸‹æ–‡å¼¹å‡º 

åœ¨ Flask ä¸­, <b><mark style="background: transparent; color: orange">æœ‰4 ä¸ªä¸Šä¸‹æ–‡å˜é‡</mark></b> : 
1. `flask.current_app` : åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œå®é™…ä¸Šæ˜¯å½“å‰ app çš„å®ä¾‹å¯¹è±¡, 
2. `flask.g` : åº”ç”¨ä¸Šä¸‹æ–‡,  <mark style="background: transparent; color: red">åœ¨å¤„ç†è¯·æ±‚æ—¶ , ä½œä¸ºä¸´æ—¶å­˜å‚¨çš„å¯¹è±¡</mark>ã€‚
3. `flask.session` :  è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå­˜å‚¨äº†å®¢æˆ·ç«¯çš„ä¼šè¯ä¿¡æ¯ 
4. `flask.request` :  è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå­˜å‚¨å’Œå°è£…äº†å®¢æˆ·ç«¯å‘å‡ºçš„ HTTP è¯·æ±‚çš„å†…å®¹ 

æ‰€æœ‰çš„ request å¿…é¡»åœ¨ request çš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œ, å¦åˆ™ä¼šäº§ç”Ÿ `RuntimeError: Working outside of request context.` é”™è¯¯ã€‚

éœ€è¦è¯´æ˜çš„æ˜¯,  åœ¨ Flask ä¸­ï¼Œ**`session` å¯¹è±¡ä¸»è¦ç”¨äºåœ¨ä¸åŒçš„è¯·æ±‚ä¹‹é—´å­˜å‚¨ç”¨æˆ·çš„ä¸´æ—¶ä¿¡æ¯**ã€‚å®ƒæ˜¯**åŸºäºå®¢æˆ·ç«¯çš„å­˜å‚¨æœºåˆ¶**ï¼Œé»˜è®¤ä½¿ç”¨ **ç­¾åçš„ Cookie** æ¥å­˜å‚¨æ•°æ®ï¼Œè¿™æ„å‘³ç€**å­˜å‚¨åœ¨ `session` ä¸­çš„ä¿¡æ¯æ˜¯å®‰å…¨çš„ï¼Œåªè¦ä½ çš„å¯†é’¥æ²¡æœ‰æ³„æ¼**ã€‚ 

ä¸€èˆ¬åœ°, Flask ä¸­çš„ session ä¸€èˆ¬ç”¨äºå­˜å‚¨:  
- **ç”¨æˆ·è®¤è¯ä¿¡æ¯**ï¼šå­˜å‚¨ç™»å½•çŠ¶æ€ã€ç”¨æˆ· ID æˆ–è§’è‰²ä¿¡æ¯ã€‚
- **è·¨è¯·æ±‚çš„ä¸´æ—¶æ•°æ®**ï¼šå¦‚åˆ†é¡µä¿¡æ¯ã€è´­ç‰©è½¦å†…å®¹ã€‚
- **ä¸´æ—¶é…ç½®é¡¹**ï¼šå¦‚ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€åå¥½ã€‚

å®‰å…¨æ€§ : 
- **ç­¾åçš„ Cookie**ï¼š`session` **ä½¿ç”¨ Flask çš„ `SECRET_KEY` å¯¹å†…å®¹è¿›è¡Œç­¾åï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ã€‚æœªç­¾åçš„æˆ–ä¼ªé€ çš„å†…å®¹ä¼šè¢«æ‹’ç»**ã€‚
- **æ•æ„Ÿä¿¡æ¯**ï¼šä¸è¦ç›´æ¥åœ¨ `session` ä¸­å­˜å‚¨å¯†ç æˆ–ä¿¡ç”¨å¡å·ç­‰æ•æ„Ÿæ•°æ®ï¼Œæ”¹ä¸ºå­˜å‚¨å…¶æ ‡è¯†ç¬¦ï¼ˆå¦‚ç”¨æˆ· IDï¼‰ï¼Œå®é™…æ•°æ®åº”å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯æ•°æ®åº“ä¸­ã€‚

```python
import flask  
from flask import Flask, request, render_template, redirect, url_for, session, flash, abort, Response  
from flask import request  
from werkzeug.local import LocalProxy, LocalStack  
from functools import partial  
from flask_sqlalchemy import SQLAlchemy  
  
_request_ctx_stack = LocalStack()  
  
request_proxy = LocalProxy(lambda: _request_ctx_stack.top.request)  

app = Flask(__name__, template_folder="./templates", static_folder="./static")
  
app.config.update({  
    "SQLALCHEMY_DATABASE_URI": "sqlite:///test.db",  
    "SQLALCHEMY_TRACK_MODIFICATIONS": False,  
    "SECRET_KEY": "secret_key"  
})  
  
db = SQLAlchemy()   # åˆ›å»ºäº†ä¸€ä¸ªæ²¡æœ‰ç»‘å®šåˆ°ä»»ä½• Flask åº”ç”¨ä¸Šçš„ SQLAlchemy å®ä¾‹  
db.init_app(app)    # ç»‘å®š SQLAlchemy å®ä¾‹åˆ° Flask åº”ç”¨ä¸Š  


def get_current_user():  
    return session.get("user_id")  # è·å–å½“å‰ç”¨æˆ·
	# å®é™…å¸¦æ•°æ®åº“ä¸­, æˆ‘ä»¬ä¸€èˆ¬é‡‡ç”¨ User.query.all() è·å–å¯¹åº”ç»“æœã€‚

@app.before_request  
def before_request():  
    g.user =  get_current_user()  
  
class User(db.Model):  
    name = db.Column(db.String(80), unique=True, nullable=False)  
    password = db.Column(db.String(80), nullable=False)  

@app.before_first_request()  
def create_tables():  
    db.drop_all()    # åˆ é™¤æ‰€æœ‰è¡¨  
    db.create_all()  
  
    db.session.add_all([  
        User(name="admin", password="admin"),  
    ])  
    db.session.commit()   # æäº¤äº‹åŠ¡  

@app.context_processor()
def context_processor():
	return {'current_user': g.user}  # åœ¨ context_processor ä¸Šä¸‹æ–‡å¤„ç†ä¸­è¿”å› current_user  

@app.teardown_appcontext():
def teardown(): 
	db.session.remove() 
	g.user = None  # æ¯æ¬¡è¯·æ±‚å®Œæ¯•ä¹‹å, é‡ç½® user ä¿¡æ¯ 

@app.errorhandler  
def page_not_found(e):  
    return render_template("404.html"), 404
```

å…¶ä¸­:  æˆ‘ä»¬å¯ä»¥é‡‡ç”¨  `g.user =  get_current_user()  ` ==è·å–å¯¹åº”çš„ flask åº”ç”¨ä¸Šä¸‹æ–‡, è€Œä¸€èˆ¬é‡‡ç”¨åœ¨ before_request ä¸­å¯¹æ­¤è¿›è¡Œæ•°æ®çš„å¡«å……==ã€‚  
å¦å¤–, app.context_processor ä¹Ÿå¯ä»¥ä¸ºæ‰€æœ‰æ¨¡æ¿æ³¨å…¥å…±äº«æ•°æ®, å³è®¤ä¸ºæ˜¯å…¨å±€å˜é‡ï¼Œå¹¶å¯ä»¥è·¨æ¨¡æ¿ä½¿ç”¨ï¼Œ è¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨å¯¹åº”çš„å…¨å±€å˜é‡äº†(é™¤äº† g, session, request å’Œ current_app ä»¥å¤–, æ³¨å†Œå…¶ä»–ç±»ä¼¼çš„å…¨å±€å˜é‡) 

æ­¤å¤–, å¯ä»¥é‡‡ç”¨  LocalProxy åˆ›å»ºå½“å‰çº¿ç¨‹çš„å…¨å±€å˜é‡, å¹¶åœ¨çº¿ç¨‹ä¸­è¿›è¡Œä½¿ç”¨ ; 
```python
from werkzeug.local import LocalProxy 
current_user = LocalProxy(get_current_user)   # å°†å‡½æ•°æ‰§è¡Œç»“æœçš„è¿”å›å€¼å­˜å‚¨ä¸º LocalProxy 

@app.context_processor()
def context_processor():
	return {'current_user': g.current_user}    # æ­¤æ—¶å¯ä»¥ä½¿ç”¨ current_user å˜é‡è€Œä¿è¯ä¸è¢«ä¸Šä¸‹æ–‡æ±¡æŸ“ -> åŒæ—¶è®¿é—®çš„æ˜¯å‡½æ•°è¿”å›çš„å¯¹è±¡
```


å¯¹äºåœ¨ ç½‘é¡µé¡µé¢è¯»å–æºæ–‡ä»¶ï¼Œ æœ€ç®€å•çš„æ–¹æ³•æ˜¯é‡‡ç”¨ SharedDataMiddleWare æ–¹æ³•, å³: 
```python
from werkzeug import SharedDataMiddleWare 
```

å¯¹äºçŸ­é“¾æ¥é¡µ,  å°¤å…¶æ˜¯åœ¨ç½‘é¡µä¸Šå­˜å‚¨æ–‡ä»¶æ—¶, ä¾‹å¦‚é‡‡ç”¨å“ˆå¸Œå€¼å­˜å‚¨å¯¹åº”çš„æ–‡ä»¶ï¼Œè€Œç”±äºå“ˆå¸Œå€¼å¤ªé•¿,  æ”¯æŒé‡‡ç”¨çŸ­é“¾æ¥æ–¹æ³•è¿›è¡Œè®¿é—®ã€‚
![400](https://i-blog.csdnimg.cn/direct/a86772d4993a48fc97dafb32efd2a9bc.png)
```python
import short_url 
```
