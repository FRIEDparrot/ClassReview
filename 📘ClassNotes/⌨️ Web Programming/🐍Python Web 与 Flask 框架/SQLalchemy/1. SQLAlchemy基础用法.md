## ä¸€ã€åœ¨ Flask æ¡†æ¶ä¸‹åˆ›å»º Sqlalchemy å¯¹è±¡

Flask ä¸­, æœ€æ ¸å¿ƒçš„æ¦‚å¿µæ˜¯ ORM (Objective Relation Mapping), å‚è€ƒ [[ğŸ“˜ClassNotes/âŒ¨ï¸ Web Programming/ğŸPython Web ä¸ Flask æ¡†æ¶/1. Python Flask å…¥é—¨#(2) ORM æ¦‚å¿µåŠSQLAlchemyæ¡†æ¶åŸºç¡€|ORM æ¦‚å¿µåŠSQLAlchemyæ¡†æ¶åŸºç¡€]] . å¯¹äºç»¼åˆæ•™ç¨‹, å‚è€ƒ [unified tutorial](https://docs.sqlalchemy.org/en/20/tutorial/index.html#unified-tutorial) éƒ¨åˆ†; 
é¦–å…ˆåœ¨ url ä¸­, å¦‚æœæ˜¯ç”¨ `create_engine` åŠæ³•ç™»å½•, åˆ™é‡‡ç”¨ engine.connect()  å¾—åˆ°å¯¹åº”çš„è¿æ¥å¯¹è±¡,  éœ€è¦æ³¨æ„, å¦‚æœæœ‰ç‰¹æ®Šå­—ç¬¦, éœ€è¦å‚è€ƒ[urlencode.ASP](https://www.w3schools.com/tags/ref_urlencode.ASP) è¿›è¡Œè½¬ä¹‰ 

### (1) åŸºç¡€ç”¨æ³•
é¦–å…ˆ, é‡‡ç”¨å¦‚ä¸‹çš„æ–¹æ³•,  é…ç½®åŸºç¡€çš„æ•°æ®åº“ URL, å®šä¹‰ä¸€ä¸ª userInfo ç±»ç»‘å®šåˆ° user-info è¡¨, åŒæ—¶è¿›è¡Œ SELECT `user-info`.id AS `user-info_id`, `user-info`.name AS `user-info_name` FROM `user-info` æ“ä½œ

å¯¹äºæŠ½è±¡çš„ sqlarchemy æ•°æ®ç±»å‹, åŠ å‡æ³•ç­‰ç­‰,  å¯ä»¥ä» sqlarchemy å¦‚ä¸‹è¿›è¡Œå¼•å…¥ : 
```python
from sqlalchemy import String, Column, Integer, DateTime,  func, or_, and_  
from sqlalchemy import create_engine
from flask_sqlalchemy import SQLAlchemy  #  ç”¨äºåˆ›å»º sqlarhmy å¯¹è±¡
```

flask_sqlalchemy åŒ…æä¾›äº† Flask å’Œ Sqlalchemy çš„æ¥å£éƒ¨åˆ†ã€‚ä¸€èˆ¬æ–¹æ³•æ˜¯é¦–å…ˆå¼•å…¥ Flask å¹¶åˆ›å»º app å¯¹è±¡, 
é‡‡ç”¨ app.config 

```python
import time  
from logging.handlers import RotatingFileHandler  
import flask_sqlalchemy  
from flask import Flask, request, jsonify
from sqlalchemy import create_pool_from_url, create_engine, event  
from sqlalchemy import Column, Integer, String, ForeignKey, DateTime, Boolean, func, or_, and_  
from sqlalchemy.orm import sessionmaker, Session  
from flask_sqlalchemy import SQLAlchemy  
  
# åˆ›å»º app, å¹¶è®¾ç½® Logging ä¿¡æ¯  
app = Flask(__name__)  
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://test_link'  # æ•°æ®åº“ URL é…ç½®
app.config['SQLALCHEMY_RECORD_QUERIES'] = True  
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False       # å…³é—­ sqlalchemy çš„ä¿®æ”¹è¿½è¸ªåŠŸèƒ½  
  
db = SQLAlchemy(app)  # åˆ›å»º SQLAlchemy çš„æ•°æ®åº“å¯¹è±¡ å¹¶ç»‘å®šåˆ° app  
class UserInfo(db.Model):  
    __tablename__  = 'user-info'   # æŒ‡å®šè¡¨åå­—  
    id = db.Column(db.Integer, primary_key=True, name='id')    # å…¶ä¸­çš„  id å­—æ®µå±æ€§ (name ä¸æŒ‡å®šåˆ™é‡‡ç”¨å˜é‡åä»£æ›¿)  
    name = db.Column(db.String, primary_key=True, name='name') # å…¶ä¸­çš„  name å­—æ®µå±æ€§  
  
    def __repr__(self):  
        # representation of the printf return value  
        return f"<UserInfo(name={self.name})>"  
  
# é‡‡ç”¨ app çš„ä¸Šä¸‹æ–‡, è·å– app çš„æ•°æ®åº“ä¼šè¯å¯¹è±¡å¹¶å»ºç«‹ querydef init_database():  
    with app.app_context():  
        db.create_all()  # åˆ›å»ºæ•°æ®åº“è¡¨  
        event.listen(db.engine, 'before_cursor_execute', before_cursor_execute)  # ç›‘å¬åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰çš„æ“ä½œ  
        event.listen(db.engine, 'after_cursor_execute', after_cursor_execute)  # ç›‘å¬åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹åçš„æ“ä½œ  
        print("Database initialized")  
  
# äº‹ä»¶å¤„ç†å™¨,  ç”¨äºå®ç°äº‹ä»¶ç›‘å¬æœºåˆ¶ , åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ä¹‹å‰, è®°å½•ä¸‹å¼€å§‹æ—¶é—´  
def before_cursor_execute(conn, cursor, statement, parameters, context, executemany):  
    context._query_start_time = time.time()  

def after_cursor_execute(conn, cursor, statement, parameters, context, executemany):  
    total_time = time.time() - context._query_start_time # è®¡ç®—æŸ¥è¯¢æ—¶é—´  
    print(f"Executing query succeed: {statement}, time: {total_time}")

def get_user():  
    with app.app_context():  
        r = db.session.query(UserInfo).all()  # æŸ¥è¯¢æ‰€æœ‰æ•°æ®, å³ select * from user-info        return r  
  
  
# ä½¿ç”¨æµ‹è¯•è·¯ç”±, åªè¦è®¿é—®æµ‹è¯•è·¯ç”±, å°±ä¼šè§¦å‘æ•°æ®åº“æŸ¥è¯¢  
@app.route('/testlink', methods=['POST'])  
def testlink():  
    return None  
  
# è¿›è¡Œ logging é…ç½®, é…ç½®æ—¥å¿—è¾“å‡ºç­‰çº§å’Œæ ¼å¼  
logging.basicConfig(  
    format='[%(levelname)s]:- %(asctime)s - %(name)s - %(ip)s - %(message)s',  
    level=logging.WARN  
)
```


å¯¹äº sqlarchemy.orm éƒ¨åˆ†, æœ€å¸¸ç”¨çš„éƒ¨åˆ†å¦‚ä¸‹:
```python
from sqlalchemy.orm import DeclarativeBase
from sqlalchemy.orm import Mapped
from sqlalchemy.orm import mapped_column
from sqlalchemy.orm import relationship
```

å…¶ä¸­ï¼Œ å¯¹äºæ•°æ®åº“å…³è”æ“ä½œ, æˆ‘ä»¬é‡‡ç”¨ relationship è¿›è¡Œæ•°æ®åº“ä¹‹é—´çš„å…³è”è®¾å®š
```python
from sqlalchemy import create_engine, Column, Integer, String, ForeignKey
sqlalchemy.orm import relationship
from ext import  db  # ç”¨äºå¯¼å…¥æ•°æ®åº“å®ä¾‹ï¼Œ`db`Â æ˜¯ä¸€ä¸ªæ•°æ®åº“å¯¹è±¡ï¼Œé€šå¸¸æ˜¯ SQLAlchemy çš„å®ä¾‹ã€‚è¿™ä¸ªå¯¹è±¡ç”¨äºç®¡ç†æ•°æ®åº“è¿æ¥ã€æ‰§è¡ŒæŸ¥è¯¢å’Œè¿›è¡Œæ•°æ®åº“æ“ä½œ

app = Flask(__name__)
app.config.from_object('congfig')
db.init_app(app)

class User(Base):
	__tablename__ = 'users'
	id = Column(Integer, primary_key=True, autoincrement=True)
	name = Column 

class Transaction(Base):
	user_id = Column(Integer, ForeignKey('users.id'))   # å–å…¶ä¸­ä»¥users.id ä¸ºå¤–é”®çš„, åç§°ä¸ºuser_id çš„é”®
```


