## 一、子集模拟法的基本思想
### (1) 子集模拟法简介
子集模拟法的基本思想是针对小概率失效问题进行可靠性和可靠性局部灵敏度分析的方法; 其基本思想是**引入合理中间失效事件**并**将小的失效概率表达为一系列较大的失效概率的乘积**; 并<u>使用马尔科夫链模拟的方法</u>确定较大条件失效概率的样本点; 

对于中间失效事件的引入， 可以假设结构的功能函数为$g(X)$, 此时失效域记为$F\left\{x:g(x)\leq 0 \right\}$; 我们可以引入中间失效事件$F_{k} = \left\{ x: g(x) \leq b_{k}\right\}$;
其中$b_k$为对应的临界值; 则此时有
$$F_{1} \supset  F_{2} \supset \dots  \supset  F_{m}$$
同时要求满足:
$$F_{k} = \bigcap_{i=1}^{k} F_{i}$$
即第k个失效域为前面$k$个失效域的交集， <b><mark style="background: transparent; color: blue">或者说第k个是最小的失效域, 是前面所有失效域的子集</mark></b>
![[Excalidraw/第五章 子集模拟方法 2024-03-09 14.20.40|400]]
因此， 我们取$F_{k}$为失效域$F_{k} = \left\{x : g(x) \leq b_{k} \right\}$, 其中m为真实的失效域, 即有$b_1 > b_2 > \dots > b_{m} = 0$, 此时即有:真实失效概率密度$P_f$的计算公式; 
$$P_{f} = P\{ F\} =  P \left\{\bigcap_{k = 1}^{m}F_{k} \right\}\tag{5.1.1.1}$$
根据条件概率公式， 显然有如下公式成立:
$$P_{f}= P\left\{ F_{m} \space  |\space \bigcap_{k = 1}^{m-1} F_{k}\right\} \cdot  P \left\{\bigcap_{k = 1}^{m-1} F_{k} \right\} = P\{F_{1} \}\prod_{k=2}^{n} P\left\{ F_{1} | F_{k}\right\}\tag{5.1.1.2}$$
此时， ==我们取==$P_{k} = \left\{ F_{k} | F_{k-1}\right\}$, 并取$P_{1} = P\{F_{1} \}$则有:
$$\boxed {P_{f} = \prod_{k=1}^{m} P_{k}\qquad  P\left\{F_{k}\right\} = \prod_{i=1}^{k} P_{i}\tag{5.1.1.3}}$$
> [!NOTE] 子集模拟法的优点
> 子集模拟法的优势在于, 当使用子集方法进行模拟时， 由于求解的量级较大(一般可取为0.1量级), 从而通过多个子集的运算化简了小概率失效域中的运算, 即小概率失效域可能需要1e-4的量级运算, 而通过子集模拟可以进行有效的化简。 

我们可以计算$\hat{P}_1$为(其中, $x_j^{(1)}$为$X$的联合概率密度函数$f_{X}(x)$产生的$N_1$个样本;):
$$\boxed{\hat{P}_{1} = \hat{P}_{f1} = \frac{1}{N_{1}}\sum^{n}_{j=1} I_{F1} (x_{j}^{(1)})}\tag{5.1.1.4}$$
而**条件失效概率**$P_{k}$为:
$$\boxed {P_{k} =  \hat{P} \left\{ F_{k} | F_{k-1}\right\}  =\frac{1}{N_{k}}\sum^{n}_{i=1} I_{F_{k}}(x_{j}^{(k)})\tag{5.1.1.5}}$$
其中, $x_{j}$均是在上一次抽样的失效域范围内下一个失效域中的点; 而$x_j^{(k)}$为产生的$N_k$个样本, 且其<mark style="background: transparent; color: red">条件概率密度函数</mark>可计算为:
$$q_{X} (x|F_{k-1}) = \frac{I_{F_{k-1}}(x)}{P\left\{ F_{k-1}\right\}}f_{X}(x)$$
### (2) 条件样本点的模拟方法和条件失效概率的估计
由于服从条件概率$q_{X}(x|F_{k-1})$的条件样本点$x_{j}^{(k)}$抽样的Monte Carlo直接抽样方法效率较低， 即往往需要$\prod_{s=1}^{k-1} 1/P_{s}$次抽样才能获取到一个$F_{k-1}$区域的样本点，因此往往选用MCMC方法来模拟对应的蒙特卡洛抽取相应的样本点。

参考[[📘ClassNotes/👨‍🔧Mechanics/🖥️Computational_Mechanics/✈️航空发动机可靠性分析/补充知识/1. 马尔科夫MCS抽样(MCMC)|1. 马尔科夫MCS抽样(MCMC)]], 以及[[📘ClassNotes/👨‍🔧Mechanics/🖥️Computational_Mechanics/✈️航空发动机可靠性分析/第四章 重要抽样法原理与应用#三、基于核密度估计的自适应重要抽样法|第四章 重要抽样法原理与应用]]往往选择具有对称性的$n$维均匀分布为建议分布,  而<b><mark style="background: transparent; color: blue">平稳分布(极限分布)为</mark></b>$F_{k-1}$==区域内的条件概率密度分布==为:
$$\boxed {q_{X}(x|F_{k-1}) = I_{F_{k-1}}(x) \frac{f_{X}(x)}{P\{ F_{k-1}\}}}\tag{5.1.2.1}$$
同样地， 使用失效域中$F_{k-1}$的一点作为初始点。 
建议分布公式参考(4.3.1.2), 类似的, 我们取边长的经验值为:
$$l_{i} = 6 \sigma_{X_{i}} M_{k}^{-\frac{1}{n+4}}$$
其中$M_{k}$为区域$k$对应的抽样次数即链长。

同样地， 我们由$f_X^*(\varepsilon|x)$ 产生备选状态$\varepsilon$, 并取$r$用于接收或者拒绝转移:
$$r = \frac{q_{X}(\varepsilon|F_{k-1})}{q_{X}(x_{j-1}^{(k)}| F_{k-1})}$$
抽样过程与重要抽样中的MCMC方法抽样完全类似, 最终可以使用(5.1.1.4)计算失效概率, 并代入(5.1.1.3)进行连乘获取最终失效概率; 
### (3) 自适应分层策略与子集模拟的中间失效事件以及失效概率的求解
我们考虑中间失效事件的选择在子集模拟可靠性分析中的影响作用, 首先， 总的抽样点数在当中间失效事件较多时，<mark style="background: transparent; color: red">对应的条件失效概率较大, 每个子集可以使用较少的点进行估计，但是由于层数较多, 总的抽样点数将增加</mark>。

为了保持较少的抽样点个数 我们选择在设定中间失效事件个数进行自动分层和折中考虑。 

1. 首先根据变量的联合概率密度函数$f_{X}(x)$产生$N_1$个样本$\left\{x_{1}^{(1)}, x_{2}^{(1)}, \dots x_{n}^{(1)} \right\}$, 
2. 先根据 $N_1$ 个对应样本对应的功能函数值, 并记为 $\left\{ g (x_{1}^{(1)},g (x_{2}^{(1)}) ,\dots g (x_{n}^{(1)})\right\}^{T}$, 并将**功能函数的响应值按照从大到小的次序进行排列**。取$(1-p_{0})N_{1}$个为临界值$b_1$, 显然$F_1$概率值为$p_0$,  然后**将落在$F_1$失效域内的点作为初始点进行马尔科夫链抽样**, 确定下一个样本对应的样本点。
4. 重复抽取， 即取第$k$个样本对应功能函数值$\left\{g(x_{1}^{(k)}), g(x_{2}^{(k)}), \dots  \right\}$, 取**第$(1-p_{0}) N_{k}$个响应**作为中间失效事件的临界值$b_{k}$,  并取$b_{k} = g(x_{(1-p_{0}N_{k})}^{(k)}))$。其中$p_0$为$F_{k-1}$发生情况下$F_{k}$发生的条件概率估计值。<mark style="background: transparent; color: red">则此时</mark>, $F_{k}$区域的**失效概率估计值**为:
$$\hat{P}\left\{ F_{k}\right\} = \prod_{j=1}^{k}P_{j} = p_{0}^{k}$$

> [!NOTE] 子集模拟迭代终止条件
> 重复步骤直到满足第$(1-p_{0})N_{m}$个响应在失效域内时，即$g(x^{(m)}_{(1- p_{0})N_{m}}) < 0$, 则停止抽样, 并令$b_{m} = 0$, 分层结束, 对应的概率为
> $$\hat{P}_{m} = \frac{N_{F}^{(m)}}{N_{m}}$$
5. 由于**前面的均以$p_{0}$为概率而最后一个以$\hat{P}_m$为失效概率** ; 失效概率的估计值$\hat{P}_f$计算为: 
$$\hat{P}_{f} =  p_{0}^{m-1} \hat{P_{m}} = p_{0}^{m-1} \times \frac{N_{F}^{(m)}}{N_{m}}$$
### (4) 可靠性局部灵敏度分析的子集模拟法
其基本思路是: 除了可靠性即失效概率$P_f$表达为概率乘积以外, 对应的可靠性局部灵敏度也可将输入变量的分布参数的可靠性局部灵敏度转化成一系列的可靠性局部灵敏度表达式， 并**使用条件样本点估计可靠性局部灵敏度**。 

我们给出如下公式: 
$$\frac{\partial P_{f}}{\partial \theta_{X_{i}}^{(s)}} =  \sum^{m}_{k=1} \left[\frac{P_{f}}{P_{k}} \frac{\partial  P_{k}}{\partial \theta_{X_{i}}^{(s)}} \right]$$
并给出公式: 
$$\frac{\partial \hat{P}_{f}}{\partial \theta_{X_{i}}^{(s)}} = \frac{1}{N_{k}}\sum^{N_{k}}_{j=1} \left\{ I_{F_{k}}(x_{j})\left[\frac{1}{f_{X}(x_{j}^{(k)})}\cdot \frac{\partial f_{X}(x_{j}^{(k)})}{\partial \theta_{X_{i}}^{(s)}} - \sum^{k-1}_{q=1} \frac{1}{P_{q}}\cdot  \frac{\partial P_{q}}{\partial \theta_{X_{i}}^{(s)}} \right] \right\}$$

> [!hint] 说明
> 由于MCMC样本一定相关性， 因此不能给出局部灵敏度估计值方差分析的具体表达式
## 二、子集模拟的重要抽样可靠性与可靠性局部灵敏度分析
### (1) 子集模拟重要抽样可靠性分析的基本方案
子集模拟重要抽样法即不使用MCMC抽样, 改用重要抽样,  以避免MCMC产生样本的相关性同时保证抽样效率。
条件失效概率的计算公式如下:
$$P_{k} = \int_{R_{n}}I_{F_{k}}(x) \cdot q_{X}(x|F_{k-1}) dx = E \left[\frac{I_{F_{k}}(x) \cdot q_{X}(x|F_{k-1})}{h_{X}^{(k)}(x)} \right]$$
而使用样本表示则得到**条件失效概率**为:
$$\hat{P}_{k} = \frac{1}{N_{k}}\sum^{N_{k}}_{j=1} \frac{I_{F_{k}}(x_{j}) q_{X}(x_{j}^{(k)} | F_{k-1})}{h_{X}^{(k)}(x_{j}^{(k)})} \qquad  (k = 2,3,\dots  m)$$
其中$h_{X}^{(k)}(x)$是重要抽样密度函数

### (2) 抽样步骤与自适应分层策略 
我们仍然首先抽取$N_{1}$个样本并将其响应值由大到小排列， 并取第$(1-p_{0})N_{1}$个样本的**响应值为中间失效概率的临界值**$b_1$, 同样显然得到的$F_{1}$失效概率估计值为$p_0$

我们以在落入失效域中的样本中, **选取联合密度函数值最大的一点， 作为抽样中心**。再次抽样并重复上述步骤, 最终得到$F_{k-1}$下的条件失效概率估计值:
$$\hat{P}_{k} = \hat{P}\left\{F_{k} |F_{k-1}\right\} = \frac{1}{N_{k}} \sum^{N_{k}}_{j=1}\frac{I_{F}(x_{j}^{(k)}) q_{X}(x_{j}^{(k)}| F_{k-1}) }{h_{X}^{(k)} (x_{j}^{(k)})}$$
终止条件: 重复步骤直到满足第$(1-p_{0})N_{m}$个响应在失效域内，即$g(x^{(m)}_{(1- p_{0})N_{m}}) < 0$, 参考上方即可; 显然有总的失效概率估计值:
$$\hat{P}_{f} = \prod^{m}_{k=1} \hat{P}_{k}$$
对应地， 有失效概率的均值和方差(即其收敛性)计算为:
$$E[\hat{P}_{f}] = \prod^{m}_{k=1} E[\hat{P}_{k}]$$
其中有计算公式:
$$\hat{P}_{1} = E[\hat{P}_{1}] = \frac{1}{N} \sum^{N_{1}}_{j=1}I_{F_{1}}(x_{j}^{(1)})$$
$$\hat{P}_{k}= E[\hat{P}_{k}] = \frac{1}{N}\sum^{N_{k}}_{j=1}\frac{I_{F_{k}}(x_{j})q_{X}(x_{j}^{(k)} | F_{k-1})}{h_{X}(x_{j}^{(k)})}\qquad  (k =2 , \dots  m)$$
同样的，有方差计算:
$$V[\hat{P}_{f}] = \prod^{m}_{k=1}\left\{\hat{P}_{k}^{2}+ V[\hat{P}_{k}]- \hat{P}_{f}^{2} \right\}$$
对应地, 方差的估计值为:
$$V[\hat{P}_{1}] = \frac{p_{0}-p_{0}^{2}}{N_{1} - 1}\qquad  V[\hat{P}_{k}] = \frac{1}{N_{k} -1} \left[\frac{1}{N_{k}}\sum^{N_{k}}_{j=1} \left( \frac{I_{F_{k}}(x_{j}^{(k)}) q_{X}(x_{j}^{(k)}|F_{k-1})}{h_{X}^{(k)} x_{j}^{(k)}}\right)^{2} - \hat{P}_{k}^{2}\right](k=2,\dots m)$$

