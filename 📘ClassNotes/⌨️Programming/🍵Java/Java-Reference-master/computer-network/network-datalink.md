# 	计算机网络的数据链路层

* [计算机网络的数据链路层](#计算机网络的数据链路层)
   * [数据链路层](#数据链路层)
      * [关键概念](#关键概念)
         * [打包成帧](#打包成帧)
         * [链路接入](#链路接入)
         * [可靠交付](#可靠交付)
         * [差错检测和纠正](#差错检测和纠正)
      * [地址映射](#地址映射)
      * [数据链路层的作用](#数据链路层的作用)
   * [通信类型分类](#通信类型分类)
      * [共享介质型网络](#共享介质型网络)
         * [争用](#争用)
         * [令牌环](#令牌环)
      * [非共享介质型网络](#非共享介质型网络)
      * [交换集线器](#交换集线器)
      * [环路检测方法](#环路检测方法)
      * [虚拟局域网 VLAN](#虚拟局域网-vlan)
   * [以太网](#以太网)
      * [以太帧格式](#以太帧格式)

> 这是计算机网络连载系列的第六篇文章，前五篇文章见
>
> [计算机网络基础知识总结](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247486242&idx=1&sn=fac49b0b79515a5ed6afd4b341aff87b&chksm=e999fe30deee772637e1c52fb9001c60e60a772e7adba6701329c81974e76c57bb7b2e570225&token=850264305&lang=zh_CN#rd)
>
> [TCP/IP 基础知识总结](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247486408&idx=1&sn=c332ae7ae448f3eb98865003ecade589&chksm=e999fedadeee77cc6281d1b170bd906b58220d6cd83054bc741821f4167f1f18ceee9ba0e449&token=850264305&lang=zh_CN#rd)
>
> [计算机网络应用层](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247486507&idx=1&sn=622cc363b34bce54f4953076faa1cad6&chksm=e999f939deee702f2444df83ad9805de8c70fb88b89d299fdf0a82b3463e253f32372963c039&token=1398464113&lang=zh_CN#rd)
>
> [计算机网络传输层](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247487108&idx=1&sn=7b47f421bb1dee4edb357a10399b7fec&chksm=e999fb96deee7280a17bfff44c27ef11a60e93e48f9da738670a779ecf6accb5a6a4ebd3cbcc&token=1398464113&lang=zh_CN#rd)
>
> [计算机网络网络层](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247487683&idx=1&sn=e0949e72e039759545450852d8bc0ada&chksm=e999e5d1deee6cc7ab9e42b50329924fee39c45955516b406046605d27928825a0f628d13e7c&token=1398464113&lang=zh_CN#rd)

下面我们把关注点放在数据链路层，如果没有数据链路层，计算机网络也就不复存在；这就好比大楼没有了地基，人没有了腿；所以，数据链路层的知识也固然重要，不少小伙伴只把关注点放在 TCP 和 IP 这两个协议上，这是一种狭隘的思想，需要及时纠正，计算机网络可不只有 TCP 和 IP。下面我就和你聊聊计算机中的数据链路层。

## 数据链路层

数据链路层属于计算机网络中的底层，一听数据链路，顾名思义就是数据走过的路径，着重点放在路径上，这个路径也被称为信道，一般来说，数据链路层使用的信道有两种。

* 点对点信道：这种信道使用一对一数据传输的信道。
* 广播信道：这种信道使用一对多数据传输的信道。

数据链路层，按照 OSI 七层模型来划分的话，就属于物理层的上层

![](http://www.cxuan.vip/image-20230123172337770.png)

数据链路层是一种协议层，它有很多协议。数据链路层**用于跨物理层在网段节点之间传输数据**，通常指以太网、无线局域网等通信手段。数据链路层提供了在网络的两个实体之间传输数据的功能，并且提供了差错检测用于纠正物理层中发生的错误。

### 关键概念

在数据链路层中，链路层地址有很多中不同的称谓：LAN 地址、物理地址或者 MAC 地址，因为 MAC 地址是最流行的术语，所以我们一般称呼链路层地址指的就是 MAC 地址。

下面我们就来认识一下数据链路层的几个关键概念。

#### 打包成帧

**打包成帧(framing)**: 有的书中称为封装成帧，概念其实是一样的。每个数据报在传输之前，链路层协议都会在一段数据的前后添加首部和尾部，这样就构成了一个帧。帧是数据链路层的传输单元。

一个帧的帧长等于帧的数据部分（Payload Field）加上帧首部（Header）和帧尾部（Trailer）长度。首部和尾部的主要功能就是用于**帧定界**，在发送帧时，会从帧首进行发送，所以为了提高传输效率，**应当使帧的数据部分长度尽可能大于首部和尾部的长度**。但是这个长度也不是没有边界的，链路层也规定了一个数据部分的上限，即**最大传输单元（MTU, Maximum Transfer Unit）**。

帧定界符还有一个非常重要的作用就是它能够被检测出来是否是一个完整的帧，如果不是一个完整的帧，必须丢弃。

如果帧太大的话，数据链路层会将大帧拆分为一个个的小帧，这些小帧能够使传输控制和错误检测更加高效。

>帧就是 0 1 序列的封装。

网络层数据报就封装在*Payload Field*字段中。根据不同的物理介质，每个帧的结构也不同。帧的组成如下。

![](http://www.cxuan.vip/image-20230123172439971.png)

帧中主要涉及的内容如下。

* *帧头(Frame header)*：它包含帧的源地址和目的地址。
* *有效载荷(Payload Field)*：它包含要传递的数据和信息。
* *尾部标记(Trailer)*：它包含错误检测和错误纠正位。
* *标记(Flag)*：它标记了帧的开始和结束。

Flag 位位于帧的开头和结尾，两个连续的标志指示帧的结束和开始。

![](http://www.cxuan.vip/image-20230123172452190.png)

帧的类型主要有两种，固定大小的帧和可变大小的帧。

* *固定大小的帧(Fixed-sized Framing)*：表示帧的大小是固定的，帧的长度充当帧的边界，因此它不需要额外的边界位来标识帧的开始和结束。
* *可变大小的帧(Sized Framing)*：表示每个真的大小是不固定的，因此保留了其他机制来标记一帧的结束和下一帧的开始。它通常用于局域网，在可变大小的帧中定义帧定界符的两种方法是。
  * *长度字段(Length Field)*: 使用长度字段来确定帧的大小。它用于以太网（IEEE 802.3）。
  * *结束定界符(End Delimiter)*: 经常用于令牌环。

#### 透明传输

透明传输指的是不论什么样的字符组合，都应该能够在链路上传输，当传输数据的比特组合恰巧和某些控制信息完全一样时，需要采取措施`包装`一下这些比特组合，从而使接收方不会误判比特组合为控制信息。这样才能够保证链路上的传输是透明的。经常采取的转换方法是使用*转义字符 ESC*。

#### 链路接入

链路接入主要指的是 MAC 协议，**MAC(Medium Access Control)** 协议规定了帧在链路上的传输规则。我们知道，数据链路层是 OSI 标准模型的第二层，它还能够向下分为 *The logical link control (LLC)* 层和*The medium access control (MAC)* 层。

![image-20230123172527036](http://www.cxuan.vip/image-20230123172527036.png)

LLC 层又叫做**逻辑控制链路层**，主要用于数据传输，它充当网络层和数据链路层中的媒体访问控制（MAC）子层之间的接口。LLC 层的主要功能如下

* LLC 的主要功能是发送时在 MAC 层上多路复用协议，并在接收时同样地多路分解协议。
* LLC 提供跳到跳的流和差错控制，像是路由器和路由器之间这种相邻节点的数据传输称为一跳。
* 它允许通过计算机网络进行多点通信。

MAC 层负责传输介质的流控制和多路复用，它的主要功能如下

* MAC 层为 LLC 和 OSI 网络的上层提供了物理层的抽象。
* MAC 层负责封装帧，以便通过物理介质进行传输。
* MAC 层负责解析源和目标地址。
* MAC 层还负责在冲突的情况下执行冲突解决并启动重传。
* MAC 层负责生成帧校验序列，从而有助于防止传输错误。

在 MAC 层中，有一个非常关键的概念就是 MAC 地址。MAC 地址主要用于识别数据链路中互联的节点，如下图所示

![](http://www.cxuan.vip/image-20230123172559033.png)

MAC 地址长 48 bit，在使用*网卡(NIC)*的情况下，MAC 地址一般都会烧入 ROM 中。因此，任何一个网卡的 MAC 地址都是唯一的。MAC 地址的结构如下。

![](http://www.cxuan.vip/image-20230123172614191.png)

MAC 地址中的 3 - 24 位表示厂商识别码，每个 NIC 厂商都有特定唯一的识别数字。25 - 48 位是厂商内部为识别每个网卡而用。因此，可以保证全世界不会有相同 MAC 地址的网卡。

>MAC 地址也有例外情况，即 MAC 地址也会有重复的时候，比如你可以手动更改 MAC 地址。但是问题不大，只要两个 MAC 地址是属于不同的数据链路层就不会出现问题。

#### 可靠交付

数据链路层提供的可靠交付更多指的是**单端链路节点到节点地传送**。当链路层协议提供可靠交付时，它能保证无差错地经链路层移动每个网络层数据报。链路层提供可靠交付的方法和 TCP 类似，也是使用了确认和重传机制。

链路层的可靠交付通常用于出错率很高的链路，例如无线链路，它的目的是在本地纠正出错的帧，而不是通过运输层或应用层协议强制进行端到端的数据传输。对于出错率较低的链路，比如光纤、同轴电缆和双绞线来说，链路层的交付开销是没有必要的，由于这个原因，这些链路通常不提供可靠的交付。

![](http://www.cxuan.vip/image-20230123172638149.png)

#### 差错检测和纠正

链路层数据以帧的形式发送，在发送的过程中，接收方节点的链路层硬件可能会由于信号干扰或者电磁噪音等原因错误的把 1 识别为 0 ，0 识别为 1。这是一种很常见的现象，就比如你和你小女朋友在通电话时，旁边总有个讨厌鬼在插话，这样你有可能听不清楚你小女朋友讲的话，她说在咖啡馆见面，结果你跑到了宾馆，这就不好了。 

运输层和网络层通过因特网**校验和**来实现差错检测，目前在数据链路层广泛使用了*循环冗余校验（CRC）*的检测技术。

链路层的差错检测通常更复杂，并且用硬件实现。差错纠正类似于差错检测，区别在于接收方不仅能检测帧中出现的比特差错，而且能够准确的确定帧中出现差错的位置。

差错检测和纠正的技术主要有。

* 奇偶校验：它主要用来差错检测和纠正。
* 校验和：这是一种用于运输层检验的方法。
* 循环冗余校验：它更多应用于适配器中的链路层。

### 地址映射

因为存在网络层地址（IP 地址）和 数据链路层地址（MAC 地址），所以需要在它们之间进行转换和映射，这就是**地址解析协议**所做的工作，更多关于地址解析协议的理解，请查阅作者写的 ARP 地址解析协议相关知识。

### 数据链路层的作用

数据链路层中的协议定义了互联网络的两个设备之间传输数据的规范。数据链路层需要以通信介质作为传输载体，通信媒介包含**双绞铜线、光纤、电波等红外装置**。在数据分发装置上有 **交换机、网桥、中继器** 等中转数据。链路层中的任何设备又被称为*节点(node)*，而沿着通信路径相邻节点之间的通信信道被称为*链路(link)*。

实际上，在链路层上传输数据的过程中，链路层和物理层都在发挥作用。因为在计算机中，信息是以 0 1 这种二进制的形式进行传输，而实际的链路通信却是以电压的高低、光的闪灭以及电波的频谱来进行的。物理层的作用就是**把二进制转换成为链路传输所需要的信息**来进行传输。数据链路层传输也不只是单个的 0 1 序列，它们通常是以帧为单位进行的。

>现在我们知道了数据链路层大概是干啥的，那么只有理论不行，你还得有硬通货，也就是硬件，一切的理论都离不开硬件的支撑。

硬件就可以简单理解为一种通信介质，在通信介质上会有不同种类的信息传递方式，不过总的来说可以概括为两种：一种是共享介质型网络，一种是非共享介质型网络，下面我们就要聊一聊这两种通信类型。

## 通信类型分类

### 共享介质型网络

共享介质型网络故名思义就是**多个设备使用同一个通信介质的网络**。共享介质型网络的类型主要有*以太网(Ethernet)*和*光纤分布式数据接口(Fiber Distributed Data Interface，FDDI)*。

共享说的是，多个设备会使用同一个载波信道进行发送和接收，这其实是一种半双工的设计。

>什么是半双工？
>
>半双工指的是数据可以在一个信道上的两个方向上相互传输，但是不能同时传输，举个简单的例子，就是你能给我发消息，我也能给你发消息，但是不能你给我发消息的同时我也在给你发消息。

既然多个设备会共同使用一个信道，那么就可能存在多个数据传输到同一个介质上导致的数据争用问题，为此，共享介质型网络有两种介质访问控制方式：**争用和令牌传递**。

#### 争用

争用是发生在共享介质，**载波监听多路访问(CSMA)** 上的数据访问方式。在这种访问方式下，网络中各个介质会采用**先到先得**的方式占用载波信道发送数据。如果多个介质同时发送帧，就势必会产生冲突，继而导致通信性能的下降和网络拥堵。下面是争用的处理方式。

![](http://www.cxuan.vip/image-20230123205008029.png)

如上图所示，假如 A 想要给 C 发送数据，那么介质 A 会在确认周围没有其他介质要给 C 发送数据后，也就是经过一段时间后，A 会把数据马上发送给 C。

![](http://www.cxuan.vip/image-20230123205026783.png)

每个介质在接受到 A 发送的数据后，会从 A 报文中解析出来 MAC 地址判断是否是发送给自己的数据包，如果不是的话就是丢弃这条数据。

![](http://www.cxuan.vip/image-20230123205044816.png)

上面这种方式会使用在一部分以太网中，但是另外一部分以太网却使用了 CSMA 的改良方式 - CSMA/CD 。CSMA/CD 会要求每个介质提前检查一下链路上是否有可能产生冲突的现象，一旦发生冲突，那么尽可能早地释放信道。它的具体工作原理大致如下：

* 监听载波信道上是否会有数据流动，如果没有的话，那么任何介质都可以发送数据。
* 介质会检查是否发生冲突，一旦发生冲突就会丢弃数据，同时立即释放载波信道。
* 放弃数据后，会经过一段时间重新争用介质。

下面是 CSMA/CD 的改良版。

![](http://www.cxuan.vip/image-20230123205153861.png)

上图这个过程是 *CSMA(Carrier Sense Multiple Access)*，首先介质会监控载波信道上是否有数据存在，如果没有再发送，如果有，等一段时间再发送。

下面是 *CD(Collision Detection)* 的示意图。

![](http://www.cxuan.vip/image-20230123205216988.png)

* 在发送数据 -> 发送完成后，如果电压一直处于规定范围内，就会认为数据已经正常发送。
* 发送途中，如果电压超过了一定范围，就会认为是数据冲突。
* 发生冲突时会先发送一个阻塞报文，继而放弃数据，在延迟一段时间后再次发送。

#### 令牌环

第二种共享介质型网络的传输方式就是令牌环了，令牌环顾名思义就是有一个令牌一样的东西，以环为一圈进行令牌传输，那么令牌是啥呢？你想啊，我们最终的目的不就是为了传输数据吗？那么这个令牌，它可不可以作为数据呢？

其实，在这种传输方式中，令牌环是作为一种特殊报文来传输的，它是控制传输的一种方式，在数据传输的过程中同时会将令牌进行传递，只有获得令牌的介质才能够传输数据。这种方式有两个优点，即

* 持有令牌的介质才能够传输数据，这样能够保证不会有报文冲突情况。
* 每个介质都有平等获取令牌的机会，这样保证了即使网络拥堵也不会导致性能下降。

但是这种令牌环的传递方式也是有缺点的，因为只有持有令牌的介质才能发送数据，所以即使在网络不太拥堵的情况下，其利用率也达不到 100%。

下面是令牌的传递示意图。

![](http://www.cxuan.vip/image-20230123205241090.png)

最一开始，令牌位于介质 A 处，此时介质 A 拥有数据传输的能力，然后介质 A 把令牌传递给介质 B。

![](http://www.cxuan.vip/image-20230123205303746.png)

此时 B 持有令牌，所以介质 B 具有发送数据的能力。

![](http://www.cxuan.vip/image-20230123205322532.png)

这个数据最终会由 D 接收，然后 D 就会设置一个已接收数据的标志位，然后数据会继续向下发送。

![](http://www.cxuan.vip/image-20230123205347404.png)

令牌环是一项很成功的技术，尤其是在公司环境中使用，但后来被更高版本的以太网所取代。

在了解完共享网络之后，我们来探讨一波非共享网络。

### 非共享介质型网络

如果说共享介质型网络是共享介质的话，那么非共享介质型网络就是不会共享介质，那么该如何通信呢？

在这种方式下，网络中的每个介质会直接连上交换机，由交换机来转发数据帧。发送端和接收端不会共享通信介质，共享通信介质的意思就是介质之间直接通信。这种网络传输方式一般采用的是全双工通信。

非共享介质型网络比较适合应用于搭建**虚拟局域网(VLAN)**，但是这种通信方式有一个及其致命的弱点：一旦交换机发生故障，那么与交换机相连的所有计算机都无法通信。

下面是非共享介质型网络的通信示意图。

![](http://www.cxuan.vip/image-20230123205406214.png)

如图所示，主机 A 发送了一个目标地址为 B，源地址为 A 的交换机，由交换机负责将数据转发给介质 B，如下图所示

![](http://www.cxuan.vip/image-20230123205447730.png)

非共享型网络是一种全双工通信的方式，每个介质在发送数据的同时也能够接受来自交换机传递过来的数据。

### 交换集线器

交换集线器是一种共享型网络通信介质，它是使用同轴电缆作为传输介质，通常用于以太网中，交换集线器也叫做以太网交换机。

![](https://z3.ax1x.com/2021/03/21/656Dcn.png)

<div align = "center">图 6-18</div>

以太网交换机中的各个端口会根据介质的 MAC 地址来转发数据，那么转发数据肯定得有所依靠啊，这时可以参考的表就叫做*转发表(Forwarding Table)*，转发表中记录着每个介质的 MAC 地址。转发表不需要我们手动维护，交换机会自动维护转发表。交换机会自学每个数据包的经过介质的 MAC 地址，如下图所示

![](http://www.cxuan.vip/image-20230123205512365.png)

由于不知道主机 B 的 MAC 地址，所以主机 A 发送的数据会经过交换机广播给以太网内的其他主机，主机 B 接收到数据后，会给主机 A 回送消息。

![](http://www.cxuan.vip/image-20230123205532140.png)

在主机 B 给主机 A 回送消息后，交换机就知道主机 A 和主机 B 的 MAC 地址了，从此以后双方通信会在各自相连的端口之间进行。

由于 MAC 地址没有层次性，转发表中的记录个数与所有网络设备的`数量`有关，当设备增加时，转发表的记录也会越来越多，检索时间会逐渐增加。所以如果需要连接多个终端时，需要将网络分成多个数据链路，采用类似 IP 地址一样对地址进行分层管理。

在网络通信的过程中，由于网络链路的冗余或者路由线路冗余可能会造成`闭环`，也就是我们所称的`环路`。环路会导致数据报文在网络中不断重复复制，最终导致网络设备负载过重，无法正常运行。影响的范围可能会扩散至整个局域网，导致整个局域网里的计算机无法正常使用网络。

![](http://www.cxuan.vip/image-20230123205554052.png)

>那么如何检测网络中出现的环路呢？

### 环路检测方法

目前有两种检测环路的方式，一种是`生成树`，一种是`源路由法`。

生成树：生成树指的是每个网桥必须在 1 - 10 秒内相互交换生成树协议单元包，以此来判断哪些接口使用，从而消除环路，一旦发生故障后就会立刻切换线路，利用没有被使用的端口进行传输。

源路由法：源路由法通常是用来解决令牌环路。这种方式可以判断发送数据的源地址是通过哪个网桥实现传输的，并将帧写入 RIF，网桥会根据这个 RIF 信息发送给目标地址，即使网桥中出现了环路，数据帧也不存在被反复转发的可能。

### 虚拟局域网 VLAN

网络通信过程中经常会遇到网络负载过高，通信性能下降的情况，往往遇到这种情况，就需要分散网络负载，变换部署网络设备的位置等。在虚拟局域网出现之前，往往需要管理员手动变更网络的拓扑结构，比如变更主机网段，进行硬件线路改造等，但是使用了虚拟局域网，就可以不用再做如此复杂的操作了，只需要修改**网络结构**即可。

>那么虚拟局域网究竟是什么呢？

![](http://www.cxuan.vip/image-20230123205620209.png)

如上图所示，交换机按照端口区分了多个网段，从而区分了广播数据的传播范围，提高网络安全性。然而异构的两个网段之间，需要利用具有路由功能的交换机才能实现通信。

由于交换机端口有两种 VLAN 属性，一个是 VLANID，一个是 VLANTAG，分别对应 VLAN 对数据包设置 VLAN 标签和允许通过的 VLANTAG（标签）数据包，不同 VLANID 端口，可以通过相互允许 VLANTAG，构建 VLAN。

## 以太网

以太网提了这么多次，那么以太网到底是什么？

数据链路层有很多分类，包括**以太网、无线通信、PPP、ATM、POS、FDDI、Token Ring、HDMI 等**，其中最著名的通信链路就是以太网了。

以太网最开始的时候，一般使用的是以同轴电缆为传输介质的共享介质型连接方式，这也是以太网的第一种方式，叫做经典以太网。而现在，随着互联设备的处理能力和传输速度的提高，现在都采用终端和交换机之间连接方式，这也是第二种方式，叫做交换式以太网。以太网使用的是 `CSMA/CD` 的总线技术，我们前面也介绍过了。

### 以太帧格式

在以太网链路上的数据包被称为以太帧，以太帧开头有一个叫做*前导码(Preamble)* 的部分，它是由 0、1 数字交替组合而成。前导码的末尾最后是一个叫做 *SFD(Start Frame Delimiter)* 的域，值为 11。前导码与 SFD 共同占用 8 个字节。

![](http://www.cxuan.vip/image-20230123213832613.png)

>以太网最后 2 bit 称为 SDF，而 IEEE802.3 中将最后 8 bit 称为 SDF。
>
>IEEE802.3 是电气和电子工程师协会 （IEEE）标准的集合制定的标准。

这是以太帧的前导码部分，下面是以太帧的本体部分。

![](http://www.cxuan.vip/image-20230123213934612.png)



以太帧体格式也有两种，一种是以太帧格式，一种是 IEEE802.3 标准以太帧格式。

在以太帧格式中，以太帧的本体的前端是以太网的首部，总共占用 14 字节，分别是 6 字节的目标 MAC 地址、6 字节的源 MAC 地址和 2 字节的上层协议类型，如下图抓包所示：

![](http://www.cxuan.vip/image-20230123213914507.png)

后面是数据部分，占用 46 - 1500 字节，最后是 *FCS (Frame Check Sequence，帧检验序列)* 4 个字节。FCS 用于检查帧是否有所损坏，因为在通信过程中由于噪声干扰，可能会导致数据出现乱码位，从而使接收方选择丢弃这个帧序列。

IEEE 802.3 以太帧的格式与一般以太网帧格式有所不同，一般以太帧中的**类型字段**却在 IEEE802.3 表示帧长度，此外新增加了 LLC 和 SNAP 字段。

>由于数据链路层再细化的话可以分为两层，介质访问控制层 MAC 和逻辑链路控制层 LLC 。
>
>介质访问层 MAC 会根据以太网等不同链路特有的首部信息进行控制，逻辑链路层 LLC 则根据以太网等不同链路共有的帧头信息进行控制。

LLC 和 SNAP 可以再进行细分：

![](http://www.cxuan.vip/image-20230123213959537.png)

其中 DSAP 表示目的访问节点，SSAP 表示源访问节点，CTRL 的值一般是 03 ，表示无连接服务的IEEE 802.3无编号数据格式。OUI 表示 3 字节的唯一标识符，通常就是 MAC 中的厂商代码，Type 表示以太网所携带的上层数据类型。

## 通信适配器

计算机与外部世界的交互是通过*通信适配器（adapter）*来完成的，适配器就是安装在主机箱内的一块网络接口板，通常就是我们说的*网卡（NIC）*，通过在电脑主机箱内插入一块网络接口板就能够将主机和外部网络连接起来。

适配器通常和两种媒介打交道，一种是通过电缆或者双绞线与其他主机通信；一种是通过主板上的 IO 与计算机通信。

由于网络上的数据发送频率和计算机总线上的频率不相同，因此在网卡中装有对数据进行缓存的存储芯片。在主板上插入适配器时，还要把适配器的驱动程序安装在操作系统中，这个驱动程序会告诉网卡应该将存储器（RAM/ROM）中的哪个位置进行存储，此外网卡还要实现以太网协议才能够发送数据。

![](http://www.cxuan.vip/image-20230123214312041.png)

网卡在接收和发送帧时，不会和 CPU 直接打交道，这时候 CPU 仍然可以做自己的事情。当收到有差错的帧时，网卡会丢弃这个帧，而不必发送通知给 CPU；当网卡收到正确的帧后，就会触发中断来告诉计算机，并把数据向上交付给网络层。如果计算机要发送 IP 数据包时，就会将 IP 数据包交给网卡，封装成帧后再发送给局域网。

## PPP - 点对点协议

当我们计算机想要接入网络时，我们需要与 ISP(互联网提供商) 签一份协议，由 ISP 帮助我们分配一个 IP，我们通过这个 IP 才能和 ISP 建立连接，才能上网。这个联网的过程就是 ISP 和我们主机建立点对点连接的过程。

*PPP(Point-to-Point Protocol)* 协议是指一套计算机通信协议，它提供通过点对点链路传输多种协议的数据。PPP 协议主要用于在 ISP 和用户之间点对点传输数据，不用过多考虑能不能传到位的问题，也不用考虑重发、流量控制这些问题，因为这些问题已经交给 TCP 来解决。而且 PPP 也不像以太网或者 FDDI 协议（我们后面会说）一样和物理层打交道，PPP 就是一个单纯的数据链路层协议。

所以 PPP 协议的设计需要考虑下面的因素：

1. 简单：在设计 PPP 的时候，只需要考虑的数据尽可能简单就行了。当主机收到对方发过来的帧后，就会进行 CRC 校验，如果校验正确，就收下这个帧，如果不正确，就直接丢弃。
2. 具有链路层协议的三个基本特征：即打包成帧，透明传输、差错检测。
3. 透明性：PPP 协议要保证传输数据是经过转义处理的，这和我们上面聊过的转义 ESC 是一样的。
4. 支持多种链路：不论是串行、并行，同步、异步，交换的、非交换的都支持。
5. 检测连接状态：PPP 能够在一段时间内检查链路的连接状态，检查链路是否处于正常工作状态。
6. 数据压缩。

### LCP 和 NCP

PPP 其实也是一个协议簇，它包含了两个协议，分别是 *LCP(Link Control Protocol)* 链路控制协议和 *NCP(Network Control Protocol)*网络控制协议。

LCP 的主要功能是用来建立、销毁、监控 PPP 链路的连接情况，比如链路是否存在环路、设置最大数据包的长度、使用哪种认证协议等，LCP 不依赖于上层协议。

>注意一点：PPP 协议的一个重要特点是可以提供**认证**功能，链路两端可以协商使用何种认证协议来实施认证过程，只有认证成功之后才会建立连接。

NCP 是一种网络控制协议，每个 NCP 都对应了一种网络层协议，如果是 IP 网络协议，那么 NCP 也叫做 *IPCP( IP Control Protocol)*，此时的 IPCP 负责设置 IP 地址等。

在 PPP 建立连接时，通常需要验证用户名和密码，而且对通信两端进行双方向的验证，验证方式有两种，分别是 *PAP(Password Authentication Protocol)* 和 *CHAP(Challenge Handshake Authentication Protocol)*。

PAP 使用密码进行验证，但是这个密码是明文的，所以存在安全性问题，一般适用于对于安全要求不是很高的环境。

CHAP 虽然也使用的密码，但是这种密码是一次性密码，使用这种方式可以防止密码窃听，在 PPP 双方建立连接之后会定期交换密码，来校验密码途中是否被替换。

### PPP 的帧格式

PPP 帧格式分为首部、信息部分和尾部三个模块，如下图所示。

![](http://www.cxuan.vip/image-20230123214332501.png)

首部分为 5 个字节，分别是 F（0x7E）、A（0xFF）、C（0x03），这些各占用一个字节，然后是 2 个字节的协议，中间是信息部分，一般信息部分不超过 1500 字节，尾部是 FCS 占用两字节，F（0x7E）占用一个字节。首部和尾部的 F 分别表示着帧头和帧尾，用来标识整个 PPP 帧。

首部中的第四个字段是协议字段，占用两个字节，如果协议是 0x0021 ，那么 PPP 信息部分就是 IP 数据报，如果协议是 0xC021 ，那么信息字段就 LCP 链路控制协议的数据。如果协议是 0x8021 ，那么就表示网络层的数据，如果是 0xC023 则表示鉴别数据。

当信息部分出现与标志字段一样的组合时，就需要采用一些措施来脱敏。脱敏的原则就是填充一些字段来使信息部分与标志字段错开，方式包括字节填充和零比特填充。

### PPPoE

*PPPoE(Pointer-to-Pointer over Ethernet)* 同样也是一种链路层协议，只不过他针对的是`以太网`上的点对点协议。由于 PPP 协议一个很重要的特征是提供了身份验证功能，但是这个身份验证却不知道验证的是哪个主机，也就是说 在 PPP 帧中并没有提供地址，而以太网会对链路上的所有主机进行广播，所以以太网也没有提供身份验证功能，在每个主机收到数据包之后，来自行判断数据包是不是发给自己的，这样很容易被伪造和窃听，所以通信是不安全的。

而 PPPoE 解决了 PPP 和以太网的痛点，PPPoE 通过对 PPP 帧进行封装，在实现点对点通信的基础上提供了身份验证、加密和压缩功能，而且 PPPoE 帧中还有一个 *Session_ID* 很好的保证了用户的安全性。下面是 PPPoE 的报文：

![](http://www.cxuan.vip/image-20230123214420581.png)

可以看到，PPPoE 新增了下面这些报文字段：Ver 为四位，表示 PPPoE 的版本，值为 0x1，Type 为四位，表示 PPPoE 的类型，值为 0x1，Code 表示 PPPoE 报文类型，Code域为 0x00，表示会话数据。Code域为 0x09，表示 PADI 报文；Code域为 0x07，表示 PADO 或 PADT 报文；Code 域为 0x19，表示 PADR 报文；Code 域为0x65，表示 PADS 报文。Session_ID 表示的是源地址和目的地址的会话 ID ，这个 ID 一般是固定的，最后 Length 是 2 字节，定义 PPPoE 的 Payload 域长度。不包括以太网头部和 PPPoE 头部的长度。

## 后记

这篇文章我为你介绍了计算机链路层的相关知识，链路层的作用以及相关链路层协议。

如果你在阅读文章的过程中发现错误和问题，请及时与我联系！

如果文章对你有帮助，希望小伙伴们三连走起！



