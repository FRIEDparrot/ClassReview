# 计算机网络的网络层

* [计算机网络的网络层](#计算机网络的网络层)
   * [网络层概述](#网络层概述)
   * [路由器工作原理](#路由器工作原理)
      * [输入端口](#输入端口)
      * [交换结构](#交换结构)
      * [输出端口处理](#输出端口处理)
   * [何时出现排队](#何时出现排队)
      * [输入队列](#输入队列)
      * [输出队列](#输出队列)
   * [分组调度](#分组调度)
      * [先进先出](#先进先出)
      * [优先级排队](#优先级排队)
      * [循环加权公平排队](#循环加权公平排队)
   * [IP 协议](#ip-协议)
      * [IP 地址](#ip-地址)
         * [IP 地址定义](#ip-地址定义)
         * [IP 地址构造和分类](#ip-地址构造和分类)
         * [子网掩码](#子网掩码)
         * [保留地址](#保留地址)
      * [IP 协议版本](#ip-协议版本)
      * [IPv4](#ipv4)
         * [IPv4 分片](#ipv4-分片)
         * [IPv4 寻址](#ipv4-寻址)
      * [IPv6](#ipv6)
         * [IPv6 扩展首部](#ipv6-扩展首部)
         * [IPv6 特点](#ipv6-特点)
         * [IPv6 地址](#ipv6-地址)
   * [如何从 IPv4 迁移到 IPv6](#如何从-ipv4-迁移到-ipv6)
      * [标志](#标志)
      * [隧道技术](#隧道技术)
   * [总结](#总结)

> 这是计算机网络连载系列的第五篇文章，前四篇文章见
>
> [计算机网络基础知识总结](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247486242&idx=1&sn=fac49b0b79515a5ed6afd4b341aff87b&chksm=e999fe30deee772637e1c52fb9001c60e60a772e7adba6701329c81974e76c57bb7b2e570225&token=850264305&lang=zh_CN#rd)
>
> [TCP/IP 基础知识总结](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247486408&idx=1&sn=c332ae7ae448f3eb98865003ecade589&chksm=e999fedadeee77cc6281d1b170bd906b58220d6cd83054bc741821f4167f1f18ceee9ba0e449&token=850264305&lang=zh_CN#rd)
>
> [计算机网络应用层](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247486507&idx=1&sn=622cc363b34bce54f4953076faa1cad6&chksm=e999f939deee702f2444df83ad9805de8c70fb88b89d299fdf0a82b3463e253f32372963c039&token=1398464113&lang=zh_CN#rd)
>
> [计算机网络传输层](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247487108&idx=1&sn=7b47f421bb1dee4edb357a10399b7fec&chksm=e999fb96deee7280a17bfff44c27ef11a60e93e48f9da738670a779ecf6accb5a6a4ebd3cbcc&token=1398464113&lang=zh_CN#rd)

前面我们学习了运输层如何为客户端和服务器输送数据的，提供进程端到端的通信。那么下面我们将学习网络层实际上是怎样实现主机到主机的通信服务的。**几乎每个端系统都有网络层这一部分**。所以，网络层必然是很重要的。下面我将花费大量篇幅来介绍一下计算机网络层的知识。

## 网络层概述

网络层是 OSI 参考模型的第三层，它位于传输层和链路层之间，网络层的主要目的是实现两个端系统之间透明的数据传输。

![](http://www.cxuan.vip/image-20230123101128221.png)

网络层的作用从表面看上去非常简单，即将分组从一台主机移动到另外一台主机。为了实现这个功能，网络层需要两种功能

* `转发`：因为在互联网中有很多路由器，这些路由器是构成互联网的基石，为什么这么说呢？因为路由器最重要的一个功能就是**分组转发**，就是靠着这些路由器，才会把一个个数据包通过链路传输给其他节点。当一个分组到达某路由器的一条输入链路时，该路由器会将分组移动到适当的输出链路。

* `路由选择`：当分组由发送方流向接收方时，网络层必须选择这些分组的路径。计算这些路径选择的算法被称为**路由选择算法(routing algorithm)**。

也就是说，**转发是指将分组从一个输入链路转移到适当输出链路接口的路由器行为，而路由选择是指确定分组从源到目的地所定位的路径的选择**。我们后面会经常提到转发和路由选择这两个名词。

>那么此处就有一个问题，路由器怎么知道有哪些路径可以选择呢？

每台路由器都有一个关键的概念就是**转发表(forwarding table)**。路由器通过检查数据包标头中字段的值，来定位转发表中的项来实现转发。标头中的值即对应着转发表中的值，这个值指出了分组将被转发的路由器输出链路。如下图所示

![](http://www.cxuan.vip/image-20230123163317073.png)

上图中有一个 1001 分组到达路由器后，首先会在转发表中进行索引，然后由路由选择算法决定分组要走的路径。每台路由器都有两种功能：**转发和路由选择**。下面我们就来聊一聊路由器的工作原理。

## 路由器工作原理

下面是一个路由器体系结构图，路由器主要是由 4 个组件构成。

![](http://www.cxuan.vip/image-20230123163342216.png)

* `输入端口`：它有很多功能。输入端口查找/转发功能对路由器的交换功能来说至关重要，由路由器的交换结构来决定输出端口，具体来讲应该是查询转发表来确定的。
* `交换结构`：就是将路由器的输入端口连接到它的输出端口。这种交换结构组成了是路由器内部的网络。
* `输出端口`：通过交换结构转发分组，并通过物理层和数据链路层的功能传输分组，因此，输出端口作为输入端口执行反向数据链接和物理层功能。
* `路由选择处理器`：在路由器内执行路由协议，维护路由表并执行网络管理功能。

上面只是这几个组件的简单介绍，其实这几个组件的组成并不像描述的那样简单，下面我们就来深入聊一聊这几个组件。

### 输入端口

上面介绍了输入端口有很多功能，包括线路终端、数据处理、查找转发，其实这些功能在输入端口的内部有相应的模块，输入端口的内部实现如下图所示。

![](http://www.cxuan.vip/image-20230123163406450.png)

每个输入端口中都有一个路由处理器维护的**路由表的副本**，根据路由处理器进行更新。这个路由表的副本能够使每个输入端口进行切换，而无需经过路由处理器统一处理。这是一种分散式的切换，这种方式避免了路由选择器统一处理造成转发瓶颈。

在输入端口处理能力有限的路由器中，输入端口不会进行交换功能，而是由路由处理器统一处理，然后根据路由表查找并将数据包转发到相应的输出端口。

>一般这种路由器不是单独的路由器，而是工作站或者服务器充当的路由，这种路由器内部中，路由处理器其实就是 CPU，而输入端口其实只是网卡。

输入端口会根据转发表定位输出端口，然后再会进行分组转发，那么现在就有一个问题，是不是每一个分组都有自己的一条链路呢？如果分组数量非常大，到达亿级的话，也会有亿个输出端口路径吗？

潜意识告诉我显然不是的，来看下面一个例子。

下面是三个输入端口对应了转发表中的三个输出链路的示例

![](http://www.cxuan.vip/image-20230123163439968.png)

可以看到，对于这个例子来说，路由器转发表中不需要那么多条链路，只需要四条就够，即对应输出链路 0 1 2 3 。也就是说，能够使用 4 个转发表就可以实现亿级链路。

> 如何实现呢？

使用这种风格的转发表，路由器分组的地址**前缀(prefix)**会与该表中的表项进行匹配。

![image-20230123164846642](http://www.cxuan.vip/image-20230123164846642.png)

如果存在一个匹配项，那么就会转发到对应的链路上，可能不好理解，我举个例子来说吧。

比如这时有一个分组是 11000011 10010101 00010000 0001100 到达，因为这个分组与 11000011 10010101 00010000 相匹配，所以路由器会转发到 0 链路接口上。如果一个前缀不匹配上面三个输出链路中的一种，那么路由器将向链路接口 3 进行转发。

路由匹配遵循**最长前缀原则(longest prefix matching rule)**，最长匹配原则说的是如果有两个匹配项一个长一个短的话，就匹配最长的。

一旦通过查找功能确定了分组的输出端口后，那么该分组就会进入交换结构。在进入交换结构时，如果交换结构正在被使用，就会阻塞新到的分组，等到交换结构调度新的分组。

### 交换结构

交换结构是路由器的核心，通过交换功能把分组从输入端口转发至输出端口，这就是交换结构的主要功能。交换结构有多种形式，包括**通过内存交换、通过总线交换、通过互联网络进行交换**，下面我们分开来探讨一下。

* 经过内存交换：最开始的传统计算机就是使用内存交换的，在输入端口和输出端口之间是通过 CPU 进行的。输入端口和输出端口的功能就好像传统操作系统中的 I/O 设备一样。当一个分组到达输入端口时，这个端口会首先以中断的方式向路由选择器发出信号，将分组从输入端口拷贝到内存中。然后路由选择处理器从分组首部中提取目标地址，在转发表中找出适当的输出端口进行转发，同时将分组复制到输出端口的缓存中。

>这里需要注意一点，如果内存带宽以每秒读取或者写入 B 个数据包，那么总的交换机吞吐量(数据包从输入端口到输出端口的总速率) 必须小于 B/2。

![](http://www.cxuan.vip/image-20230123165525924.png)

* 经过总线交换：在这种处理方式中，总线经由输入端口直接将分组传送到输出端口，中间不需要路由选择器的干预。总线的工作流程如下：输入端口给分组分配一个标签，然后分组经由总线发送给所有的输出端口，每个输出端口都会判断标签中的端口和自己的是否匹配，如果匹配的话，那么这个输出端口就会把标签拆掉，这个标签只用于交换机内部跨越总线。如果同时有多个分组到达路由器的话，那么只有一个分组能够被处理，其他分组需要再进入交换结构前等待。

![](http://www.cxuan.vip/image-20230123165551128.png)

* 经过互联网络交换：克服单一、共享式总线带宽限制的一种方法是使用一个更复杂的互联网络。如下图所示

![](http://www.cxuan.vip/image-20230123165640380.png)

每条垂直的的总线在交叉点与每条水平的总线交叉，交叉点通过交换结构控制器能够在任何时候开启和闭合。当分组到达输入端口 A 时，如果需要转发到端口 X，交换机控制器会闭合 A 到 X 交叉部分的交叉点，然后端口 A 在总线上进行分组转发。这种网络互联式的交换结构是**非阻塞的(non-blocking)**的，也就是说 A -> X 的交叉点闭合不会影响 B -> Y 的链路。如果来自两个不同输入端口的两个分组其目的地为相同的输出端口的话，这种情况下只能有一个分组被交换，另外一个分组必须进行等待。

### 输出端口处理

如下图所示，输出端口取出已经存放在输出端口内存中的分组并将其发送到输出链路上。包括选择和去除排队的分组进行传输，执行所需的链路层和物理层的功能。

![](http://www.cxuan.vip/image-20230123165718307.png)

在输入端口中有等待进入交换的排队队列，而在输出端口中有等待转发的排队队列，排队的位置和程度取决于**流量负载、交换结构**的相对频率和线路速率。

随着队列的不断增加，会导致路由器的缓存空间被耗尽，进而使没有内存可以存储溢出的队列，致使分组出现丢包，这就是我们说的在网络中丢包或者被路由器丢弃。

## 何时出现排队

下面我们通过输入端口的排队队列和输出端口的排队队列来介绍一下可能出现的排队情况。

### 输入队列

如果交换结构的处理速度没有输入队列到达的速度快，在这种情况下，输入端口将会出现排队情况，到达交换结构前的分组会加入输入端口队列中，以等待通过交换结构传送到输出端口。

为了描述清楚输入队列，我们假设以下情况：

* 使用网络互联的交换方式；
* 假定所有链路的速度相同；
* 在链路中一个分组由输入端口交换到输出端口所花的时间相同，从任意一个输入端口传送到给定的输出端口；
* 分组按照 FCFS 的方式，只要输出端口不同，就可以进行并行传送。但是如果位于任意两个输入端口中的分组是发往同一个目的地的，那么其中的一个分组将被阻塞，而且必须在输入队列中等待，因为交换结构一次只能传输一个到指定端口。

如下图所示。

![](http://www.cxuan.vip/image-20230123165806821.png)

在 A 队列中，输入队列中的两个分组会发送至同一个目的地 X，假设在交换结构正要发送 A 中的分组，在这个时候，C 队列中也有一个分组发送至 X，在这种情况下，C 中发送至 X 的分组将会等待，不仅如此，C 队列中发送至 Y 输出端口的分组也会等待，即使 Y 中没有出现竞争的情况。这种现象叫做**线路前部阻塞(Head-Of-The-Line, HOL)**。

### 输出队列

我们下面讨论输出队列中出现等待的情况。假设交换速率要比输入/输出的传输速率快很多，而且有 N 个输入分组的目的地是转发至相同的输出端口。在这种情况下，在向输出链路发送分组的过程中，将会有 N 个新分组到达传输端口。因为输出端口在一个单位时间内只能传输一个分组，那么这 N 个分组将会等待。然而在等待 N 个分组被处理的过程中，同时又有 N 个分组到达，所以 ，分组队列能够在输出端口形成。这种情况下最终会因为分组数量变的足够大，从而耗尽输出端口的可用内存。

如果没有足够的内存来缓存分组的话，就必须考虑其他的方式，主要有两种：一种是丢失分组，采用*弃尾(drop-tail)*的方法；一种是删除一个或多个已经排队的分组，从而来为新的分组腾出空间。

>网络层的策略对 TCP 拥塞控制影响很大的就是路由器的分组丢弃策略。在最简单的情况下，路由器的队列通常都是按照 FCFS 的规则处理到来的分组。由于队列长度总是有限的，因此当队列已经满了的时候，以后再到达的所有分组（如果能够继续排队，这些分组都将排在队列的尾部）将都被丢弃。这就叫做尾部丢弃策略。

通常情况下，在缓冲填满之前将其丢弃是更好的策略。

![](http://www.cxuan.vip/image-20230123165846964.png)

如上图所示，A B C 每个输入端口都到达了一个分组，而且这个分组都是发往 X 的，同一时间只能处理一个分组，然后这时，又有两个分组分别由 A B 发往 X，所以此时有 4 个分组在 X 中进行等待。

![](http://www.cxuan.vip/image-20230123165918304.png)

等上一个分组被转发完成后，输出端口就会选择在剩下的分组中根据*分组调度(packet scheduleer)*选择一个分组来进行传输，我们下面就会聊到分组传输。

## 分组调度

现在我们来讨论一下分组调度次序的问题，即排队的分组如何经输出链路传输的问题。我们生活中有无数排队的例子，但是我们生活中一般的排队算法都是*先来先服务(FCFS)*，也是*先进先出(FIFO)*。

### 先进先出

先进先出就映射为数据结构中的队列，只不过它现在是链路调度规则的排队模型。

![](http://www.cxuan.vip/image-20230123165939996.png)

FIFO 调度规则按照分组到达输出链路队列的相同次序来选择分组，先到达队列的分组将先会被转发。在这种抽象模型中，如果队列已满，那么弃尾的分组将是队列末尾的后面一个。

### 优先级排队

优先级排队是先进先出排队的改良版本，到达输出链路的分组被分类放入输出队列中的优先权类，如下图所示

![](http://www.cxuan.vip/image-20230123165957438.png)

通常情况下，每个优先级不同的分组有自己的优先级类，每个优先级类有自己的队列，分组传输会首先从优先级高的队列中进行，在同一类优先级的分组之间的选择通常是以 FIFO 的方式完成。

### 循环加权公平排队

在**循环加权公平规则(round robin queuing discipline)**下，分组像使用优先级那样被分类。然而，在类之间却不存在严格的服务优先权。循环调度器在这些类之间循环轮流提供服务。如下图所示

![](http://www.cxuan.vip/image-20230123170012854.png)

在循环加权公平排队中，类 1 的分组被传输，接着是类 2 的分组，最后是类 3 的分组，这算是一个循环，然后接下来又重新开始，又从 1 -> 2 -> 3 这个顺序进行轮询。每个队列也是一个先入先出的队列。

这是一种所谓的保持工作排队的规则，就是说如果轮询的过程中发现有空队列，输出端口不会等待分组，而是继续轮询下面的队列。

## IP 协议

路由器对分组进行转发后，就会把数据包传到网络上，数据包最终是要传递到客户端或者服务器上的，那么数据包怎么知道要发往哪里呢？起到关键作用的就是 IP 协议。

IP 主要分为三个部分，分别是 **IP 寻址、路由和分包组包**。下面我们主要围绕这三点进行阐述。

### IP 地址

既然一个数据包要在网络上传输，那么肯定需要知道这个数据包到底发往哪里，也就是说需要一个目标地址信息，**IP 地址就是连接网络中的所有主机进行通信的目标地址**。因此，在网络上的每个主机都需要有自己的 IP 地址。

![](http://www.cxuan.vip/image-20230123170130077.png)

在 IP 数据报发送的链路中，有可能链路非常长，比如说由中国发往美国的一个数据报，由于网络抖动等一些意外因素可能会导致数据报丢失，这时我们在这条链路中会放入一些中转站，一方面能够判断数据报是否丢失，另一方面能够控制数据报的转发，这个中转站就是我们前面聊过的路由器，这个转发过程就是路由控制。

**路由控制(Routing)**是指将分组数据发送到最终目标地址的功能，即使网络复杂多变，也能够通过路由控制到达目标地址。因此，一个数据报能否到达目标主机，关键就在于路由器的控制。

这里有一个名词，就是 `跳`，因为在一条链路中可能会布满很多路由器，路由器和路由器之间的数据报传送就是跳，比如你和隔壁老王通信，中间就可能会经过路由器 A-> 路由器 B -> 路由器 C 。

>那么一跳的范围有多大呢？

**一跳是指从源 MAC 地址到目标 MAC 地址之间传输帧的区间**，这里引出一个新的名词，MAC 地址是啥？

MAC 地址指的就是计算机的**物理地址(Physical Address)**，它是用来确认网络设备位置的地址。在 OSI 网络模型中，网络层负责 IP 地址的定位，而数据链路层负责 MAC 地址的定位。MAC 地址用于在网络中唯一标示一个网卡，一台设备若有一或多个网卡，则每个网卡都需要并会有一个唯一的 MAC 地址，也就是说 MAC 地址和网卡是紧密联系在一起的。

路由器的每一跳都需要询问当前中转的路由器，下一跳应该跳到哪里，从而跳转到目标地址。而不是数据报刚开始发送后，网络中所有的通路都会显示出来，这种多次跳转也叫做多跳路由。

#### IP 地址定义

现如今有两个版本的 IP 地址，IPv4 和 IPv6，我们首先探讨一下现如今还在广泛使用的 IPv4 地址，后面再考虑 IPv6 。

IPv4 由 32 位正整数来表示，在计算机内部会转化为二进制来处理，但是二进制不符合人类阅读的习惯，所以我们根据易读性的原则把 32 位的 IP 地址以 8 位为一组，分成四组，每组之间以 `.` 进行分割，再将每组转换为十进制数。如下图所示

![](http://www.cxuan.vip/image-20230123170243506.png)

那么上面这个 32 位的 IP 地址就会被转换为十进制的 156.197.1.1。

除此之外，从图中我们还可以得到如下信息

每个这样 8 位位一组的数字，自然是非负数，其取值范围是 [0,255]。

IP 地址的总个数有 2^32 次幂个，这个数值算下来是 4294967296 ，大概能允许 43 亿台设备连接到网络。实际上真的如此吗？

实际上 IP 不会以主机的个数来配置的，而是根据设备上的 `网卡(NIC)` 进行配置，每一块网卡都会设置一个或者多个 IP 地址，而且通常一台路由器会有至少两块网卡，所以可以设置两个以上的 IP 地址，所以主机的数量远远达不到 43 亿。

![](http://www.cxuan.vip/image-20230123170320242.png)

#### IP 地址构造和分类

IP 地址由 `网络标识` 和 `主机标识` 两部分组成，网络标识代表着网络地址，主机标识代表着主机地址。网络标识在数据链路的每个段配置不同的值。网络标识必须保证相互连接的每个段的地址都不重复。而相同段内相连的主机必须有相同的网络地址。IP 地址的 `主机标识` 则不允许在同一网段内重复出现。

举个例子来说：比如说我在石家庄(好像不用比如昂)，我所在的小区的某一栋楼就相当于是网络标识，某一栋楼的第几户就相当于是我的主机标识，当然如果你有整栋楼的话，那就当我没说。你可以通过xx省xx市xx区xx路xx小区xx栋来定位我的网络标识，这一栋的第几户就相当于是我的网络标识。

IP 地址分为四类，分别是 **A类、B类、C类、D类、E类**，它会根据 IP 地址中的第 1 位到第 4 位的比特对网络标识和主机标识进行分类。

* `A 类`：(1.0.0.0 - 126.0.0.0)（默认子网掩码：255.0.0.0 或 0xFF000000）第一个字节为网络号，后三个字节为主机号。该类 IP 地址的最前面为 0 ，所以地址的网络号取值于 1~126 之间。一般用于大型网络。

* `B 类`：(128.0.0.0 - 191.255.0.0)（默认子网掩码：255.255.0.0 或 0xFFFF0000）前两个字节为网络号，后两个字节为主机号。该类 IP 地址的最前面为 10 ，所以地址的网络号取值于 128~191 之间。一般用于中等规模网络。

* `C 类`：(192.0.0.0 - 223.255.255.0)（子网掩码：255.255.255.0 或 0xFFFFFF00）前三个字节为网络号，最后一个字节为主机号。该类 IP 地址的最前面为 110 ，所以地址的网络号取值于 192~223 之间。一般用于小型网络。

* `D 类`：是多播地址。该类 IP 地址的最前面为 1110 ，所以地址的网络号取值于 224~239 之间。一般用于多路广播用户。

* `E 类`：是保留地址。该类 IP 地址的最前面为 1111 ，所以地址的网络号取值于 240~255 之间。

为了方便理解，我画了一张 IP 地址分类图，如下所示

![](http://www.cxuan.vip/image-20230123170506425.png)

根据不同的 IP 范围，有下面不同的地总空间分类

![](http://www.cxuan.vip/image-20230123170533495.png)

#### 子网掩码

**子网掩码(subnet mask)**又叫做网络掩码，它是一种用来指明一个 IP 地址的哪些位标识的是主机所在的网络。子网掩码是一个 32位 地址，用于屏蔽 IP 地址的一部分以区别网络标识和主机标识。

一个 IP 地址只要确定了其分类，也就确定了它的网络标识和主机标识，由此，各个分类所表示的网络标识范围如下

![](http://www.cxuan.vip/image-20230123170750121.png)

用 `1` 表示 IP 网络地址的比特范围，`0` 表示 IP 主机地址的范围。将他们用十进制表示，那么这三类的表示如下

![](http://www.cxuan.vip/image-20230123170801513.png)

#### 保留地址

在IPv4 的几类地址中，有几个保留的地址空间不能在互联网上使用。这些地址用于特殊目的，不能在局域网外部路由。

| 地址块         | 地址范围                    | 地址数      | 描述                     |
| -------------- | --------------------------- | ----------- | ------------------------ |
| 0.0.0.0/8      | 0.0.0.0–0.255.255.255       | 16 777 216  | 当前网络                 |
| 10.0.0.0/8     | 10.0.0.0–10.255.255.255     | 16 777 216  | 专用网络的本地通信       |
| 127.0.0.0/8    | 127.0.0.0–127.255.255.255   | 16 777 216  | 用于回环的本地地址       |
| 172.16.0.0/12  | 172.16.0.0–172.31.255.255   | 1 048 576   | 用于专用网络内的本地通信 |
| 192.168.0.0/16 | 192.168.0.0–192.168.255.255 | 65 536      | 用于专用网络内的本地通信 |
| 224.0.0.0/4    | 224.0.0.0–239.255.255.255   | 268 435 456 | 用于 IP 多播             |
| 192.0.0.0/24   | 192.0.0.0–192.0.0.255       | 256         | IETF协议分配             |

### IP 协议版本

目前，全球 Internet 中共存有两个IP版本：**IP 版本 4（IPv4）**和 **IP 版本6（IPv6）**。 IP 地址由二进制值组成，可驱动 Internet 上所有数据的路由。 IPv4 地址的长度为 32 位，而 IPv6 地址的长度为 128 位。

Internet IP 资源由 Internet 分配号码机构（IANA）分配给区域 Internet 注册表（RIR），例如 APNIC，该机构负责根 DNS ，IP 寻址和其他 Internet 协议资源。

下面我们就一起认识一下 IP 协议中非常重要的两个版本 IPv4 和 IPv6。

### IPv4

IPv4 的全称是 *Internet Protocol version 4*，是 Internet 协议的第四版。IPv4 是一种无连接的协议，这个协议会尽最大努力交付数据包，也就是说它不能保证任何数据包能到达目的地，也不能保证所有的数据包都会按照正确的顺序到达目标主机，这些都是由上层比如传输控制协议控制的。也就是说，单从 IP 看来，这是一个不可靠的协议。

>前面我们讲过网络层分组被称为数据报，所以我们接下来的叙述也会围绕着数据报展开。

IPv4 的数据报格式如下

![](http://www.cxuan.vip/image-20230123171038242.png)

IPv4 数据报中的关键字及其解释

* `版本字段(Version)`占用 4 bit，通信双方使用的版本必须一致，对于 IPv4 版本来说，字段值是 4。
* `首部长度(Internet Header Length)` 占用 4 bit，首部长度说明首部有多少 32 位(4 字节)。由于 IPv4 首部可能包含不确定的选项，因此这个字段被用来确定数据的偏移量。大多数 IP 不包含这个选项，所以一般首部长度设置为 5， 数据报为 20 字节 。
* `服务类型(Differential Services Codepoint，DSCP)` 占用 6 bit，以便使用不同的 IP 数据报，比如一些低时延、高吞吐量和可靠性的数据报。服务类型如下表所示

![](http://www.cxuan.vip/image-20230123171115542.png)

* `拥塞通告(Explicit Congestion Notification，ECN)` 占用 2 bit，它允许在不丢弃报文的同时通知对方网络拥塞的发生。ECN 是一种可选的功能，仅当两端都支持并希望使用，且底层网络支持时才被使用。		最开始 DSCP 和 ECN 统称为 TOS，也就是区分服务，但是后来被细化为了 DSCP 和 ECN。

* `数据报长度(Total Length)` 占用 16 bit，这 16 位是包括在数据在内的总长度，理论上数据报的总长度为 2 的 16 次幂 - 1，最大长度是 65535 字节，但是实际上数据报很少有超过 1500 字节的。IP 规定所有主机都必须支持最小 576 字节的报文，但大多数现代主机支持更大的报文。当下层的数据链路协议的`最大传输单元（MTU）`字段的值小于 IP 报文长度时，报文就必须被分片。

* `标识符(Identification)` 占用 16 bit，这个字段用来标识所有的分片，因为分片不一定会按序到达，所以到达目标主机的所有分片会进行重组，每产生一个数据报，计数器加1，并赋值给此字段。

* `标志(Flags)` 占用 3 bit，标志用于控制和识别分片，这 3 位分别是

  * 0 位：保留，必须为0；
  * 1 位：`禁止分片（Don’t Fragment，DF）`，当 DF = 0 时才允许分片；
  * 2 位：`更多分片（More Fragment，MF）`，MF = 1 代表后面还有分片，MF = 0 代表已经是最后一个分片。

  如果 DF 标志被设置为 1 ，但是路由要求必须进行分片，那么这条数据报回丢弃

* `分片偏移(Fragment Offset)` 占用 13 位，它指明了每个分片相对于原始报文开头的偏移量，以 8 字节作单位。

* `存活时间(Time To Live，TTL)` 占用 8 位，存活时间避免报文在互联网中`迷失`，比如陷入路由环路。存活时间以秒为单位，但小于一秒的时间均向上取整到一秒。在现实中，这实际上成了一个跳数计数器：报文经过的每个路由器都将此字段减 1，当此字段等于 0 时，报文不再向下一跳传送并被丢弃，这个字段最大值是 255。

* `协议(Protocol)` 占用 8 位，这个字段定义了报文数据区使用的协议。协议内容可以在 https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml 官网上获取。

* `首部校验和(Header Checksum)` 占用 16 位，首部校验和会对字段进行纠错检查，在每一跳中，路由器都要重新计算出的首部检验和并与此字段进行比对，如果不一致，此报文将会被丢弃。

* `源地址(Source address)` 占用 32 位，它是 IPv4 地址的构成条件，源地址指的是数据报的发送方

* `目的地址(Destination address)`占用 32 位，它是 IPv4 地址的构成条件，目标地址指的是数据报的接收方

* `选项(Options)` 是附加字段，选项字段占用 1 - 40 个字节不等，一般会跟在目的地址之后。如果首部长度 > 5，就应该考虑选项字段。

* `数据` 不是首部的一部分，因此并不被包含在首部检验和中。

在 IP 发送的过程中，每个数据报的大小是不同的，每个链路层协议能承载的网络层分组也不一样，有的协议能够承载大数据报，有的却只能承载很小的数据报，不同的链路层能够承载的数据报大小如下。

![](http://www.cxuan.vip/image-20230123171139751.png)

#### IPv4 分片

一个链路层帧能承载的最大数据量叫做**最大传输单元(Maximum Transmission Unit, MTU)**，每个 IP 数据报封装在链路层帧中从一台路由器传到下一台路由器。因为每个链路层所支持的最大 MTU 不一样，当数据报的大小超过 MTU 后，会在链路层进行分片，每个数据报会在链路层单独封装，每个较小的片都被称为 `片(fragement)`。

![](http://www.cxuan.vip/image-20230123171156308.png)

每个片在到达目的地后会进行重组，准确的来说是在运输层之前会进行重组，TCP 和 UDP 都会希望发送完整的、未分片的报文，出于性能的原因，分片重组不会在路由器中进行，而是会在目标主机中进行重组。

当目标主机收到从发送端发送过来的数据报后，它需要确定这些数据报中的分片是否是由源数据报分片传递过来的，如果是的话，还需要确定何时收到了分片中的`最后一片`，并且这些片会如何拼接一起成为数据报。

针对这些潜在的问题，IPv4 设计者将 **标识、标志和片偏移**放在 IP 数据报首部中。当生成一个数据报时，发送主机会为该数据报设置源和目的地址的同时贴上`标识号`。发送主机通常将它发送的每个数据报的标识 + 1。当某路由器需要对一个数据报分片时，形成的每个数据报具有初始数据报的**源地址、目标地址和标识号**。当目的地从同一发送主机收到一系列数据报时，它能够检查数据报的标识号以确定哪些数据是由源数据报发送过来的。由于 IP 是一种不可靠的服务，分片可能会在网路中丢失，鉴于这种情况，通常会把分片的最后一个比特设置为 0 ，其他分片设置为 1，同时使用偏移字段指定分片应该在数据报的哪个位置。

### IPv6

随着端系统接入的越来越多，IPv4 已经无法满足分配了，所以，IPv6 应运而生，IPv6 就是为了解决 IPv4 的地址耗尽问题而被标准化的网际协议。IPv4 的地址长度为 4 个 8 字节，即 32 比特， 而 IPv6 的地址长度是原来的四倍，也就是 128 比特，一般写成 8 个 16 位字节。

从 IPv4 切换到 IPv6 及其耗时，需要将网络中所有的主机和路由器的 IP 地址进行设置，在互联网不断普及的今天，替换所有的 IP 是一个工作量及其庞大的任务。我们后面会说。

我们先来看一下 IPv6 的地址是怎样的

![](http://www.cxuan.vip/image-20230123171227314.png)

* `版本`与 IPv4 一样，版本号由 4 bit 构成，IPv6 版本号的值为 6。
* `流量类型(Traffic Class)` 占用 8 bit，它就相当于 IPv4 中的服务类型(Type Of Service)。
* `流标签(Flow Label)` 占用 20 bit，这 20 比特用于标识一条数据报的流，能够对一条流中的某些数据报给出优先权，或者它能够用来对来自某些应用的数据报给出更高的优先权，只有流标签、源地址和目标地址一致时，才会被认为是一个流。
* `有效载荷长度(Payload Length)` 占用 16 bit，这 16 比特值作为一个无符号整数，它给出了在 IPv6 数据报中跟在鼎昌 40 字节数据报首部后面的字节数量。
* `下一个首部(Next Header)` 占用 8 bit，它用于标识数据报中的内容需要交付给哪个协议，是 TCP 协议还是 UDP 协议。
* `跳限制(Hop Limit)` 占用 8 bit，这个字段与 IPv4 的 TTL 意思相同。数据每经过一次路由就会减 1，减到 0 则会丢弃数据。
* `源地址(Source Address)` 占用 128 bit (8 个 16 位 )，表示发送端的 IP 地址。
* `目标地址(Destination Address)` 占用 128 bit (8 个 16 位 )，表示接收端 IP 地址。

可以看到，相较于 IPv4 ，IPv6 取消了下面几个字段

* **标识符、标志和比特偏移**：IPv6 不允许在中间路由器上进行分片和重新组装。这种操作只能在端系统上进行，IPv6 将这个功能放在端系统中，加快了网络中的转发速度。
* **首部校验和**：因为在运输层和数据链路执行了报文段完整性校验工作，IP 设计者大概觉得在网络层中有首部校验和比较多余，所以去掉了。**IP 更多专注的是快速处理分组数据**。
* **选项字段**：选项字段不再是标准 IP 首部的一部分了，但是它并没有消失，而是可能出现在 IPv6 的扩展首部，也就是下一个首部中。

#### IPv6 扩展首部

IPv6 首部长度固定，无法将选项字段加入其中，取而代之的是 IPv6 使用了扩展首部。

扩展首部通常介于 IPv6 首部与 TCP/UDP 首部之间，在 IPv4 中可选长度固定为 40 字节，在 IPv6 中没有这样的限制。IPv6 的扩展首部可以是任意长度。扩展首部中还可以包含扩展首部协议和下一个扩展字段。

IPv6 首部中没有标识和标志字段，**对 IP 进行分片时，需要使用到扩展首部**。

![](http://www.cxuan.vip/image-20230123171241489.png)

具体的扩展首部表如下所示

![](http://www.cxuan.vip/image-20230123171305010.png)

下面我们来看一下 IPv6 都有哪些特点

#### IPv6 特点

IPv6 的特点在 IPv4 中得以实现，但是即便实现了 IPv4 的操作系统，也未必实现了 IPv4 的所有功能。而 IPv6 却将这些功能大众化了，也就表明这些功能在 IPv6 已经进行了实现，这些功能主要有

* **地址空间变得更大**：这是 IPv6 最主要的一个特点，即支持更大的地址空间。
* **精简报文结构**: IPv6 要比 IPv4 精简很多，IPv4 的报文长度不固定，而且有一个不断变化的选项字段；IPv6 报文段固定，并且将选项字段，分片的字段移到了  IPv6 扩展头中，这就极大的精简了 IPv6 的报文结构。
* **实现了自动配置**：IPv6 支持其主机设备的**状态和无状态**自动配置模式。这样，没有 `DHCP 服务器`不会停止跨段通信。
* **层次化的网络结构**： IPv6 不再像 IPv4 一样按照 A、B、C等分类来划分地址，而是通过 IANA -> RIR -> ISP 这样的顺序来分配的。IANA 是国际互联网号码分配机构，RIR 是区域互联网注册管理机构，ISP 是一些运营商（例如电信、移动、联通）。
* **IPSec**：IPv6 的扩展报头中有一个认证报头、封装安全净载报头，这两个报头是 IPsec 定义的。通过这两个报头网络层自己就可以实现端到端的安全，而无需像 IPv4 协议一样需要其他协议的帮助。

* **支持任播**：IPv6 引入了一种新的寻址方式，称为任播寻址。

#### IPv6 地址

我们知道，IPv6 地址长度为 128 位，他所能表示的范围是 2 ^ 128 次幂，这个数字非常庞大，几乎涵盖了你能想到的所有主机和路由器，那么 IPv6 该如何表示呢？

一般我们将 128 比特的 IP 地址以每 16 比特为一组，并用 `:` 号进行分隔，如果出现连续的 0 时还可以将 0 省略，并用 `::` 两个冒号隔开，记住，一个 IP 地址只允许出现一次两个连续的冒号。

下面是一些 IPv6 地址的示例

* 二进制数表示

![](http://www.cxuan.vip/image-20230123171325158.png)

* 用十六进制数表示

![](http://www.cxuan.vip/image-20230123171339960.png)

* 出现两个冒号的情况

![](http://www.cxuan.vip/image-20230123171352657.png)

如上图所示，A120 和 4CD 中间的 0 被 :: 所取代了。

## 如何从 IPv4 迁移到 IPv6

我们上面聊了聊 IPv4 和 IPv6 的报文格式、报文含义是什么、以及 IPv4 和 IPv6 的特征分别是什么，看完上面的内容，你已经知道了 IPv4 现在马上就变的不够用了，而且随着 IPv6 的不断发展和引用，虽然新型的 IPv6 可以做到`向后兼容`，即 IPv6 可以收发 IPv4 的数据报，但是**已经部署的具有 IPv4 能力的系统却不能够处理 IPv6 数据报**。所以 IPv4 噬需迁移到 IPv6，迁移并不意味着将 IPv4 替换为 IPv6。这仅意味着同时启用 IPv6 和 IPv4。

>那么现在就有一个问题了，IPv4 如何迁移到 IPv6 呢？这就是我们接下来讨论的重点。

### 标志

最简单的方式就是设置一个标志日，指定某个时间点和日期，此时全球的因特网机器都会在这时关机从 IPv4 迁移到 IPv6 。上一次重大的技术迁移是在 35 年前，但是很显然，不用我过多解释，这种情况肯定是 `不行的`。影响不可估量不说，如何保证全球人类都能知道如何设置自己的 IPv6 地址？一个设计数十亿台机器的标志日现在是想都不敢想的。

### 隧道技术

现在已经在实践中使用的从 IPv4 迁移到 IPv6 的方法是 `隧道技术(tunneling)`。

>什么是隧道技术呢？

隧道技术是一种使用互联网络的基础设施在网络之间的传输数据的方式，使用隧道传递的数据可以是不同协议的数据帧或包。使用隧道技术所遵从的协议叫做`隧道协议(tunneling protocol)`。隧道协议会将这些协议的数据帧或包封装在新的包头中发送。新的包头提供了路由信息，从而使封装的负载数据能够通过互联网络进行传递。

使用隧道技术一般都会建一个`隧道`，建隧道的依据如下：

比如两个 IPv6 节点(下方 B、E)要使用 IPv6 数据报进行交互，但是它们是经由两个 IPv4 的路由器进行互联的。那么我们就需要将 IPv6 节点和 IPv4 路由器组成一个隧道，如下图所示

![](http://www.cxuan.vip/image-20230123171422184.png)

借助于隧道，在隧道发送端的 IPv6 节点可将整个 IPv6 数据报放到一个 IPv4 数据报的`数据(有效载荷)` 字段中，于是，IPv4 数据报的地址被设置为指向隧道接收端的 IPv6 的节点，比如上面的 E 节点。然后再发送给隧道中的第一个节点 C，如下所示

![](http://www.cxuan.vip/image-20230123171434504.png)

隧道中间的 IPv4 提供路由，路由器不知道这个 IPv4 内部包含一个指向 IPv6 的地址。隧道接收端的 IPv6 节点收到 IPv4 数据报，会确定这个 IPv4 数据报含有一个 IPv6 数据报，通过观察数据报长度和数据得知。然后取出 IPv6 数据报，再为 IPv6 提供路由，就好像两个节点直接相连传输数据报一样。

## 总结

这篇文章是计算机网络系列的连载文章，这篇我们主要探讨了网络层的相关知识、路由器的内部构造、路由器如何实现转发的，IP 协议相关内容：包括 IP 地址、IPv4 和 IPv6 的相关内容，最后我们探讨了如何使 IPv4 迁移到 IPv6 。

如果你在阅读文章的过程中发现错误和问题，请及时与我联系！

如果文章对你有帮助，希望小伙伴们三连走起！

