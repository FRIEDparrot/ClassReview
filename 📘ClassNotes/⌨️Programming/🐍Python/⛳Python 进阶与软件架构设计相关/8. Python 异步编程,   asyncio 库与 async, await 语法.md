Python å¼‚æ­¥ç¼–ç¨‹å…è®¸ç¨‹åºåœ¨ç­‰å¾…è€—æ—¶æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰æ—¶æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸æ˜¯è¢«é˜»å¡ã€‚ä¸‹é¢æˆ‘å°†é¦–å…ˆä»‹ç» asyncio åº“çš„æ ¸å¿ƒæ¦‚å¿µå’Œå·¥å…·ï¼Œç„¶åè¯¦ç»†è§£é‡Š async/await è¯­æ³•çš„ä½¿ç”¨ã€‚ 
## ä¸€ã€asyncio åº“ä»‹ç» 
asyncio æ˜¯ Python æ ‡å‡†åº“ä¸­å®ç°å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒæ¨¡å—ï¼Œæä¾›äº†è¿è¡Œå’Œç®¡ç†åç¨‹çš„åŸºç¡€è®¾æ–½ã€‚  
### 1. æ ¸å¿ƒæ¦‚å¿µ

**äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰**ï¼šå¼‚æ­¥åº”ç”¨çš„æ ¸å¿ƒï¼Œè´Ÿè´£è°ƒåº¦å’Œè¿è¡Œåç¨‹ã€å¤„ç†ç½‘ç»œ I/O äº‹ä»¶ã€è¿è¡Œå­è¿›ç¨‹ç­‰ã€‚

```python
import asyncio

# è·å–äº‹ä»¶å¾ªç¯
loop = asyncio.get_event_loop()

# Python 3.7+ æ¨èä½¿ç”¨ asyncio.run() ä»£æ›¿æ˜¾å¼æ“ä½œäº‹ä»¶å¾ªç¯
# asyncio.run(main())
```
### 2. å¸¸ç”¨ API åŠç¤ºä¾‹
#### asyncio.run(coro, `*`, debug=False) 
<b><mark style="background: transparent; color: orange">å¯åŠ¨äº‹ä»¶å¾ªç¯å¹¶è¿è¡Œåç¨‹ç›´åˆ°å®Œæˆï¼Œç„¶åå…³é—­å¾ªç¯</mark></b>ã€‚è¿™æ˜¯è¿è¡Œå¼‚æ­¥ç¨‹åºçš„æ¨èæ–¹å¼ï¼ˆPython 3.7+ï¼‰ã€‚
**å‚æ•°** :  
- `coro`ï¼šè¦è¿è¡Œçš„åç¨‹å¯¹è±¡
- `debug`ï¼šæ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼

```python
import asyncio

async def main():
    print("Hello")
    await asyncio.sleep(1)
    print("World")

# è¿è¡Œä¸»åç¨‹
asyncio.run(main())
```

#### asyncio.create_task(coro, `*`, name=None)

å°†åç¨‹åŒ…è£…ä¸ºä¸€ä¸ª Task å¹¶è°ƒåº¦å…¶æ‰§è¡Œã€‚Task æ˜¯ Future çš„å­ç±»ï¼Œä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆç»“æœã€‚

**å‚æ•°**ï¼š

- `coro`ï¼šè¦åŒ…è£…çš„åç¨‹
- `name`ï¼šä»»åŠ¡åç§°ï¼ˆå¯é€‰ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰

```python
async def say_after(delay, what):
    await asyncio.sleep(delay)
    print(what)

async def main():
    # åˆ›å»ºä¸¤ä¸ªä»»åŠ¡
    task1 = asyncio.create_task(say_after(1, "hello"))
    task2 = asyncio.create_task(say_after(2, "world"))
    
    print(f"started at {asyncio.get_running_loop().time()}")
    
    # ç­‰å¾…ä¸¤ä¸ªä»»åŠ¡å®Œæˆ
    await task1
    await task2
    
    print(f"finished at {asyncio.get_running_loop().time()}")
```

éœ€è¦è¯´æ˜,  create_task æœ¬èº«æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œ å› æ­¤åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡è®©å®ƒåœ¨åå°æ‰§è¡Œï¼Œ åªéœ€ä½¿ç”¨ : 
```python
asyncio.create_task(self.wait_for_close(TwoPC_DEFAULT_COMMIT_TIMEOUT)) 
```
éœ€è¦è¯´æ˜ã€‚ å¦‚æœä¸å¸¦ task å‚æ•°ï¼Œç¼–è¯‘å™¨å¾€å¾€ä¼šè¯¯æŠ¥éœ€è¦ await,  è€Œæˆ‘ä»¬çš„ç›®çš„æ˜¯æ˜¾ç¤ºåˆ›å»ºäº‹åŠ¡å¹¶è‡ªåŠ¨è¿è¡Œï¼Œ å› æ­¤å¯ä»¥é‡‡ç”¨ :
```python
if auto_close:
    _ = asyncio.create_task(self.wait_for_close(TwoPC_DEFAULT_COMMIT_TIMEOUT))
```
æˆ–è€…ï¼š
```python
if auto_close:
    task = asyncio.create_task(self.wait_for_close(TwoPC_DEFAULT_COMMIT_TIMEOUT))
    task.add_done_callback(lambda t: t.exception())  # é¿å…æœªæ•è·å¼‚å¸¸
``` 

1. asyncio.create_task çš„è¡Œä¸º
asyncio.create_task ä¼šå°†ä¸€ä¸ªåç¨‹ï¼ˆcoroutineï¼‰åŒ…è£…æˆä¸€ä¸ª Task å¯¹è±¡ï¼Œå¹¶ç«‹å³è°ƒåº¦å®ƒè¿è¡Œã€‚
åˆ›å»ºçš„ Task ä¼šç‹¬ç«‹è¿è¡Œï¼Œç›´åˆ°å®Œæˆæˆ–è¢«å–æ¶ˆã€‚
å¦‚æœ Task æ²¡æœ‰è¢«æ˜¾å¼åœ°ç­‰å¾…ï¼ˆawaitï¼‰ï¼Œå®ƒä¼šåœ¨åå°è¿è¡Œï¼Œç›´åˆ°å®Œæˆã€‚

2. å¤–éƒ¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ
å¦‚æœå¤–éƒ¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­ï¼ˆä¾‹å¦‚ï¼Œå¯¹è±¡åœ¨ run_with_background_operations è¿”å›åå¾ˆå¿«è¢«é”€æ¯ï¼‰ï¼Œé‚£ä¹ˆéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š
ä»»åŠ¡æ˜¯å¦ä¾èµ–äºå¤–éƒ¨å¯¹è±¡ï¼š

å¦‚æœ `self._handle_background_commit()` æˆ– `self._handle_background_rollback()` ä¾èµ–äº selfï¼ˆå³å¤–éƒ¨å¯¹è±¡ï¼‰ï¼Œé‚£ä¹ˆå½“<b><mark style="background: transparent; color: orange">å¤–éƒ¨å¯¹è±¡è¢«é”€æ¯åï¼Œè¿™äº›ä»»åŠ¡å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</mark></b>ï¼ˆä¾‹å¦‚ AttributeError æˆ– ReferenceErrorï¼‰ã€‚

<b><mark style="background: transparent; color: orange">ä»»åŠ¡æ˜¯å¦ä¼šé˜»æ­¢å¯¹è±¡å›æ”¶ï¼š
å¦‚æœä»»åŠ¡æŒæœ‰å¯¹å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨ï¼ˆä¾‹å¦‚é€šè¿‡ selfï¼‰ï¼Œé‚£ä¹ˆå¤–éƒ¨å¯¹è±¡ä¸ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚è™½ç„¶è¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œ ä½†æ˜¯ä¸€èˆ¬å¦‚æœè¯¥ä»»åŠ¡ä¸è¶…æ—¶ï¼Œ åˆ™ä¸€èˆ¬éƒ½å¯ä»¥æ­£ç¡®å›æ”¶</mark></b>

#### asyncio.gather(`*aws`, return_exceptions=False)
å¹¶å‘è¿è¡Œä¼ å…¥çš„ awaitable å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯åç¨‹ï¼‰å¹¶æ”¶é›†å®ƒä»¬çš„ç»“æœã€‚
**å‚æ•°** : 
- `*aws`ï¼šä¸€ä¸ªæˆ–å¤šä¸ª awaitable å¯¹è±¡
- `return_exceptions`ï¼šå¦‚æœä¸º Trueï¼Œå¼‚å¸¸ä¼šè¢«è§†ä¸ºæˆåŠŸçš„ç»“æœè¿”å›ï¼Œè€Œä¸æ˜¯è¢«ä¼ æ’­ã€‚ 
```python
import asyncio 
async def fetch_data(delay, name):
    await asyncio.sleep(delay)
    return f"{name} result after {delay}s"

async def main():
    # å¹¶å‘è¿è¡Œä¸‰ä¸ªåç¨‹
    results = await asyncio.gather(
        fetch_data(3, "A"),
        fetch_data(1, "B"),
        fetch_data(2, "C")
    )
    
    # ç»“æœé¡ºåºä¸ä¼ å…¥é¡ºåºä¸€è‡´ï¼Œè€Œä¸æ˜¯å®Œæˆé¡ºåº
    print(results)  # ['A result after 3s', 'B result after 1s', 'C result after 2s']

if __name__ == "__main__":
    asyncio.run(main())
```

#### asyncio.wait_for(aw, timeout)

ç­‰å¾…åç¨‹å®Œæˆï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šçš„è¶…æ—¶æ—¶é—´ï¼Œåˆ™å–æ¶ˆåç¨‹å¹¶æŠ›å‡º TimeoutErrorã€‚

**å‚æ•°**ï¼š

- `aw`ï¼šawaitable å¯¹è±¡
- `timeout`ï¼šè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

```python
async def eternity():
    await asyncio.sleep(3600)
    print('yay!')

async def main():
    try:
        # ç­‰å¾…ï¼Œä½†ä¸è¶…è¿‡ 5 ç§’
        await asyncio.wait_for(eternity(), timeout=5)
    except asyncio.TimeoutError:
        print('timeout!')
```

#### `asyncio.wait` çš„è¿”å›å€¼

`asyncio.wait` è¿”å›ä¸€ä¸ª**å…ƒç»„**ï¼š
```python
done, pending = await asyncio.wait(...)
```
- `done`: **å·²å®Œæˆ**çš„ä»»åŠ¡é›†åˆ (`set[asyncio.Task]`)ï¼Œæ— è®ºæ˜¯**æˆåŠŸ**è¿˜æ˜¯**å¼‚å¸¸ç»“æŸ**ï¼Œéƒ½ä¼šæ”¾å…¥ `done` é›†åˆã€‚
- `pending`: **æœªå®Œæˆ**çš„ä»»åŠ¡é›†åˆ (`set[asyncio.Task]`)ï¼Œå¦‚æœä»»åŠ¡åœ¨ `timeout` å†…æœªå®Œæˆï¼Œåˆ™å®ƒä»¬ä¼šè¢«æ”¾å…¥ `pending`ã€‚

å¦‚æœ `timeout` è¿‡æœŸï¼š
- **å·²ç»å®Œæˆçš„ä»»åŠ¡**ä¼šè¿›å…¥ `done` é›†åˆã€‚
- **æœªå®Œæˆçš„ä»»åŠ¡**ä¼šè¿›å…¥ `pending` é›†åˆã€‚

ç¤ºä¾‹ï¼š
```python
import asyncio

async def task1():
    await asyncio.sleep(2)
    return "task1 done"

async def task2():
    await asyncio.sleep(10)
    return "task2 done"

async def main():
    t1 = asyncio.create_task(task1())
    t2 = asyncio.create_task(task2())

    done, pending = await asyncio.wait([t1, t2], timeout=5)

    print("Done tasks:", [t.result() for t in done if t.done()])
    print("Pending tasks:", pending)

asyncio.run(main())
```
**è¾“å‡º**ï¼š
```shell
Done tasks: ['task1 done']
Pending tasks: {<Task pending name='Task-2' coro=<task2()>>}
```
> `task1` åœ¨ 2 ç§’å†…å®Œæˆå¹¶è¿›å…¥ `done`ï¼Œä½† `task2` éœ€è¦ 10 ç§’ï¼Œå®ƒåœ¨ `timeout=5` åä»æœªå®Œæˆï¼Œå› æ­¤è¿›å…¥ `pending`ã€‚ 

#### asyncio.sleep(delay, result=None)

åç¨‹ä¼‘çœ æŒ‡å®šçš„ç§’æ•°ã€‚å¯é€‰åœ°ï¼ŒæŒ‡å®šä¸€ä¸ªå€¼ä½œä¸ºåç¨‹çš„ç»“æœè¿”å›ã€‚

**å‚æ•°**ï¼š

- `delay`ï¼šä¼‘çœ æ—¶é—´ï¼ˆç§’ï¼‰
- `result`ï¼šä¼‘çœ ç»“æŸåè¿”å›çš„å€¼ï¼ˆå¯é€‰ï¼‰

```python
async def say_after(delay, what):
    result = await asyncio.sleep(delay, what)  # ä¼‘çœ å¹¶è¿”å›å€¼
    print(f"After {delay}s: {result}")
    return result

async def main():
    result = await say_after(1, "hello")
    print(f"Result was: {result}")  # Result was: hello
```

## äºŒã€async/await è¯­æ³•è¯¦è§£

### 1. async def - å®šä¹‰å¼‚æ­¥å‡½æ•°

`async def` ç”¨äºå®šä¹‰åç¨‹å‡½æ•°ï¼Œè°ƒç”¨å®ƒä¼šè¿”å›ä¸€ä¸ªåç¨‹å¯¹è±¡è€Œä¸æ˜¯ç›´æ¥æ‰§è¡Œå‡½æ•°ä½“ã€‚

```python
async def my_coroutine():
    print("This is a coroutine")
    return "Done"

# è°ƒç”¨ä¸ä¼šæ‰§è¡Œå‡½æ•°ä½“ï¼Œè€Œæ˜¯è¿”å›åç¨‹å¯¹è±¡
coro = my_coroutine()
print(coro)  # <coroutine object my_coroutine at 0x...>

# è¦æ‰§è¡Œåç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ await æˆ–è€…äº‹ä»¶å¾ªç¯
result = asyncio.run(coro)
print(result)  # Done
```

### 2. await - ç­‰å¾…åç¨‹å®Œæˆ

`await` è¡¨è¾¾å¼ç”¨äºæš‚åœå½“å‰åç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ° awaitable å¯¹è±¡å®Œæˆã€‚åªèƒ½åœ¨ `async def` å®šä¹‰çš„å‡½æ•°ä¸­ä½¿ç”¨ã€‚

await å¯ç”¨äºä»¥ä¸‹å¯¹è±¡ï¼š

- åç¨‹ï¼ˆcoroutineï¼‰
- Task å¯¹è±¡
- Future å¯¹è±¡
- å®ç°äº† `__await__()` çš„å¯¹è±¡

```python
async def nested():
    return 42

async def main():
    # ç›´æ¥ç­‰å¾…åç¨‹
    result1 = await nested()
    print(result1)  # 42
    
    # ç­‰å¾…ä»»åŠ¡
    task = asyncio.create_task(nested())
    result2 = await task
    print(result2)  # 42
```

### 3. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆasync withï¼‰

ä½¿ç”¨ `async with` è¯­å¥è¿›å…¥å’Œé€€å‡ºå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚ä¸Šä¸‹æ–‡ç®¡ç†å™¨éœ€è¦å®šä¹‰ `__aenter__` å’Œ `__aexit__` æ–¹æ³•ã€‚

```python
class AsyncContextManager:
    async def __aenter__(self):
        print("Entering context")
        await asyncio.sleep(1)
        return "context value"
        
    async def __aexit__(self, exc_type, exc_value, traceback):
        print("Exiting context")
        await asyncio.sleep(1)

async def main():
    async with AsyncContextManager() as value:
        print(f"Inside context with value: {value}")
```

### 4. å¼‚æ­¥è¿­ä»£å™¨ï¼ˆasync forï¼‰

ä½¿ç”¨ `async for` éå†å¼‚æ­¥è¿­ä»£å™¨ã€‚å¼‚æ­¥è¿­ä»£å™¨éœ€è¦å®šä¹‰ `__aiter__` å’Œ `__anext__` æ–¹æ³•ã€‚

```python
class AsyncCounter:
    def __init__(self, limit):
        self.limit = limit
        self.counter = 0
        
    def __aiter__(self):
        return self
        
    async def __anext__(self):
        if self.counter < self.limit:
            self.counter += 1
            await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
            return self.counter
        else:
            raise StopAsyncIteration

async def main():
    async for number in AsyncCounter(5):
        print(number)  # ä¾æ¬¡æ‰“å° 1, 2, 3, 4, 5
```

## ä¸‰ã€å®é™…åº”ç”¨ç¤ºä¾‹

### 1. å¼‚æ­¥ç½‘ç»œè¯·æ±‚

```python
import asyncio
import aiohttp  # éœ€è¦å®‰è£…: pip install aiohttp

async def fetch(session, url):
    async with session.get(url) as response:
        return await response.text()

async def main():
    urls = [
        'https://python.org',
        'https://github.com',
        'https://stackoverflow.com'
    ]
    
    # åˆ›å»ºä¸€ä¸ªä¼šè¯
    async with aiohttp.ClientSession() as session:
        # å¹¶å‘è¯·æ±‚æ‰€æœ‰ç½‘å€
        tasks = [fetch(session, url) for url in urls]
        results = await asyncio.gather(*tasks)
        
        # æ‰“å°æ¯ä¸ªç½‘é¡µçš„å¤§å°
        for url, html in zip(urls, results):
            print(f"{url}: {len(html)} characters")

# è¿è¡Œä¸»åç¨‹
asyncio.run(main())
```

### 2. å¼‚æ­¥æ–‡ä»¶æ“ä½œ

```python
import asyncio
import aiofiles  # éœ€è¦å®‰è£…: pip install aiofiles

async def read_file(filename):
    async with aiofiles.open(filename, mode='r') as f:
        return await f.read()

async def write_file(filename, content):
    async with aiofiles.open(filename, mode='w') as f:
        await f.write(content)

async def main():
    # å¹¶å‘è¯»å–å¤šä¸ªæ–‡ä»¶
    file_contents = await asyncio.gather(
        read_file('file1.txt'),
        read_file('file2.txt'),
        read_file('file3.txt')
    )
    
    # åˆå¹¶å†…å®¹
    combined = '\n'.join(file_contents)
    
    # å¼‚æ­¥å†™å…¥æ–°æ–‡ä»¶
    await write_file('combined.txt', combined)
    print("Files combined successfully")

# è¿è¡Œä¸»åç¨‹
asyncio.run(main())
```

## å››ã€å¼‚æ­¥ç¼–ç¨‹çš„ä¼˜ç¼ºç‚¹

### ä¼˜ç‚¹ï¼š

1. **æé«˜ I/O å¯†é›†å‹åº”ç”¨æ€§èƒ½**ï¼šå¯ä»¥åœ¨ç­‰å¾… I/O æ“ä½œæ—¶æ‰§è¡Œå…¶ä»–ä»»åŠ¡
2. **æ›´å¥½çš„å¹¶å‘æ§åˆ¶**ï¼šæ¯”çº¿ç¨‹æ›´è½»é‡ï¼Œé¿å…äº†çº¿ç¨‹é—´åŒæ­¥é—®é¢˜
3. **ç®€æ´çš„åŒæ­¥è¯­æ³•**ï¼š`async/await` ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç 
4. **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥å¤„ç†æ•°åƒä¸ªå¹¶å‘è¿æ¥

### ç¼ºç‚¹ï¼š

1. **ä¸é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡**ï¼šä¸ä¼šçœŸæ­£å¹¶è¡Œæ‰§è¡Œï¼ˆä»åœ¨å•çº¿ç¨‹ä¸­ï¼‰
2. **è°ƒè¯•å¤æ‚æ€§**ï¼šè·Ÿè¸ªå¼‚æ­¥æ§åˆ¶æµæ¯”åŒæ­¥ä»£ç æ›´å›°éš¾
3. **ç”Ÿæ€ç³»ç»Ÿå…¼å®¹æ€§**ï¼šæŸäº›åº“å¯èƒ½ä¸æ”¯æŒå¼‚æ­¥æ“ä½œ
4. **å­¦ä¹ æ›²çº¿**ï¼šç†è§£äº‹ä»¶å¾ªç¯å’Œåç¨‹éœ€è¦æ—¶é—´

## äº”ã€æœ€ä½³å®è·µ

1. **å¼‚æ­¥æ‰€æœ‰æˆ–ä¸å¼‚æ­¥**ï¼šä¸€æ—¦é€‰æ‹©å¼‚æ­¥æ–¹å¼ï¼Œå°½é‡åœ¨æ•´ä¸ªåº”ç”¨ä¸­ä¿æŒä¸€è‡´
2. **é¿å…é˜»å¡**ï¼šä¸è¦åœ¨åç¨‹ä¸­ä½¿ç”¨é˜»å¡è°ƒç”¨ï¼ˆå¦‚ `time.sleep()`ï¼‰
3. **æ­£ç¡®å¤„ç†å¼‚å¸¸**ï¼šä½¿ç”¨ `try/except` æ•è·å’Œå¤„ç†å¼‚æ­¥æ“ä½œä¸­çš„å¼‚å¸¸
4. **åˆç†åˆ†ç»„ä»»åŠ¡**ï¼šä½¿ç”¨ `asyncio.gather()` å°†ç›¸å…³ä»»åŠ¡ç»„åˆåœ¨ä¸€èµ·
5. **è®¾ç½®è¶…æ—¶**ï¼šä¸ºé•¿æ—¶é—´è¿è¡Œçš„åç¨‹è®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…

é€šè¿‡æ·±å…¥ç†è§£ asyncio åº“å’Œ async/await è¯­æ³•ï¼Œä½ å¯ä»¥å¼€å‘å‡ºé«˜æ•ˆã€å¯ä¼¸ç¼©çš„å¼‚æ­¥åº”ç”¨ç¨‹åºï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§é‡ç½‘ç»œè¯·æ±‚æˆ–æ–‡ä»¶æ“ä½œæ—¶ã€‚



## äºŒã€å¸¸ç”¨å‡½æ•°
1. `asyncio.run_coroutine_threadsafe` å‡½æ•°ç”¨æ³• 

**ä½¿ç”¨åœºæ™¯**
â€¢ ä¸»çº¿ç¨‹æˆ–å…¶ä»–çº¿ç¨‹éœ€è¦ä¸**åå°è¿è¡Œäº‹ä»¶å¾ªç¯çš„çº¿ç¨‹**äº¤äº’ã€‚
â€¢ ä¾‹å¦‚ï¼šGUI ä¸»çº¿ç¨‹éœ€å°†ä»»åŠ¡æäº¤åˆ°å¼‚æ­¥ç½‘ç»œè¯·æ±‚çš„åå°çº¿ç¨‹ã€‚
```python
asyncio.run_coroutine_threadsafe(coro, loop)
```
â€¢ **å‚æ•°**ï¼š
  â€¢ `coro`: è¦æäº¤çš„åç¨‹å¯¹è±¡ã€‚
  â€¢ `loop`: ç›®æ ‡äº‹ä»¶å¾ªç¯ï¼ˆå¿…é¡»åœ¨å…¶ä»–çº¿ç¨‹ä¸­è¿è¡Œï¼‰ã€‚
â€¢ **è¿”å›å€¼**ï¼š
  â€¢ `concurrent.futures.Future`ï¼šç”¨äºè·å–ç»“æœæˆ–æ·»åŠ å›è°ƒã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•ç¤ºä¾‹ :  
1. **åœ¨å­çº¿ç¨‹ä¸­å¯åŠ¨äº‹ä»¶å¾ªç¯**
   ```python
   import asyncio
   from threading import Thread

   def run_event_loop(loop):
       asyncio.set_event_loop(loop)
       loop.run_forever()  # å¯åŠ¨äº‹ä»¶å¾ªç¯

   # åˆ›å»ºå­çº¿ç¨‹è¿è¡Œäº‹ä»¶å¾ªç¯
   loop = asyncio.new_event_loop()
   t = Thread(target=run_event_loop, args=(loop,), daemon=True)
   t.start()
   ```

2. **æäº¤åç¨‹åˆ°å­çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯**
   ```python
   async def my_coroutine():
       await asyncio.sleep(1)
       return "Done"

   # åœ¨ä¸»çº¿ç¨‹æˆ–å…¶ä»–çº¿ç¨‹ä¸­æäº¤åç¨‹
   future = asyncio.run_coroutine_threadsafe(my_coroutine(), loop)
   ```

3. **å¤„ç†ç»“æœæˆ–å¼‚å¸¸**
   â€¢ **é˜»å¡ç­‰å¾…ç»“æœ**ï¼ˆå¯èƒ½é˜»å¡å½“å‰çº¿ç¨‹ï¼‰ï¼š
     ```python
     try:
         result = future.result(timeout=2)  # è®¾ç½®è¶…æ—¶
         print("Result:", result)
     except asyncio.TimeoutError:
         print("Timeout!")
     except Exception as e:
         print("Error:", e)
     ```
   â€¢ **éé˜»å¡å›è°ƒå¤„ç†**ï¼ˆæ¨èï¼‰ï¼š
     ```python
     def callback(future):
         try:
             result = future.result()
             print("Result:", result)
         except Exception as e:
             print("Error:", e)

     future.add_done_callback(callback)  # å›è°ƒåœ¨äº‹ä»¶å¾ªç¯çº¿ç¨‹æ‰§è¡Œ
     ```


`loop.call_soon_threadsafe()` is the correct method to schedule a regular function call (like `event.set()`) to be executed in the event loop from another thread. It ensures thread safety when interacting with the event loop.  


## äº‹ä»¶å¾ªç¯ 
### 1. äº‹ä»¶å¾ªç¯ (Event Loop)
äº‹ä»¶å¾ªç¯æ˜¯Â `asyncio`Â çš„æ ¸å¿ƒæœºåˆ¶ï¼Œè´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚å®ƒç®¡ç†ç€æ‰€æœ‰çš„åç¨‹ã€ä»»åŠ¡ã€å›è°ƒå‡½æ•°ä»¥åŠ I/O æ“ä½œã€‚æ¯ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªäº‹ä»¶å¾ªç¯ã€‚

é€šè¿‡å¦‚ä¸‹æ–¹æ³•ç»‘å®š 
```python
self.loop = asyncio.new_event_loop()
asyncio.set_event_loop(self.loop) 
self.loop_thread = threading.Thread(self.loop.run_forever(), daemon=True)
```


ğŸ“Œ **`loop.call_soon_threadsafe(callback, *args)` çš„ä½œç”¨** : 
- å®ƒç”¨äº<b><mark style="background: transparent; color: orange">ä»å¦ä¸€ä¸ªçº¿ç¨‹</mark></b>==å®‰å…¨åœ°æäº¤ä»»åŠ¡åˆ° `asyncio` äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œ==ã€‚
- é€‚ç”¨äº `asyncio` äº‹ä»¶å¾ªç¯**åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œ**ï¼Œä½†ä½ æƒ³è¦ä»**ä¸»çº¿ç¨‹**æˆ–å…¶ä»–**éäº‹ä»¶å¾ªç¯çº¿ç¨‹**è§¦å‘å›è°ƒã€‚

å¦å¤–ï¼Œ æ¯” `call_soon_threadsafe` æ›´å¯é çš„æ–¹å¼æ˜¯ **`asyncio.run_coroutine_threadsafe`** 
```python

```

```python
await asyncio.wait_for(self.__prepare_event.wait(),   # æ¶ˆæ¯å›è°ƒ**è¡Œåœ¨ `pika` çš„çº¿ç¨‹ä¸­**ï¼ˆå³ RabbitMQ çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼‰
# è€Œ**`self.loop` è¿è¡Œåœ¨å•ç‹¬çš„çº¿ç¨‹**ï¼ˆä½ åœ¨ `__init__()` é‡Œæ‰‹åŠ¨åˆ›å»ºçš„ `new_event_loop()`ï¼‰ã€‚
```

### 2. å…¸å‹çš„è¯»å–æ–¹æ¡ˆ

ä½ æ˜¯å¯¹çš„ï¼Œé—®é¢˜åœ¨äº `await self.__prepare_event.wait()` **å¯èƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹çš„ `asyncio` äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œçš„**ï¼Œè€Œ `self.__prepare_event.set()` **æ˜¯ä» `self.loop` è¿™ä¸ªå•ç‹¬çš„äº‹ä»¶å¾ªç¯ä¸­è§¦å‘çš„**ï¼Œæ‰€ä»¥ `wait_for()` å¯èƒ½æ— æ³•æ­£ç¡®æ„ŸçŸ¥ `set()` çŠ¶æ€çš„å˜åŒ–ã€‚

---

## **âœ… è§£å†³æ–¹æ¡ˆ**

ä½ çš„æ€è·¯æ˜¯**åœ¨ `self.loop` äº‹ä»¶å¾ªç¯ä¸­**ç®¡ç† `await self.__prepare_event.wait()`ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨ä¸»çº¿ç¨‹ `await`ï¼Œè¿™ç¡®å®æ˜¯æ­£ç¡®çš„åšæ³•ã€‚

### **ğŸ”¥ æ–¹æ³• 1ï¼šä½¿ç”¨ `asyncio.create_task()`**

æ—¢ç„¶ `await` å¯èƒ½é˜»å¡äº†é”™è¯¯çš„ `loop`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `self.loop` ä¸­åˆ›å»ºä¸€ä¸ª**å¼‚æ­¥ä»»åŠ¡**æ¥ç›‘å¬ `__prepare_event.wait()`ï¼š

```python
prepare_task = asyncio.run_coroutine_threadsafe(self._wait_prepare_event(), self.loop)
result = prepare_task.result(timeout=20)  # è¶…æ—¶æ—¶é—´
```

è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ `_wait_prepare_event()` æ¥åœ¨ `self.loop` ä¸­ç®¡ç† `wait()`ï¼š

```python
async def _wait_prepare_event(self):
    await self.__prepare_event.wait()
    return True
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±ç¡®ä¿ `wait()` è¿è¡Œåœ¨ `self.loop` é‡Œé¢ï¼Œè€Œä¸æ˜¯ä¸»çº¿ç¨‹çš„ `asyncio` äº‹ä»¶å¾ªç¯ã€‚

### **ğŸ”¥ æ–¹æ³• 2ï¼šç›´æ¥ `create_task()` å¹¶è½®è¯¢æ£€æŸ¥**

ä½ ä¹Ÿå¯ä»¥åƒ `commit_task = asyncio.create_task(self.__commit_event.wait())` è¿™æ ·åˆ›å»ºä»»åŠ¡ï¼š

```python
prepare_task = asyncio.run_coroutine_threadsafe(
    asyncio.create_task(self.__prepare_event.wait()), self.loop
)
```

ç„¶åå¯ä»¥ç”¨ `prepare_task.result(timeout=20)` æ¥ç­‰å¾…ç»“æœã€‚
## **ğŸ¯ æ€»ç»“**

|**æ–¹æ¡ˆ**|**é€‚ç”¨æƒ…å†µ**|**ä¼˜ç‚¹**|**ç¼ºç‚¹**|
|---|---|---|---|
|**æ–¹æ³• 1ï¼šå°è£…æˆ `_wait_prepare_event()` å¹¶ `run_coroutine_threadsafe()`**|ç¡®ä¿ `wait()` è¿è¡Œåœ¨ `self.loop` é‡Œ|æœ€ç¨³å®šï¼Œä¸å— `loop` åˆ‡æ¢å½±å“|éœ€è¦é¢å¤–å®šä¹‰ `_wait_prepare_event()`|
|**æ–¹æ³• 2ï¼š`create_task()` å¹¶ `run_coroutine_threadsafe()`**|é€‚ç”¨äºä¸æƒ³é¢å¤–å°è£…æ–¹æ³•çš„æƒ…å†µ|ä»£ç ç®€å•|å¯èƒ½ä¼šæœ‰ `Task` æ®‹ç•™é—®é¢˜|

### **ğŸš€ æ¨è**

- **æ–¹æ³• 1** æ›´åŠ å®‰å…¨ï¼Œé€‚åˆå¤æ‚ `asyncio` ä»»åŠ¡ç®¡ç†ã€‚
- **æ–¹æ³• 2** ä»£ç æ›´ç®€æ´ï¼Œä½†è¦ç¡®ä¿ä»»åŠ¡èƒ½è¢«æ­£ç¡®æ¸…ç†ã€‚

ä½ å¯ä»¥è¯•è¯•çœ‹ï¼Œè¿™åº”è¯¥èƒ½è§£å†³ `wait_for()` å»¶è¿Ÿè¿”å›çš„é—®é¢˜ï¼ 


**`asyncio.run_coroutine_threadsafe()` è¿”å›çš„æ˜¯ `concurrent.futures.Future`**ï¼Œè€Œ `asyncio.wait()` æœŸæœ›çš„æ˜¯ **`asyncio.Task` æˆ– `coroutine`**ã€‚



### **ğŸš€ ä¸ºä»€ä¹ˆ `asyncio.create_task()` å¯ä»¥ç›´æ¥è¿è¡Œï¼Ÿ**

```python
commit_task = asyncio.create_task(self.__commit_event.wait())
rollback_task = asyncio.create_task(self.__rollback_event.wait())

done, pending = await asyncio.wait(
    [commit_task, rollback_task],
    timeout=timeout,
    return_when=asyncio.FIRST_COMPLETED
)
```

è¿™æ®µä»£ç **å¯ä»¥æ­£å¸¸è¿è¡Œ**ï¼Œå³ä½¿æ²¡æœ‰æ˜¾å¼æŒ‡å®š `self.loop`ï¼ŒåŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

---

## **âœ… 1ï¸âƒ£ `asyncio.create_task()` åªä¼šåœ¨å½“å‰äº‹ä»¶å¾ªç¯ä¸­åˆ›å»ºä»»åŠ¡**

- `asyncio.create_task(coro)` **ä¼šå°† `coro` ä»»åŠ¡ç»‘å®šåˆ°å½“å‰è¿è¡Œçš„ `asyncio` äº‹ä»¶å¾ªç¯**ï¼Œå³ `asyncio.get_running_loop()`ã€‚
- è¿™æ„å‘³ç€ **åªè¦ `await` è¿è¡Œçš„ `loop` å’Œ `create_task()` åœ¨åŒä¸€ä¸ª `asyncio` äº‹ä»¶å¾ªç¯ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥è¿è¡Œ**ã€‚

**ç¤ºä¾‹**

```python
async def main():
    commit_task = asyncio.create_task(asyncio.sleep(3))
    rollback_task = asyncio.create_task(asyncio.sleep(5))

    done, pending = await asyncio.wait([commit_task, rollback_task], return_when=asyncio.FIRST_COMPLETED)
    print("Done:", done)

asyncio.run(main())  # è¿è¡Œæ—¶ä¼šç»‘å®šå½“å‰äº‹ä»¶å¾ªç¯
```

- `create_task()` ç›´æ¥åœ¨ `asyncio.run(main())` å†…éƒ¨åˆ›å»ºçš„ `loop` é‡Œæ‰§è¡Œï¼Œå› æ­¤ä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®š `loop`ã€‚

---

## **âœ… 2ï¸âƒ£ `self.__commit_event.wait()` ä¹Ÿæ˜¯åœ¨å½“å‰ `loop` é‡Œæ‰§è¡Œ**

ä½ çš„ `self.__commit_event` æ˜¯ `asyncio.Event()`ï¼Œå®ƒçš„ `wait()` æ–¹æ³• **ä¸ä¼šè‡ªåŠ¨ç»‘å®šç‰¹å®šçš„ `loop`ï¼Œè€Œæ˜¯åœ¨å“ªä¸ª `loop` é‡Œ `await`ï¼Œå°±åœ¨å“ªä¸ª `loop` é‡Œæ‰§è¡Œ**ã€‚

æ‰€ä»¥ï¼š

```python
commit_task = asyncio.create_task(self.__commit_event.wait())
rollback_task = asyncio.create_task(self.__rollback_event.wait())
```

- è¿™ä¸¤ä¸ª `wait()` ä»»åŠ¡ä¼šè‡ªåŠ¨è¿è¡Œåœ¨**å½“å‰ `asyncio` äº‹ä»¶å¾ªç¯**é‡Œã€‚
- `asyncio.wait([...])` ä¹Ÿä¼šåœ¨åŒä¸€ä¸ª `loop` é‡Œè°ƒåº¦ä»»åŠ¡ï¼Œå› æ­¤ä¸ä¼šæœ‰é—®é¢˜ã€‚

---

## **âš ï¸ ä»€ä¹ˆæ—¶å€™å¿…é¡»æ˜¾å¼æŒ‡å®š `loop`ï¼Ÿ**

å¦‚æœä½ çš„ `self.loop` æ˜¯**å•ç‹¬å¯åŠ¨çš„**ï¼Œå¹¶ä¸”ä½ å¸Œæœ›ä»»åŠ¡**åœ¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ `loop` é‡Œè¿è¡Œ**ï¼Œå°±ä¸èƒ½ç›´æ¥ `create_task()`ï¼Œéœ€è¦æ”¹ç”¨ `self.loop.create_task()` æˆ– `asyncio.run_coroutine_threadsafe()`ã€‚

### **ğŸš¨ éœ€è¦æ˜¾å¼æŒ‡å®š `loop` çš„æƒ…å†µ**

```python
self.loop = asyncio.new_event_loop()
threading.Thread(target=self.loop.run_forever, daemon=True).start()

# è¿™é‡Œ `create_task()` é»˜è®¤ä¼šç»‘å®šåˆ°å½“å‰çº¿ç¨‹çš„ loopï¼Œä½†å½“å‰çº¿ç¨‹ä¸æ˜¯ self.loop
task = self.loop.create_task(self.__commit_event.wait())
```

> **ä¸ºä»€ä¹ˆï¼Ÿ**
> 
> - `asyncio.create_task()` åªèƒ½åœ¨**å½“å‰æ­£åœ¨è¿è¡Œçš„ `loop`** é‡Œè°ƒåº¦ä»»åŠ¡ã€‚
> - ä½† `self.loop` è¿è¡Œåœ¨**å¦ä¸€ä¸ªçº¿ç¨‹**ï¼Œæ‰€ä»¥ `asyncio.create_task()` é»˜è®¤ä¸ä¼šè·‘åœ¨ `self.loop` é‡Œã€‚

### **âœ… è§£å†³æ–¹æ¡ˆ**

å¦‚æœ `self.loop` è¿è¡Œåœ¨**å¦ä¸€ä¸ªçº¿ç¨‹**ï¼š

```python
task = asyncio.run_coroutine_threadsafe(self.__commit_event.wait(), self.loop)
```

è¿™æ · `wait()` å°±ä¼šåœ¨ `self.loop` é‡Œè¿è¡Œï¼Œè€Œä¸ä¼šæ„å¤–è·‘åˆ°ä¸»çº¿ç¨‹çš„ `loop` é‡Œã€‚

---

## **ğŸ¯ æ€»ç»“**

|**æƒ…å†µ**|**æ˜¯å¦éœ€è¦æŒ‡å®š `loop`ï¼Ÿ**|**è§£å†³æ–¹æ¡ˆ**|
|---|---|---|
|**`await` è¿è¡Œåœ¨ `asyncio.run()` å†…éƒ¨**|âŒ ä¸éœ€è¦|`asyncio.create_task(self.__commit_event.wait())`|
|**`self.loop` è¿è¡Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹**|âœ… éœ€è¦|`asyncio.run_coroutine_threadsafe(self.__commit_event.wait(), self.loop)`|
|**`loop.run_forever()` åœ¨åå°çº¿ç¨‹**|âœ… éœ€è¦|`self.loop.create_task(self.__commit_event.wait())`|

### **ğŸš€ æ¨è**

- **å¦‚æœ `await` å‘ç”Ÿåœ¨å½“å‰ `asyncio` äº‹ä»¶å¾ªç¯é‡Œ** â†’ **ç›´æ¥ `asyncio.create_task()`**
- **å¦‚æœ `self.loop` åœ¨å¦ä¸€ä¸ªçº¿ç¨‹** â†’ **ä½¿ç”¨ `self.loop.create_task()` æˆ– `asyncio.run_coroutine_threadsafe()`**

ä½ çš„ä»£ç å¯ä»¥è¿è¡Œï¼Œè¯´æ˜ `await` å‘ç”Ÿçš„ `loop` å’Œ `create_task()` ç»‘å®šçš„ `loop` æ˜¯åŒä¸€ä¸ª ğŸ¯


## **âœ… æ£€æŸ¥ â€œå½“å‰è¿è¡Œçš„ `asyncio` äº‹ä»¶å¾ªç¯â€**

ä½ å¯ä»¥ä½¿ç”¨ `asyncio.get_running_loop()` æ¥æ£€æŸ¥ï¼š


## ä»»åŠ¡åˆ›å»º 

ä½ çš„ä»£ç ä¼šå‡ºé”™çš„ä¸»è¦åŸå› æ˜¯ **`asyncio.run_coroutine_threadsafe()` è¿”å›çš„æ˜¯ `concurrent.futures.Future`**ï¼Œè€Œ `asyncio.wait()` æœŸæœ›çš„æ˜¯ **`asyncio.Task` æˆ– `coroutine`**ã€‚

---

## **ğŸš¨ é—®é¢˜åˆ†æ**

### **1ï¸âƒ£ `asyncio.run_coroutine_threadsafe()` è¿”å› `Future`**

```python
commit_task = asyncio.run_coroutine_threadsafe(self.__commit_event.wait(), self.loop)
```

- è¿™ä¸ª `commit_task` **ä¸æ˜¯ `asyncio.Task`**ï¼Œè€Œæ˜¯ **`concurrent.futures.Future`**ã€‚
- ä½†æ˜¯ `asyncio.wait()` æœŸæœ›çš„æ˜¯ **`asyncio.Task` æˆ– `coroutine`**ï¼Œå› æ­¤ä¼šæŠ¥é”™ã€‚

### **2ï¸âƒ£ `asyncio.wait()` éœ€è¦ `asyncio.Task`**

```python
done, pending = await asyncio.wait([commit_task, rollback_task], ...)
```

- è¿™é‡Œ `commit_task` å’Œ `rollback_task` ä¸æ˜¯ `Task`ï¼Œ`asyncio.wait()` æ— æ³•æ­£ç¡®ç­‰å¾…å®ƒä»¬çš„å®ŒæˆçŠ¶æ€ã€‚

---

## **âœ… è§£å†³æ–¹æ¡ˆ**

### **æ–¹æ³• 1ï¼šä½¿ç”¨ `loop.create_task()`**

**æ¨è**ç”¨ `self.loop.create_task()` åœ¨ `self.loop` äº‹ä»¶å¾ªç¯ä¸­åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ï¼š

```python
commit_task = asyncio.run_coroutine_threadsafe(self.loop.create_task(self.__commit_event.wait()), self.loop)
rollback_task = asyncio.run_coroutine_threadsafe(self.loop.create_task(self.__rollback_event.wait()), self.loop)

# è·å–ç»“æœ
done, pending = await asyncio.wait(
    [asyncio.wrap_future(commit_task), asyncio.wrap_future(rollback_task)],  
    timeout=timeout,
    return_when=asyncio.FIRST_COMPLETED
)
```

### **æ–¹æ³• 2ï¼šç”¨ `asyncio.ensure_future()`**

å¦ä¸€ç§æ–¹æ³•æ˜¯ `asyncio.ensure_future()`ï¼š

```python
commit_task = asyncio.ensure_future(self.__commit_event.wait(), loop=self.loop)
rollback_task = asyncio.ensure_future(self.__rollback_event.wait(), loop=self.loop)

done, pending = await asyncio.wait(
    [commit_task, rollback_task],
    timeout=timeout,
    return_when=asyncio.FIRST_COMPLETED
)
```

---

## **ğŸ¯ ç»“è®º**

| **æ–¹æ³•**                                          | **é€‚ç”¨æƒ…å†µ**                         | **ä¼˜ç‚¹**              | **ç¼ºç‚¹**         |
| ----------------------------------------------- | -------------------------------- | ------------------- | -------------- |
| **æ–¹æ³• 1ï¼š`loop.create_task()` å¹¶ `wrap_future()`** | é€‚ç”¨äº `run_coroutine_threadsafe()` | ç¡®ä¿ä»»åŠ¡åœ¨æ­£ç¡®çš„ `loop` é‡Œè¿è¡Œ | ä»£ç ç¨å¤æ‚          |
| **æ–¹æ³• 2ï¼š`asyncio.ensure_future()`**              | é€‚ç”¨äº **å½“å‰çº¿ç¨‹çš„ `asyncio` äº‹ä»¶å¾ªç¯**     | ä»£ç ç®€å•                | éœ€è¦ç¡®ä¿ `loop` è¿è¡Œ |

**ğŸš€ æ¨è**

- **å¦‚æœä½ çš„ `self.loop` è¿è¡Œåœ¨** **å¦ä¸€ä¸ªçº¿ç¨‹**ï¼Œç”¨ **æ–¹æ³• 1** (`create_task()` + `wrap_future()`)ã€‚
- **å¦‚æœ `await` è¿è¡Œåœ¨ç›¸åŒ `loop` é‡Œ**ï¼Œç”¨ **æ–¹æ³• 2** (`ensure_future()`)ã€‚

è¿™æ ·ä½ çš„ `asyncio.wait()` å°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼ ğŸš€ 

### **ğŸ” `asyncio` ä»»åŠ¡æ˜¯å¦éœ€è¦æ˜¾å¼æŒ‡å®š `loop`ï¼Ÿ**

æ˜¯çš„ï¼Œ`asyncio` ä»»åŠ¡æ˜¯å¦éœ€è¦æ˜¾å¼æŒ‡å®š `loop`ï¼Œå–å†³äº **å½“å‰è¿è¡Œçš„ `asyncio` äº‹ä»¶å¾ªç¯** æ˜¯å¦å’Œä½ åˆ›å»ºä»»åŠ¡çš„ `loop` æ˜¯åŒä¸€ä¸ªã€‚å¦‚æœä½ çš„ `loop` æ˜¯æ‰‹åŠ¨åˆ›å»ºå¹¶åœ¨**å¦ä¸€ä¸ªçº¿ç¨‹**é‡Œè¿è¡Œçš„ï¼Œä½ å°±éœ€è¦**æ˜¾å¼æŒ‡å®š `loop`**ã€‚

---

## **ğŸ¯ å¦‚ä½•ç¡®ä¿ â€œå½“å‰è¿è¡Œçš„ asyncio äº‹ä»¶å¾ªç¯â€ï¼Ÿ**

åœ¨ `asyncio` é‡Œï¼Œ**æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨çš„ `asyncio` äº‹ä»¶å¾ªç¯**ã€‚å¦‚æœä½ åœ¨**ä¸»çº¿ç¨‹**é‡Œè¿è¡Œ `asyncio.run()`ï¼Œé‚£ä¹ˆ `asyncio.get_running_loop()` å°±ä¼šè¿”å›ä¸»çº¿ç¨‹çš„ `loop`ã€‚

ä½†å¦‚æœä½ åœ¨**å¦ä¸€ä¸ªçº¿ç¨‹**é‡Œå¯åŠ¨äº† `self.loop.run_forever()`ï¼Œé‚£ä¹ˆ `asyncio.get_running_loop()` **åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ä¼šæŠ¥é”™**ï¼Œå› ä¸ºä¸»çº¿ç¨‹æ²¡æœ‰è¿è¡Œ `asyncio` äº‹ä»¶å¾ªç¯ã€‚

---

## **âœ… æ£€æŸ¥ â€œå½“å‰è¿è¡Œçš„ `asyncio` äº‹ä»¶å¾ªç¯â€**

ä½ å¯ä»¥ä½¿ç”¨ `asyncio.get_running_loop()` æ¥æ£€æŸ¥ï¼š

```python
import asyncio
import threading

async def check_loop():
    loop = asyncio.get_running_loop()
    print(f"å½“å‰è¿è¡Œçš„äº‹ä»¶å¾ªç¯: {loop}")

# ä¸»çº¿ç¨‹è¿è¡Œ
asyncio.run(check_loop())

# å¦ä¸€ä¸ªçº¿ç¨‹è¿è¡Œ
def run_loop():
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    loop.run_forever()

thread = threading.Thread(target=run_loop, daemon=True)
thread.start()
```

**ç»“è®º**

- `asyncio.get_running_loop()` åªèƒ½åœ¨**å·²æœ‰äº‹ä»¶å¾ªç¯**çš„ `async` ä»£ç é‡Œè°ƒç”¨ã€‚
- **ä¸åŒçº¿ç¨‹çš„ `loop` äº’ä¸å¹²æ‰°**ï¼Œä¸èƒ½è·¨çº¿ç¨‹ `await` å¦ä¸€ä¸ª `loop` é‡Œçš„åç¨‹ã€‚

---

## **ğŸš€ åœ¨å¤šçº¿ç¨‹ `loop` é‡Œæ­£ç¡®åˆ›å»ºä»»åŠ¡**

ä½ çš„ä»£ç å¯èƒ½æ˜¯è¿™æ ·ï¼š

```python
self.loop = asyncio.new_event_loop()
self.loop_thread = threading.Thread(target=self.loop.run_forever, daemon=True)
self.loop_thread.start()
```

è¿™æ ·çš„è¯ï¼š

- **ä¸»çº¿ç¨‹æ²¡æœ‰ `asyncio` äº‹ä»¶å¾ªç¯**ï¼ˆ`asyncio.get_running_loop()` ä¼šæŠ¥é”™ï¼‰
- **ä»»åŠ¡å¿…é¡»æ‰‹åŠ¨æ·»åŠ åˆ° `self.loop`**
- **ä¸èƒ½åœ¨ä¸»çº¿ç¨‹ `await` å¦ä¸€ä¸ªçº¿ç¨‹çš„ `loop`**

### **âœ… æ­£ç¡®çš„æ–¹å¼**

å¦‚æœä½ çš„ `loop` åœ¨**å¦ä¸€ä¸ªçº¿ç¨‹**é‡Œï¼Œä½ ä¸èƒ½ç›´æ¥ `await`ï¼Œè€Œéœ€è¦ï¼š

```python
asyncio.run_coroutine_threadsafe(self.__commit_event.wait(), self.loop)
```

å› ä¸ºï¼š

- `asyncio.create_task()` åªåœ¨**å½“å‰çº¿ç¨‹çš„ `loop`** é‡Œåˆ›å»ºä»»åŠ¡ã€‚
- `asyncio.run_coroutine_threadsafe()` å¯ä»¥è·¨çº¿ç¨‹**å°†ä»»åŠ¡æäº¤åˆ° `self.loop`**ã€‚

---

## **ğŸ¯ æ€»ç»“**

|**æƒ…å†µ**|**å¦‚ä½•ç¡®ä¿ `loop` æ­£ç¡®ï¼Ÿ**|**ç¤ºä¾‹ä»£ç **|
|---|---|---|
|**ä»£ç è¿è¡Œåœ¨ `asyncio.run()` å†…**|**ç›´æ¥ `await` å’Œ `create_task()`**|`asyncio.create_task(my_task())`|
|**`self.loop` è¿è¡Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹**|**ä½¿ç”¨ `asyncio.run_coroutine_threadsafe()`**|`asyncio.run_coroutine_threadsafe(my_task(), self.loop)`|
|**åœ¨ä¸»çº¿ç¨‹æƒ³è·å– `loop`**|**ä½¿ç”¨ `asyncio.get_running_loop()`ï¼Œä½†å¿…é¡»åœ¨ `async` ä»£ç å†…**|`loop = asyncio.get_running_loop()`|

---

## **ğŸ¯ ä½ çš„æœ€ä½³åšæ³•**

åœ¨ä½ çš„ `self.loop` è¿è¡Œäº**åå°çº¿ç¨‹**çš„æƒ…å†µä¸‹ï¼Œä½ åº”è¯¥è¿™æ ·åˆ›å»ºä»»åŠ¡ï¼š

```python
commit_task = asyncio.run_coroutine_threadsafe(self.__commit_event.wait(), self.loop)
rollback_task = asyncio.run_coroutine_threadsafe(self.__rollback_event.wait(), self.loop)

done, pending = await asyncio.wait(
    [asyncio.wrap_future(commit_task), asyncio.wrap_future(rollback_task)],
    timeout=timeout,
    return_when=asyncio.FIRST_COMPLETED
)
```

è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š âœ… `commit_task` å’Œ `rollback_task` è¿è¡Œåœ¨ `self.loop`  
âœ… `asyncio.wait()` è¿˜èƒ½ `await` è¿™äº›ä»»åŠ¡  
âœ… è§£å†³ `asyncio.run_coroutine_threadsafe()` è¿”å› `Future` çš„é—®é¢˜

---

å¸Œæœ›è¿™èƒ½å¸®åˆ°ä½ ï¼å¦‚æœæœ‰æ›´å…·ä½“çš„æƒ…å†µå¯ä»¥ç»§ç»­è®¨è®º ğŸš€




æ˜¯çš„ï¼Œä½ å¯ä»¥ä¸º `await self.__wait_for_prepare()` è®¾ç½®è¶…æ—¶ã€‚Python çš„ `asyncio` æä¾›äº†å¤šç§æ–¹å¼æ¥å®ç°è¶…æ—¶æ§åˆ¶ã€‚ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„æ–¹æ³•ï¼š

---

### æ–¹æ³• 1ï¼šä½¿ç”¨ `asyncio.wait_for`
`asyncio.wait_for` æ˜¯ä¸“é—¨ç”¨äºä¸ºå¼‚æ­¥æ“ä½œè®¾ç½®è¶…æ—¶çš„å‡½æ•°ã€‚å¦‚æœæ“ä½œåœ¨æŒ‡å®šæ—¶é—´å†…æœªå®Œæˆï¼Œä¼šæŠ›å‡º `asyncio.TimeoutError`ã€‚

#### ç¤ºä¾‹ä»£ç ï¼š
```python
import asyncio  
  
async def fetch_data(delay):  
    await asyncio.sleep(delay)  
    return f"result after {delay}s"  
  
async def main():  
    res = await asyncio.wait_for(fetch_data(3), timeout=5)  
    print(res)  
    res2 = await asyncio.wait_for(fetch_data(3), timeout=1)  
    print(res2)  
  
if __name__ == "__main__":  
    asyncio.run(main())
```

ç¬¬ä¸€ä¸ªæ­£å¸¸å®Œæˆ, è€Œç¬¬äºŒä¸ªä¼šæŠ›å‡º TimeoutError 


### æ–¹æ³• 2ï¼šä½¿ç”¨ `asyncio.wait` å’Œ `asyncio.TIMEOUT`
`asyncio.wait` å¯ä»¥åŒæ—¶ç­‰å¾…å¤šä¸ªä»»åŠ¡ï¼Œå¹¶é€šè¿‡ `return_when=asyncio.FIRST_COMPLETED` æ¥æ§åˆ¶è¿”å›æ¡ä»¶ã€‚ç»“åˆ `asyncio.TIMEOUT`ï¼Œå¯ä»¥å®ç°è¶…æ—¶é€»è¾‘ã€‚

#### ç¤ºä¾‹ä»£ç ï¼š
```python
import asyncio

async def my_task():
    try:
        # è®¾ç½®è¶…æ—¶ä¸º 5 ç§’
        done, pending = await asyncio.wait(
            [self.__wait_for_prepare()],
            timeout=5.0,
            return_when=asyncio.FIRST_COMPLETED
        )
        if done:
            prepare_res = done.pop().result()
            if prepare_res:  # å¦‚æœ prepare å›è°ƒæˆåŠŸï¼Œå‘é€
                print("Prepare succeeded, sending...")
            else:
                print("Prepare failed.")
        else:
            print("Prepare timed out.")
    except Exception as e:
        print(f"An error occurred: {e}")

# è°ƒç”¨ç¤ºä¾‹
asyncio.run(my_task())
```

---

### æ–¹æ³• 3ï¼šä½¿ç”¨ `asyncio.timeout`ï¼ˆPython 3.11+ï¼‰
Python 3.11 å¼•å…¥äº† `asyncio.timeout`ï¼Œå®ƒæ˜¯ä¸€ç§æ›´ç®€æ´çš„æ–¹å¼æ¥è®¾ç½®è¶…æ—¶ã€‚

#### ç¤ºä¾‹ä»£ç ï¼š
```python
import asyncio

async def my_task():
    try:
        async with asyncio.timeout(5.0):  # è®¾ç½®è¶…æ—¶ä¸º 5 ç§’
            prepare_res = await self.__wait_for_prepare()
            if prepare_res:  # å¦‚æœ prepare å›è°ƒæˆåŠŸï¼Œå‘é€
                print("Prepare succeeded, sending...")
            else:
                print("Prepare failed.")
    except TimeoutError:
        print("Prepare timed out.")

# è°ƒç”¨ç¤ºä¾‹
asyncio.run(my_task())
```

---

### æ–¹æ³• 4ï¼šæ‰‹åŠ¨å®ç°è¶…æ—¶
å¦‚æœä½ éœ€è¦æ›´çµæ´»çš„æ§åˆ¶ï¼Œå¯ä»¥æ‰‹åŠ¨å®ç°è¶…æ—¶é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ `asyncio.create_task` å’Œ `asyncio.wait`ã€‚

#### ç¤ºä¾‹ä»£ç ï¼š
```python
import asyncio

async def my_task():
    task = asyncio.create_task(self.__wait_for_prepare())
    try:
        # è®¾ç½®è¶…æ—¶ä¸º 5 ç§’
        prepare_res = await asyncio.wait_for(task, timeout=5.0)
        if prepare_res:  # å¦‚æœ prepare å›è°ƒæˆåŠŸï¼Œå‘é€
            print("Prepare succeeded, sending...")
        else:
            print("Prepare failed.")
    except asyncio.TimeoutError:
        print("Prepare timed out.")
        task.cancel()  # å–æ¶ˆä»»åŠ¡
        try:
            await task  # ç­‰å¾…ä»»åŠ¡å–æ¶ˆå®Œæˆ
        except asyncio.CancelledError:
            print("Task cancelled.")

# è°ƒç”¨ç¤ºä¾‹
asyncio.run(my_task())
```

---

### æ€»ç»“
- **æ¨èæ–¹æ³•**ï¼šä½¿ç”¨ `asyncio.wait_for` æˆ– `asyncio.timeout`ï¼ˆPython 3.11+ï¼‰ï¼Œå®ƒä»¬æ˜¯æœ€ç®€æ´å’Œç›´è§‚çš„æ–¹å¼ã€‚
- **æ‰‹åŠ¨å®ç°**ï¼šå¦‚æœéœ€è¦æ›´å¤æ‚çš„é€»è¾‘ï¼ˆå¦‚ä»»åŠ¡å–æ¶ˆï¼‰ï¼Œå¯ä»¥æ‰‹åŠ¨å®ç°è¶…æ—¶ã€‚
- **è¶…æ—¶å¤„ç†**ï¼šæ— è®ºå“ªç§æ–¹æ³•ï¼Œéƒ½éœ€è¦æ•è· `asyncio.TimeoutError` æˆ– `TimeoutError` æ¥å¤„ç†è¶…æ—¶æƒ…å†µã€‚

æ ¹æ®ä½ çš„éœ€æ±‚å’Œ Python ç‰ˆæœ¬ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹æ³•å³å¯ã€‚